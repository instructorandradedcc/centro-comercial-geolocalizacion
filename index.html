<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin AR - Centro Comercial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="container mx-auto p-6 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-8">Panel de Administración AR</h1>

        <!-- Formulario para agregar nuevos Puntos de Interés (POI) -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4">Agregar Nuevo Punto de Interés</h2>
            <form id="poi-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div>
                    <label for="poi-name" class="block text-sm font-medium text-gray-700">Nombre del POI</label>
                    <input type="text" id="poi-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ej: Santa en Trineo">
                </div>

                <div>
                    <label for="model-quick-select" class="block text-sm font-medium text-gray-700">Selección Rápida (ECOPIENSA)</label>
                    <select id="model-quick-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="">-- Opcional: Seleccionar modelo --</option>
                        <!-- Opciones se agregarán con JS -->
                    </select>
                </div>

                <div>
                    <label for="poi-model-url" class="block text-sm font-medium text-gray-700">URL del Modelo (.glb) (o rellenar arriba)</label>
                    <input type="url" id="poi-model-url" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://.../modelo.glb">
                </div>

                <div>
                    <label for="poi-lat" class="block text-sm font-medium text-gray-700">Latitud</label>
                    <input type="number" step="any" id="poi-lat" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="4.0950">
                </div>

                <div>
                    <label for="poi-lon" class="block text-sm font-medium text-gray-700">Longitud</label>
                    <input type="number" step="any" id="poi-lon" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="-76.1950">
                </div>

                <div>
                    <label for="poi-scale" class="block text-sm font-medium text-gray-700">Escala (Número)</label>
                    <input type="number" step="0.1" id="poi-scale" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="1.0">
                </div>

                <div>
                    <label for="poi-sound-url" class="block text-sm font-medium text-gray-700">URL de Sonido (Opcional, .mp3)</label>
                    <input type="url" id="poi-sound-url" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://.../jinglebells.mp3">
                </div>

                <div>
                    <label for="poi-start-date" class="block text-sm font-medium text-gray-700">Fecha de Inicio (Activación)</label>
                    <input type="date" id="poi-start-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>

                <div>
                    <label for="poi-end-date" class="block text-sm font-medium text-gray-700">Fecha de Fin (Desactivación)</label>
                    <input type="date" id="poi-end-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>

                <div class="md:col-span-2 text-center">
                    <button type="submit" id="submit-btn" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300">
                        Guardar Punto de Interés
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de POIs existentes -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Puntos de Interés Activos</h2>
            <div id="poi-list-container" class="space-y-4">
                <p id="loading-pois" class="text-gray-500">Cargando puntos...</p>
                <!-- Los POIs se insertarán aquí dinámicamente -->
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            deleteDoc, 
            onSnapshot, 
            query,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Modelos de ECOPIENSA ---
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/';
        const ECOPIENSA_MODELS = [
            { name: 'Botellita Azul', url: `${GITHUB_BASE_URL}botellytaazul.glb` },
            { name: 'Ecoladrillo', url: `${GITHUB_BASE_URL}ecoladrillo.glb` },
            { name: 'Lata Plateada', url: `${GITHUB_BASE_URL}lataplateada.glb` },
            { name: 'Papelito Verde', url: `${GITHUB_BASE_URL}papelitoverde.glb` },
            { name: 'Señor Contenedor', url: `${GITHUB_BASE_URL}senorcontenedor.glb` },
            { name: 'Tapa Roja', url: `${GITHUB_BASE_URL}taparoja.glb` }
        ];

        // --- Configuración de Firebase ---
        // Estas variables __app_id, __firebase_config, y __initial_auth_token
        // son proporcionadas automáticamente por el entorno de Canvas.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, poiCollectionRef;

        // Elementos del DOM
        const form = document.getElementById('poi-form');
        const submitBtn = document.getElementById('submit-btn');
        const listContainer = document.getElementById('poi-list-container');
        const loadingPois = document.getElementById('loading-pois');
        const quickSelect = document.getElementById('model-quick-select');

        // Función principal de inicialización
        async function initializeAdmin() {
            try {
                // Habilitar logs detallados de Firestore
                setLogLevel('Debug');

                // 1. Inicializar Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Autenticar al usuario
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('Usuario autenticado:', userId);
                        // 3. Definir la ruta de la colección (pública)
                        // Todos los usuarios (admin y viewers) usarán esta ruta.
                        const collectionPath = `/artifacts/${appId}/public/data/pois`;
                        poiCollectionRef = collection(db, collectionPath);
                        console.log('Escuchando en la colección:', collectionPath);

                        // 4. Poblar el selector rápido de modelos
                        populateQuickSelect();

                        // 5. Cargar y escuchar los POIs existentes
                        loadAndListenPois();
                    }
                });

                // Iniciar sesión (anónimamente si no hay token)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loadingPois.textContent = "Error al conectar con la base de datos.";
            }
        }

        // Poblar el menú de selección rápida
        function populateQuickSelect() {
            if (!quickSelect) return;
            ECOPIENSA_MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model.url;
                option.textContent = model.name;
                quickSelect.appendChild(option);
            });

            quickSelect.addEventListener('change', (e) => {
                const selectedUrl = e.target.value;
                if (selectedUrl) {
                    const selectedName = e.target.options[e.target.selectedIndex].text;
                    document.getElementById('poi-model-url').value = selectedUrl;
                    document.getElementById('poi-name').value = selectedName;
                }
            });
        }

        // Cargar POIs y escuchar cambios en tiempo real
        function loadAndListenPois() {
            const q = query(poiCollectionRef);
            
            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">No hay puntos de interés guardados. ¡Agrega uno!</p>';
                    return;
                }

                listContainer.innerHTML = ''; // Limpiar la lista
                querySnapshot.forEach((doc) => {
                    const poi = doc.data();
                    const poiId = doc.id;

                    const poiElement = document.createElement('div');
                    poiElement.className = 'p-4 border border-gray-200 rounded-lg shadow-sm grid grid-cols-2 md:grid-cols-4 gap-4 items-center';
                    poiElement.innerHTML = `
                        <div>
                            <strong class="block text-sm text-gray-800">${poi.name}</strong>
                            <span class="text-xs text-gray-500">ID: ${poiId.substring(0, 6)}...</span>
                        </div>
                        <div class="text-sm">
                            <span class="block">Lat: ${poi.lat}</span>
                            <span class="block">Lon: ${poi.lon}</span>
                        </div>
                        <div class="text-sm">
                            <span class="block">Inicia: ${poi.startDate}</span>
                            <span class="block">Termina: ${poi.endDate}</span>
                        </div>
                        <div class="text-right">
                            <button data-id="${poiId}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300">
                                Eliminar
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(poiElement);
                });

            }, (error) => {
                console.error("Error al escuchar POIs:", error);
                listContainer.innerHTML = '<p class="text-red-500">Error al cargar los puntos de interés.</p>';
            });
        }

        // Manejar el envío del formulario para agregar un POI
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!poiCollectionRef) {
                alert("La base de datos no está lista. Intenta de nuevo.");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';

            try {
                const newPoi = {
                    name: document.getElementById('poi-name').value,
                    modelUrl: document.getElementById('poi-model-url').value,
                    soundUrl: document.getElementById('poi-sound-url').value || "",
                    lat: parseFloat(document.getElementById('poi-lat').value),
                    lon: parseFloat(document.getElementById('poi-lon').value),
                    scale: parseFloat(document.getElementById('poi-scale').value),
                    startDate: document.getElementById('poi-start-date').value,
                    endDate: document.getElementById('poi-end-date').value
                };

                // Validar datos
                if (isNaN(newPoi.lat) || isNaN(newPoi.lon) || isNaN(newPoi.scale)) {
                    throw new Error("Latitud, Longitud y Escala deben ser números válidos.");
                }
                if (!newPoi.startDate || !newPoi.endDate) {
                    throw new Error("Las fechas de inicio y fin son obligatorias.");
                }

                // Agregar el documento a Firestore
                const docRef = await addDoc(poiCollectionRef, newPoi);
                console.log("Documento agregado con ID: ", docRef.id);
                
                form.reset(); // Limpiar el formulario

            } catch (error) {
                console.error("Error al agregar documento: ", error);
                alert("Error al guardar: " + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Punto de Interés';
            }
        });

        // Manejar clics en los botones de eliminar (delegación de eventos)
        listContainer.addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('delete-btn')) {
                const docId = e.target.getAttribute('data-id');
                
                // Usar un modal personalizado en lugar de confirm()
                if (window.confirm("¿Estás seguro de que quieres eliminar este punto de interés?")) {
                    try {
                        e.target.disabled = true;
                        e.target.textContent = 'Eliminando...';
                        const docRef = doc(db, poiCollectionRef.path, docId);
                        await deleteDoc(docRef);
                        console.log("Documento eliminado:", docId);
                    } catch (error) {
                        console.error("Error al eliminar documento: ", error);
                        alert("No se pudo eliminar el documento.");
                        e.target.disabled = false;
                        e.target.textContent = 'Eliminar';
                    }
                }
            }
        });

        // Iniciar la aplicación
        initializeAdmin();

    </script>
</body>
</html>


