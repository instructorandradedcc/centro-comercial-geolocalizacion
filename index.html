<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panel de Administración AR (Geolocalización)</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- Three.js para cálculos de pose -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page {
            display: none; height: 100%; width: 100%;
            position: relative; overflow-y: auto;
            padding-bottom: 60px;
        }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; }

        .page#login-page {
            display: none; align-items: center;
            justify-content: center; background-color: #f3f4f6;
        }
        .page#login-page.active { display: flex; }

        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover:not(:disabled) { background-color: #45a049; }
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.7; }

        .delete-btn-map { 
            background-color: #f44336; color: white;
            font-size: 0.75rem; padding: 0.25rem 0.5rem;
            border-radius: 0.25rem; margin-left: 0.25rem; transition: background-color 0.3s;
        }
        .delete-btn-map:hover:not(:disabled) { background-color: #d32f2f; }
        .delete-btn-map.confirm { background-color: #ff9800; }
        .delete-btn-map.confirm:hover:not(:disabled) { background-color: #f57c00; }

        .secondary-action-btn {
            background-color: #607d8b; color: white;
            padding: 8px 16px; border: none;
            border-radius: 6px; font-size: 14px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 8px;
        }
        .secondary-action-btn:hover:not(:disabled) { background-color: #546e7a; }

        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem;
            z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out;
            pointer-events: none; max-width: 90%; text-align: center;
        }
        #message-box.show { opacity: 1; }

        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-controls { position: fixed; top: 20px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px; }

        #map-crosshair {
            position: absolute !important;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 30px !important; height: 30px !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            box-shadow: 0 0 10px black, 0 0 0 2px rgba(0, 0, 0, 0.5) !important;
            pointer-events: none !important; z-index: 1000 !important;
        }

        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center;
        }
        #map-center-coords {
            position: fixed; top: 75px; left: 20px;
            z-index: 402; background-color: rgba(0, 0, 0, 0.75);
            color: white; padding: 8px 12px;
            border-radius: 8px; font-size: 0.8rem;
            font-family: monospace; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #map-center-coords span { display: block; }

        .map-panel {
            position: fixed; top: 80px; left: 10px;
            z-index: 401; background-color: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px; width: 90%;
            max-height: calc(100vh - 180px); overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        #edit-location-panel { border: 2px solid #f59e0b; }
        #placed-pois-panel {
            left: auto; right: 10px; max-width: 250px;
            transition: transform 0.3s ease-out;
        }
        #placed-pois-panel.minimized {
            transform: translateX(calc(100% - 40px));
            overflow-y: hidden; box-shadow: none; padding: 5px;
        }
        #placed-pois-panel.minimized h3,
        #placed-pois-panel.minimized .text-xs,
        #placed-pois-panel.minimized #placed-pois-list { display: none; }
        #toggle-pois-btn { background-color: #607d8b; }

        #placement-preview-image {
            max-width: 100px; max-height: 100px;
            margin: 10px auto; border: 1px solid #ccc;
            border-radius: 4px; display: none; object-fit: contain;
        }
        .leaflet-popup-content img.popup-image {
            max-width: 100px; max-height: 100px;
            display: block; margin: 5px auto;
            border-radius: 4px;
        }

        a-scene { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; }
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }

        #ar-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; align-items: center; }
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }

        .ar-loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10002;
        }
        .ar-loading-screen.active { display: flex; }
        #progress-bar-container {
            width: 80%; max-width: 400px; background: rgba(255, 255, 255, 0.2);
            border-radius: 5px; margin-top: 20px; height: 10px; overflow: hidden;
        }
        #progress-bar {
            width: 0%; height: 100%; background: #4CAF50;
            border-radius: 5px; transition: width 0.3s ease;
        }
        #loading-asset-status {
            margin-top: 10px; font-size: 0.9rem;
            color: #ccc; min-height: 20px; text-align: center;
        }

        #ar-guide {
            position: fixed; top: 100px; left: 50%;
            transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7);
            color: white; padding: 10px 15px; border-radius: 8px;
            font-size: 1.1rem; font-weight: bold; z-index: 9999;
            text-align: center; display: none; border: 2px solid #FFC107;
        }

        #ar-scale-controls {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); z-index: 9999;
            width: 80%; max-width: 400px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px; border-radius: 8px;
            color: white; display: flex; flex-direction: column; gap: 5px;
        }
        .scale-label-ar { font-size: 0.8rem; font-weight: normal; }
        .scale-value-ar { font-weight: bold; color: #4CAF50; }

        a-video { border: 2px solid white; background-color: black; }

        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; object-fit: cover !important;
            z-index: -1 !important; display: block !important; opacity: 1 !important;
            visibility: visible !important; autoplay: true !important;
            playsinline: true !important; webkit-playsinline: true !important;
            muted: true !important;
        }
        canvas, .a-canvas {
            background: transparent !important; background-color: rgba(0, 0, 0, 0) !important;
            z-index: 1 !important; position: fixed !important; top: 0 !important;
            left: 0 !important; width: 100% !important; height: 100% !important;
        }

        #ar-rotation-controls {
            position: fixed; bottom: 100px; left: 50%;
            transform: translateX(-50%); z-index: 9999;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px; border-radius: 8px; display: none;
            flex-direction: column; gap: 5px;
        }
        #ar-rotation-controls.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- PAGE 0: Login -->
    <div id="login-page" class="page active flex items-center justify-center bg-gray-200">
        <div class="bg-white p-10 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Admin AR</h1>
            <p class="text-gray-600 mb-8">Por favor, inicia sesión para continuar.</p>
            <button id="google-login-btn" class="control-button bg-blue-500 hover:bg-blue-600 w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.35 12.24c0-.79-.07-1.54-.2-2.28h-9.15v4.3h5.16c-.22 1.4-.87 2.6-1.95 3.4v2.8h3.59c2.1-1.9 3.3-4.5 3.3-7.22z"/><path d="M12 21.8c2.6 0 4.7-.87 6.2-2.3l-3.6-2.8c-.87.6-1.9.9-3.1.9-2.4 0-4.5-1.6-5.2-3.8H3.1v2.9c1.5 3 4.5 5 8.2 5z"/><path d="M6.8 14.3c-.2-.6-.3-1.2-.3-1.8s.1-1.2.3-1.8V7.8H3.1c-.6 1.2-1 2.5-1 4s.4 2.8 1 4l3.7-2.9z"/><path d="M12 6.3c1.4 0 2.6.5 3.6 1.4l3.2-3.2C17.2 2.8 14.8 2 12 2c-3.7 0-6.7 2-8.2 5l3.7 2.9c.7-2.2 2.8-3.8 5.2-3.8z"/></svg>
                <span>Iniciar Sesión con Google</span>
            </button>
        </div>
    </div>

    <!-- PAGE 1: Admin Panel (Model Selection) -->
    <div id="admin-page" class="page">
        <div class="container mx-auto p-6 max-w-4xl">
            <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-blue-700">Panel de Administración AR</h1>
                    <div class="text-sm text-gray-500 mt-1">
                        <span id="version-display" class="font-normal align-middle"></span>
                        <span id="user-info" class="hidden ml-4">
                            Logueado como: <strong id="user-email"></strong>
                        </span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="logout-btn" class="control-button bg-red-500 hover:bg-red-600 hidden">Salir</button>
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600" disabled>Ir al Mapa</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">1. Seleccionar Contenido para Colocar</h2>
                <p class="text-gray-600 mb-4">Marca los modelos o define el video que quieres posicionar en el mapa.</p>
                <div id="ecopiensa-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <p id="loading-models-placeholder" class="text-gray-500 col-span-full">Cargando modelos...</p>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" id="select-video-cb" class="h-5 w-5 text-blue-600">
                        <span>Añadir un Video Personalizado</span>
                    </label>
                </div>
                <h2 class="text-2xl font-semibold mt-6 mb-4">2. Ir al Mapa para Posicionar</h2>
                <p class="text-gray-600">El contenido que selecciones aquí estará disponible en el panel del mapa.</p>
                <button id="clear-selection-btn" class="mt-4 text-sm text-red-600 hover:text-red-800 underline">Limpiar selección guardada</button>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Contenido Geoposicionado Guardado</h2>
                <div id="poi-list-container" class="space-y-4">
                    <p id="loading-pois" class="text-gray-500 font-semibold">Inicializando Firebase...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 2: Map View (Placement and Editing) -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
        </div>

        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        <div id="map-center-coords">
            <span>Lat: --</span>
            <span>Lon: --</span>
        </div>

        <div id="placement-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Colocar Nuevo Contenido</h3>
            <div id="models-to-place-list"></div>
            <div id="placement-form-container" class="hidden mt-4">
                <input type="text" id="placing-model-name" class="w-full p-2 border rounded mb-2" placeholder="Nombre del lugar">
                <input type="number" id="place-scale" class="w-full p-2 border rounded mb-2" placeholder="Escala (1.0 por defecto)" value="1.0" step="0.1">
                <input type="number" id="place-ground-height" class="w-full p-2 border rounded mb-2" placeholder="Altura del suelo (m)" value="0" step="0.1">
                <input type="date" id="place-start-date" class="w-full p-2 border rounded mb-2">
                <input type="date" id="place-end-date" class="w-full p-2 border rounded mb-2">
                <input type="text" id="place-sound-url" class="w-full p-2 border rounded mb-2" placeholder="URL del sonido (opcional)">
                <button id="cancel-placement-btn" class="secondary-action-btn">Cancelar</button>
                <button id="save-placement-btn" class="control-button mt-2" disabled>Guardar</button>
            </div>
            <button id="back-to-selection-btn" class="secondary-action-btn hidden mt-2">Volver a Selección</button>
        </div>

        <div id="placed-pois-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Puntos de Interés Colocados</h3>
            <div id="placed-pois-list"></div>
        </div>

        <div id="edit-location-panel" class="map-panel hidden">
            <h3 id="editing-poi-name" class="text-lg font-semibold mb-2"></h3>
            <input type="number" id="edit-lat" class="w-full p-2 border rounded mb-2" placeholder="Latitud">
            <input type="number" id="edit-lon" class="w-full p-2 border rounded mb-2" placeholder="Longitud">
            <input type="number" id="edit-height" class="w-full p-2 border rounded mb-2" placeholder="Altura (m)">
            <button id="cancel-edit-location-btn" class="secondary-action-btn">Cancelar</button>
            <button id="save-edit-location-btn" class="control-button mt-2" disabled>Guardar Cambios</button>
        </div>
    </div>

    <!-- PAGE 3: Summary View -->
    <div id="summary-page" class="page">
        <div class="container mx-auto p-6 max-w-4xl">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Resumen de Puntos de Interés</h1>
            <div id="summary-poi-list" class="space-y-4">
                <p id="loading-summary-pois" class="text-gray-500 font-semibold">Cargando...</p>
            </div>
            <button id="back-to-map-btn" class="secondary-action-btn mt-4">Volver al Mapa</button>
            <button id="ar-placement-btn" class="control-button bg-blue-500 hover:bg-blue-600 mt-4">Colocar en AR (Beta)</button>
        </div>
    </div>

    <!-- PAGE 4: Augmented Reality View -->
    <div id="ar-page" class="page">
        <div id="ar-scene-container"></div>
        <div id="ar-loading-screen" class="ar-loading-screen">
            <div class="loader"></div>
            <div id="loading-status-text">Cargando escena AR...</div>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
            <div id="loading-asset-status"></div>
        </div>
        <div id="ar-guide">
            <span id="guide-name"></span> - <span id="guide-distance"></span>
            <span id="guide-bearing"></span>
        </div>
        <div id="ar-scale-controls">
            <label class="scale-label-ar">Escala Visual: <span id="ar-scale-value-display" class="scale-value-ar">1.00x</span></label>
            <input id="ar-scale-slider" type="range" min="0.1" max="3.0" step="0.1" value="1.0">
            <button id="save-ar-scale-btn" class="control-button mt-2" disabled>Guardar Escala</button>
        </div>
        <div id="ar-rotation-controls">
            <label>Rotación Y (Yaw): <input id="ar-rot-y" type="range" min="0" max="360" value="0" step="1"></label>
        </div>
        <div id="ar-controls">
            <button id="back-to-summary-btn" class="secondary-action-btn">Volver</button>
        </div>
        <div class="ar-info-panel">
            GPS: <span id="gps-status">Buscando...</span> | Precisión: <span id="gps-accuracy">--</span>m
        </div>
    </div>

    <!-- Message Box and Permission Modal -->
    <div id="message-box"></div>
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <p>Se requieren permisos de cámara y GPS para AR. Por favor, habilítelos.</p>
            <button id="grant-permissions-btn" class="permission-button">Aceptar</button>
        </div>
    </div>

    <!-- Firebase SDK Module -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';

        // Firebase Configuration (Replace with your config)
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-auth-domain",
            projectId: "your-project-id",
            storageBucket: "your-storage-bucket",
            messagingSenderId: "your-messaging-sender-id",
            appId: "your-app-id"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let poiCollectionRef = null;
        let firebaseReady = false;
        const APP_VERSION = '1.45';

        // Global Variables
        let pages, messageBox, permissionModal, arLoadingScreen, loadingStatusText, progressBar, progressBarContainer, loadingAssetStatus, versionDisplay, arGuide, guideName, guideDistance, guideBearing, arScaleSlider, arScaleValueDisplay, saveArScaleBtn, listContainer, loadingPois, ecopiensaSelectionList, loadingModelsPlaceholder, selectVideoCheckbox, gotoMapButton, googleLoginBtn, logoutBtn, userInfo, userEmail, togglePoisBtn, placementPanel, modelsToPlaceList, placementFormContainer, placingModelName, cancelPlacementBtn, savePlacementBtn, backToSelectionBtn, clearSelectionBtn, mapZoomSlider, jumptoBtn, placePoiTypeSelect, modelFieldsDiv, videoFieldsDiv, placeModelUrlInput, placeVideoUrlInput, placeNameInput, placeScaleInput, placeHeightInput, placeStartDateInput, placeEndDateInput, placeSoundUrlInput, placedPoisPanel, placedPoisList, editLocationPanel, editingPoiNameEl, saveEditLocationBtn, cancelEditLocationBtn, summaryPoiList, loadingSummaryPois, mapCenterCoordsEl, placementPreviewImageEl, arScene = null, lastKnownGps = { latitude: null, longitude: null, accuracy: 9999, heading: 0 }, allPoisData = [], closestPoiIdForScaling = null, isArPlacementMode = false;

        // Utility Functions
        function showMessage(message, duration = 3000) {
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => messageBox.classList.remove('show'), duration);
            }
        }

        function navigateTo(pageId) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            pages[pageId].classList.add('active');
            if (pageId === 'ar' && !arScene) startARFlow();
            else if (pageId !== 'ar' && arScene) stopAR();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radius of Earth in meters
            const φ1 = lat1 * Math.PI / 180; const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in meters
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180; const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) -
                      Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            const θ = Math.atan2(y, x);
            return (θ * 180 / Math.PI + 360) % 360; // Bearing in degrees
        }

        function getDirectionArrow(bearingDiff) {
            const absDiff = Math.abs(bearingDiff % 360);
            if (absDiff < 45 || absDiff > 315) return "→";
            if (absDiff >= 45 && absDiff < 135) return "↓";
            if (absDiff >= 135 && absDiff < 225) return "←";
            return "↑";
        }

        // Authentication Functions
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                userInfo.classList.remove('hidden');
                userEmail.textContent = result.user.email;
                logoutBtn.classList.remove('hidden');
                googleLoginBtn.classList.add('hidden');
                navigateTo('admin');
                initializeFirebase();
            } catch (error) {
                showMessage("Error al iniciar sesión: " + error.message, 4000);
            }
        }

        function handleLogout() {
            signOut(auth).then(() => {
                userInfo.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                googleLoginBtn.classList.remove('hidden');
                navigateTo('login');
                allPoisData = [];
                if (listContainer) listContainer.innerHTML = '<p id="loading-pois" class="text-gray-500 font-semibold">Inicializando Firebase...</p>';
                if (placedPoisList) placedPoisList.innerHTML = '';
                if (summaryPoiList) summaryPoiList.innerHTML = '<p id="loading-summary-pois" class="text-gray-500 font-semibold">Cargando...</p>';
            }).catch((error) => showMessage("Error al cerrar sesión: " + error.message, 4000));
        }

        // Firebase Initialization
        function initializeFirebase() {
            if (!auth.currentUser) return;
            poiCollectionRef = collection(db, `users/${auth.currentUser.uid}/pois`);
            firebaseReady = true;
            loadPoisFromFirebase();
        }

        function loadPoisFromFirebase() {
            if (!poiCollectionRef) return;
            const q = query(poiCollectionRef);
            onSnapshot(q, (snapshot) => {
                allPoisData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updatePoiLists();
            }, (error) => {
                console.error("Error fetching POIs: ", error);
                showMessage("Error al cargar puntos de interés: " + error.message, 4000);
            });
        }

        function updatePoiLists() {
            if (listContainer) {
                listContainer.innerHTML = allPoisData.map(poi => `
                    <div class="p-2 bg-gray-50 rounded flex justify-between items-center">
                        <span>${poi.name || 'Sin nombre'}</span>
                        <button class="delete-btn" data-id="${poi.id}">Eliminar</button>
                    </div>
                `).join('');
                loadingPois.style.display = 'none';
            }
            if (placedPoisList) {
                placedPoisList.innerHTML = allPoisData.map(poi => `
                    <div class="p-2 bg-gray-50 rounded flex justify-between items-center">
                        <span>${poi.name || 'Sin nombre'}</span>
                        <button class="delete-btn-map" data-id="${poi.id}">Eliminar</button>
                    </div>
                `).join('');
            }
            if (summaryPoiList) {
                summaryPoiList.innerHTML = allPoisData.map(poi => `
                    <div class="p-2 bg-gray-50 rounded">
                        <strong>${poi.name || 'Sin nombre'}</strong><br>
                        Lat: ${poi.lat}, Lon: ${poi.lon}, Altura: ${poi.height || 0}m
                    </div>
                `).join('');
                loadingSummaryPois.style.display = 'none';
            }
        }

        // Map Functions
        function initializeMap() {
            const map = L.map('map-canvas').setView([4.7110, -74.0721], 13); // Bogotá default
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            map.on('move', () => {
                const center = map.getCenter();
                mapCenterCoordsEl.innerHTML = `<span>Lat: ${center.lat.toFixed(6)}</span><span>Lon: ${center.lng.toFixed(6)}</span>`;
            });

            jumptoBtn.addEventListener('click', () => {
                const lat = parseFloat(document.getElementById('jumpto-lat').value);
                const lon = parseFloat(document.getElementById('jumpto-lon').value);
                if (lat && lon) map.setView([lat, lon], 15);
            });

            allPoisData.forEach(poi => {
                if (poi.lat && poi.lon) {
                    L.marker([poi.lat, poi.lon]).addTo(map)
                        .bindPopup(`<b>${poi.name || 'Sin nombre'}</b><br>Altura: ${poi.height || 0}m<br><img class="popup-image" src="${poi.modelUrl || poi.videoUrl || ''}">`)
                        .on('contextmenu', () => editLocation(poi.id));
                }
            });
        }

        // Placement Functions
        function loadSelectionFromLocalStorage() {
            const savedSelection = localStorage.getItem('selectedModels');
            if (savedSelection) {
                modelsToPlaceList.innerHTML = JSON.parse(savedSelection).map(model => `
                    <div class="p-2 border rounded flex justify-between items-center">
                        <span>${model.name}</span>
                        <button class="delete-btn-map" data-id="${model.id}">Eliminar</button>
                    </div>
                `).join('');
                gotoMapButton.disabled = false;
            }
        }

        function initializeModelSelection() {
            // Simulating model loading (replace with real API call)
            setTimeout(() => {
                const models = [{ id: '1', name: 'Modelo 1' }, { id: '2', name: 'Modelo 2' }];
                ecopiensaSelectionList.innerHTML = models.map(model => `
                    <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" class="model-cb" data-id="${model.id}" ${localStorage.getItem('selectedModels')?.includes(model.id) ? 'checked' : ''}>
                        <span>${model.name}</span>
                    </label>
                `).join('');
                loadingModelsPlaceholder.style.display = 'none';
                document.querySelectorAll('.model-cb').forEach(cb => cb.addEventListener('change', () => {
                    const selected = Array.from(document.querySelectorAll('.model-cb:checked')).map(cb => ({ id: cb.dataset.id, name: cb.parentElement.querySelector('span').textContent }));
                    if (selected.length) {
                        modelsToPlaceList.innerHTML = selected.map(model => `
                            <div class="p-2 border rounded flex justify-between items-center">
                                <span>${model.name}</span>
                                <button class="delete-btn-map" data-id="${model.id}">Eliminar</button>
                            </div>
                        `).join('');
                        localStorage.setItem('selectedModels', JSON.stringify(selected));
                        gotoMapButton.disabled = false;
                    } else {
                        modelsToPlaceList.innerHTML = '';
                        localStorage.removeItem('selectedModels');
                        gotoMapButton.disabled = true;
                    }
                }));
            }, 1000);
        }

        function clearSavedSelection() {
            localStorage.removeItem('selectedModels');
            modelsToPlaceList.innerHTML = '';
            gotoMapButton.disabled = true;
            document.querySelectorAll('.model-cb').forEach(cb => cb.checked = false);
            showMessage('Selección limpiada.', 3000);
        }

        function editLocation(poiId) {
            const poi = allPoisData.find(p => p.id === poiId);
            if (poi) {
                editLocationPanel.classList.remove('hidden');
                placementPanel.classList.add('hidden');
                editingPoiNameEl.textContent = poi.name || 'Sin nombre';
                document.getElementById('edit-lat').value = poi.lat;
                document.getElementById('edit-lon').value = poi.lon;
                document.getElementById('edit-height').value = poi.height || 0;
                saveEditLocationBtn.disabled = false;
            }
        }

        async function handleSaveEditLocation() {
            const poiId = allPoisData.find(p => p.name === editingPoiNameEl.textContent)?.id;
            if (poiId) {
                const newLat = parseFloat(document.getElementById('edit-lat').value);
                const newLon = parseFloat(document.getElementById('edit-lon').value);
                const newHeight = parseFloat(document.getElementById('edit-height').value);
                if (newLat && newLon) {
                    saveEditLocationBtn.disabled = true;
                    saveEditLocationBtn.textContent = 'Guardando...';
                    try {
                        await setDoc(doc(db, poiCollectionRef.path, poiId), { lat: newLat, lon: newLon, height: newHeight }, { merge: true });
                        showMessage('Ubicación actualizada.', 3000);
                        editLocationPanel.classList.add('hidden');
                    } catch (error) {
                        showMessage("Error al guardar: " + error.message, 4000);
                    } finally {
                        saveEditLocationBtn.disabled = false;
                        saveEditLocationBtn.textContent = 'Guardar Cambios';
                    }
                }
            }
        }

        function cancelEditLocation() {
            editLocationPanel.classList.add('hidden');
            placementPanel.classList.remove('hidden');
        }

        function cancelPlacement() {
            placementFormContainer.classList.add('hidden');
            backToSelectionBtn.classList.add('hidden');
            placementPanel.classList.remove('hidden');
        }

        async function handleSavePlacement() {
            const name = placeNameInput.value.trim();
            const scale = parseFloat(placeScaleInput.value) || 1.0;
            const height = parseFloat(placeHeightInput.value) || 0;
            const startDate = placeStartDateInput.value;
            const endDate = placeEndDateInput.value;
            const soundUrl = placeSoundUrlInput.value.trim();
            const modelUrl = placeModelUrlInput.value.trim() || modelsToPlaceList.querySelector('div')?.textContent;
            if (name && (modelUrl || placeVideoUrlInput.value.trim())) {
                savePlacementBtn.disabled = true;
                savePlacementBtn.textContent = 'Guardando...';
                try {
                    const newPoi = {
                        name, modelUrl: modelUrl || placeVideoUrlInput.value.trim(),
                        lat: parseFloat(mapCenterCoordsEl.querySelector('span').textContent.replace('Lat: ', '')),
                        lon: parseFloat(mapCenterCoordsEl.querySelector('span:nth-child(2)').textContent.replace('Lon: ', '')),
                        height, scale, startDate, endDate, soundUrl,
                        timestamp: new Date().toISOString()
                    };
                    await setDoc(doc(poiCollectionRef), newPoi);
                    showMessage('Punto de interés guardado.', 3000);
                    cancelPlacement();
                    placeNameInput.value = ''; placeScaleInput.value = '1.0';
                    placeHeightInput.value = '0'; placeStartDateInput.value = '';
                    placeEndDateInput.value = ''; placeSoundUrlInput.value = '';
                    placeModelUrlInput.value = ''; placeVideoUrlInput.value = '';
                } catch (error) {
                    showMessage("Error al guardar: " + error.message, 4000);
                } finally {
                    savePlacementBtn.disabled = false;
                    savePlacementBtn.textContent = 'Guardar';
                }
            }
        }

        // AR Functions
        function initializeARScene() {
            const arContainer = document.getElementById('ar-scene-container');
            arContainer.innerHTML = '<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" gps-camera="simulateLatitude: 4.7110; simulateLongitude: -74.0721; simulateAltitude: 1000;">' +
                '<a-assets>' +
                '<a-asset-item id="model1" src="url-to-glb-model"></a-asset-item>' +
                '</a-assets></a-scene>';
            arScene = arContainer.querySelector('a-scene');
            arScene.addEventListener('gps-camera-update-position', onGPSUpdate);
            arScene.addEventListener('gps-camera-error', onGPSError);
            allPoisData.forEach(poi => {
                if (poi.lat && poi.lon && poi.modelUrl) {
                    const entity = document.createElement('a-entity');
                    entity.setAttribute('gps-entity-place', `latitude: ${poi.lat}; longitude: ${poi.lon};`);
                    entity.setAttribute('gltf-model', `#model1`);
                    entity.setAttribute('scale', `${poi.scale} ${poi.scale} ${poi.scale}`);
                    entity.setAttribute('position', `0 0 0`); // Adjust with height
                    if (poi.rotation) {
                        entity.setAttribute('rotation', `${poi.rotation.x} ${poi.rotation.y} ${poi.rotation.z}`);
                    }
                    arScene.appendChild(entity);
                }
            });
            arLoadingScreen.classList.remove('active');
        }

        function startARFlow() {
            if (!('xr' in navigator)) {
                showMessage("WebXR no soportado en este navegador.");
                return;
            }
            if (!arScene) {
                arLoadingScreen.classList.add('active');
                initializeARScene();
            }
            if (isArPlacementMode) enableArPlacement();
        }

        function stopAR() {
            if (arScene) {
                const arContainer = document.getElementById('ar-scene-container');
                if (arContainer) arContainer.innerHTML = '';
                arScene = null;
                console.log("AR Scene removed from DOM.");
            }
            if (arLoadingScreen) arLoadingScreen.classList.remove('active');
            const gpsStatusEl = document.getElementById('gps-status');
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsStatusEl) gpsStatusEl.textContent = "Buscando...";
            if (gpsAccuracyEl) gpsAccuracyEl.textContent = "--";
            if (arGuide) arGuide.style.display = 'none';
            if (arScaleSlider) arScaleSlider.value = 1.0;
            if (saveArScaleBtn) saveArScaleBtn.disabled = true;
            closestPoiIdForScaling = null;
            document.getElementById('ar-rotation-controls').classList.remove('active');
            console.log("AR Stopped.");
        }

        function updateARGuide() {
            let closestPoi = null;
            let minDistance = Infinity;
            const now = new Date();
            const activePois = allPoisData.filter(poi => {
                if (!poi.lat || !poi.lon) return false;
                const startDate = poi.startDate ? new Date(poi.startDate + "T00:00:00Z") : null;
                const endDate = poi.endDate ? new Date(poi.endDate + "T23:59:59Z") : null;
                let isActive = true;
                if (startDate && endDate) isActive = now >= startDate && now <= endDate;
                else if (startDate) isActive = now >= startDate;
                return isActive;
            });

            activePois.forEach(poi => {
                const distance = calculateDistance(lastKnownGps.latitude, lastKnownGps.longitude, poi.lat, poi.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPoi = poi;
                }
            });

            const MIN_GUIDE_ACCURACY = 150;
            if (closestPoi && lastKnownGps.accuracy < MIN_GUIDE_ACCURACY) {
                const targetBearing = calculateBearing(lastKnownGps.latitude, lastKnownGps.longitude, closestPoi.lat, closestPoi.lon);
                const heading = lastKnownGps.heading ?? 0;
                const bearingDiff = targetBearing - heading;
                guideName.textContent = closestPoi.name;
                guideDistance.textContent = `${minDistance.toFixed(1)}m`;
                guideBearing.textContent = getDirectionArrow(bearingDiff);
                arGuide.style.display = 'block';
                if (closestPoiIdForScaling !== closestPoi.id) {
                    closestPoiIdForScaling = closestPoi.id;
                    const savedMultiplier = closestPoi.arScaleMultiplier || 1.0;
                    if (arScaleSlider) arScaleSlider.value = savedMultiplier;
                    if (arScaleValueDisplay) arScaleValueDisplay.textContent = `${savedMultiplier.toFixed(2)}x`;
                    applyFineScaleAdjustment();
                }
                if (saveArScaleBtn) saveArScaleBtn.disabled = false;
            } else {
                arGuide.style.display = 'none';
                closestPoiIdForScaling = null;
                if (saveArScaleBtn) saveArScaleBtn.disabled = true;
            }
        }

        function onGPSUpdate(event) {
            if (!pages.ar?.classList.contains('active') || !arScene) return;
            const pos = event.detail.position.coords;
            if (!pos) return;
            lastKnownGps = {
                latitude: pos.latitude,
                longitude: pos.longitude,
                accuracy: pos.accuracy ?? 9999,
                heading: pos.heading
            };
            const gpsStatusEl = document.getElementById('gps-status');
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsStatusEl) gpsStatusEl.textContent = "OK";
            if (gpsAccuracyEl) {
                gpsAccuracyEl.textContent = `${lastKnownGps.accuracy.toFixed(2)}`;
                if (lastKnownGps.accuracy > 50) gpsAccuracyEl.style.color = 'red';
                else if (lastKnownGps.accuracy > 25) gpsAccuracyEl.style.color = 'orange';
                else gpsAccuracyEl.style.color = 'lime';
            }
            updateARGuide();
        }

        function onGPSError(event) {
            if (!pages.ar?.classList.contains('active') || !arScene) return;
            console.error("GPS Error: ", event.detail);
            const gpsStatusEl = document.getElementById('gps-status');
            if (gpsStatusEl) gpsStatusEl.textContent = "Error";
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsAccuracyEl) {
                gpsAccuracyEl.textContent = "N/A";
                gpsAccuracyEl.style.color = 'red';
            }
            let errorMsg = "Error de GPS.";
            const code = event.detail?.code;
            if (code === 1) errorMsg = "Permiso de GPS denegado.";
            else if (code === 2) errorMsg = "Señal de GPS perdida.";
            else if (code === 3) errorMsg = "GPS tardó demasiado.";
            showMessage(errorMsg, 4000);
            closestPoiIdForScaling = null;
            if (saveArScaleBtn) saveArScaleBtn.disabled = true;
        }

        function setupNavigationListeners() {
            document.getElementById('goto-map-btn')?.addEventListener('click', () => navigateTo('map'));
            document.getElementById('back-to-admin-btn')?.addEventListener('click', () => navigateTo('admin'));
            document.getElementById('goto-summary-btn')?.addEventListener('click', () => navigateTo('summary'));
            document.getElementById('back-to-map-btn')?.addEventListener('click', () => navigateTo('map'));
            document.getElementById('launch-ar-btn')?.addEventListener('click', () => navigateTo('ar'));
            document.getElementById('back-to-summary-btn')?.addEventListener('click', () => { isArPlacementMode = false; navigateTo('summary'); });
            document.getElementById('grant-permissions-btn')?.addEventListener('click', () => {
                if (permissionModal) permissionModal.style.display = 'none';
                startARFlow();
            });
            document.getElementById('ar-placement-btn')?.addEventListener('click', () => {
                isArPlacementMode = true;
                navigateTo('ar');
            });
        }

        function applyFineScaleAdjustment() {
            const scale = parseFloat(arScaleSlider.value);
            if (arScaleValueDisplay) arScaleValueDisplay.textContent = `${scale.toFixed(2)}x`;
            // Apply to current entity (implement entity selection logic)
        }

        async function handleSaveARScale() {
            if (closestPoiIdForScaling) {
                saveArScaleBtn.disabled = true;
                saveArScaleBtn.textContent = 'Guardando...';
                try {
                    await setDoc(doc(db, poiCollectionRef.path, closestPoiIdForScaling), { arScaleMultiplier: parseFloat(arScaleSlider.value) }, { merge: true });
                    showMessage('Escala guardada.', 3000);
                } catch (error) {
                    showMessage("Error al guardar escala: " + error.message, 4000);
                } finally {
                    saveArScaleBtn.disabled = false;
                    saveArScaleBtn.textContent = 'Guardar Escala';
                }
            }
        }

        function enableArPlacement() {
            navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['plane-detection', 'hit-test']
            }).then(session => {
                arScene.renderer.xr.setSession(session);
                document.getElementById('ar-rotation-controls').classList.add('active');
                const referenceSpace = arScene.renderer.xr.getReferenceSpace();

                arScene.addEventListener('click', (e) => {
                    session.requestHitTestSource({ space: 'viewer' }).then(hitTestSource => {
                        session.requestAnimationFrame((time, xrFrame) => {
                            const hitTestResults = xrFrame.getHitTestResults(hitTestSource);
                            if (hitTestResults.length > 0) {
                                const hit = hitTestResults[0];
                                const pose = hit.getPose(referenceSpace);
                                const rotY = parseFloat(document.getElementById('ar-rot-y').value);
                                const entity = document.createElement('a-entity');
                                entity.setAttribute('position', `${pose.transform.position.x} ${pose.transform.position.y} ${pose.transform.position.z}`);
                                entity.setAttribute('rotation', `0 ${rotY} 0`);
                                entity.setAttribute('gltf-model', `#model1`);
                                entity.setAttribute('scale', `${placeScaleInput.value || 1} ${placeScaleInput.value || 1} ${placeScaleInput.value || 1}`);
                                arScene.appendChild(entity);

                                // Compute absolute GPS
                                const relDist = calculateDistance(lastKnownGps.latitude, lastKnownGps.longitude, pose.transform.position.x, pose.transform.position.z);
                                const relBearing = calculateBearing(lastKnownGps.latitude, lastKnownGps.longitude, pose.transform.position.x, pose.transform.position.z);
                                const absLat = lastKnownGps.latitude + (relDist / 111111) * Math.cos(relBearing * Math.PI / 180);
                                const absLon = lastKnownGps.longitude + (relDist / (111111 * Math.cos(lastKnownGps.latitude * Math.PI / 180))) * Math.sin(relBearing * Math.PI / 180);

                                // Save to Firebase
                                const newPoi = {
                                    name: placeNameInput.value || 'Nuevo Punto',
                                    modelUrl: placeModelUrlInput.value || modelsToPlaceList.querySelector('div')?.textContent,
                                    lat: absLat, lon: absLon, height: 0, // Surface height
                                    scale: placeScaleInput.value || 1.0,
                                    rotation: { x: 0, y: rotY, z: 0 },
                                    planeType: 'horizontal',
                                    timestamp: new Date().toISOString()
                                };
                                setDoc(doc(poiCollectionRef), newPoi).then(() => {
                                    showMessage('Punto guardado en AR.', 3000);
                                    isArPlacementMode = false;
                                    navigateTo('summary');
                                }).catch(err => showMessage("Error al guardar: " + err.message, 4000));
                            }
                        });
                    });
                });
            }).catch(err => {
                showMessage("WebXR AR no soportado: " + err.message);
                isArPlacementMode = false;
                navigateTo('summary');
            });
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            pages = {
                login: document.getElementById('login-page'),
                admin: document.getElementById('admin-page'),
                map: document.getElementById('map-page'),
                summary: document.getElementById('summary-page'),
                ar: document.getElementById('ar-page')
            };
            messageBox = document.getElementById('message-box');
            permissionModal = document.getElementById('permission-modal');
            arLoadingScreen = document.getElementById('ar-loading-screen');
            loadingStatusText = document.getElementById('loading-status-text');
            progressBar = document.getElementById('progress-bar');
            progressBarContainer = document.getElementById('progress-bar-container');
            loadingAssetStatus = document.getElementById('loading-asset-status');
            versionDisplay = document.getElementById('version-display');
            arGuide = document.getElementById('ar-guide');
            guideName = document.getElementById('guide-name');
            guideDistance = document.getElementById('guide-distance');
            guideBearing = document.getElementById('guide-bearing');
            arScaleSlider = document.getElementById('ar-scale-slider');
            arScaleValueDisplay = document.getElementById('ar-scale-value-display');
            saveArScaleBtn = document.getElementById('save-ar-scale-btn');
            listContainer = document.getElementById('poi-list-container');
            loadingPois = document.getElementById('loading-pois');
            ecopiensaSelectionList = document.getElementById('ecopiensa-selection-list');
            loadingModelsPlaceholder = document.getElementById('loading-models-placeholder');
            selectVideoCheckbox = document.getElementById('select-video-cb');
            gotoMapButton = document.getElementById('goto-map-btn');
            googleLoginBtn = document.getElementById('google-login-btn');
            logoutBtn = document.getElementById('logout-btn');
            userInfo = document.getElementById('user-info');
            userEmail = document.getElementById('user-email');
            togglePoisBtn = document.getElementById('toggle-pois-btn');
            placementPanel = document.getElementById('placement-panel');
            modelsToPlaceList = document.getElementById('models-to-place-list');
            placementFormContainer = document.getElementById('placement-form-container');
            placingModelName = document.getElementById('placing-model-name');
            cancelPlacementBtn = document.getElementById('cancel-placement-btn');
            savePlacementBtn = document.getElementById('save-placement-btn');
            backToSelectionBtn = document.getElementById('back-to-selection-btn');
            clearSelectionBtn = document.getElementById('clear-selection-btn');
            mapZoomSlider = document.getElementById('map-zoom-slider');
            jumptoBtn = document.getElementById('jumpto-btn');
            placePoiTypeSelect = document.getElementById('place-poi-type');
            modelFieldsDiv = document.getElementById('model-fields');
            videoFieldsDiv = document.getElementById('video-fields');
            placeModelUrlInput = document.getElementById('place-model-url');
            placeVideoUrlInput = document.getElementById('place-video-url');
            placeNameInput = document.getElementById('place-name');
            placeScaleInput = document.getElementById('place-scale');
            placeHeightInput = document.getElementById('place-ground-height');
            placeStartDateInput = document.getElementById('place-start-date');
            placeEndDateInput = document.getElementById('place-end-date');
            placeSoundUrlInput = document.getElementById('place-sound-url');
            placedPoisPanel = document.getElementById('placed-pois-panel');
            placedPoisList = document.getElementById('placed-pois-list');
            editLocationPanel = document.getElementById('edit-location-panel');
            editingPoiNameEl = document.getElementById('editing-poi-name');
            saveEditLocationBtn = document.getElementById('save-edit-location-btn');
            cancelEditLocationBtn = document.getElementById('cancel-edit-location-btn');
            summaryPoiList = document.getElementById('summary-poi-list');
            loadingSummaryPois = document.getElementById('loading-summary-pois');
            mapCenterCoordsEl = document.getElementById('map-center-coords');
            placementPreviewImageEl = document.getElementById('placement-preview-image');

            loadSelectionFromLocalStorage();
            displayAppVersion();
            initializeModelSelection();
            setupNavigationListeners();

            if (googleLoginBtn) googleLoginBtn.addEventListener('click', handleGoogleLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (cancelPlacementBtn) cancelPlacementBtn.addEventListener('click', () => navigateTo('admin'));
            if (backToSelectionBtn) backToSelectionBtn.addEventListener('click', cancelPlacement);
            if (savePlacementBtn) savePlacementBtn.addEventListener('click', handleSavePlacement);
            if (saveEditLocationBtn) saveEditLocationBtn.addEventListener('click', handleSaveEditLocation);
            if (cancelEditLocationBtn) cancelEditLocationBtn.addEventListener('click', cancelEditLocation);
            if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSavedSelection);
            if (arScaleSlider) arScaleSlider.addEventListener('input', applyFineScaleAdjustment);
            if (saveArScaleBtn) saveArScaleBtn.addEventListener('click', handleSaveARScale);

            if (listContainer) {
                listContainer.addEventListener('click', async (e) => {
                    if (e.target?.classList.contains('delete-btn')) {
                        const docId = e.target.getAttribute('data-id');
                        const button = e.target;
                        if (!docId || button.disabled) return;
                        if (button.textContent.includes('Eliminar')) {
                            button.textContent = '¿Seguro? Clic otra vez';
                            button.classList.remove('bg-red-500', 'hover:bg-red-600');
                            button.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                            setTimeout(() => {
                                if (button.textContent.includes('Clic otra vez')) {
                                    button.textContent = 'Eliminar';
                                    button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                    button.classList.add('bg-red-500', 'hover:bg-red-600');
                                }
                            }, 3000);
                            return;
                        }
                        if (!firebaseReady || !poiCollectionRef) {
                            showMessage("Error: La base de datos no está lista.", 4000);
                            button.textContent = 'Eliminar';
                            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                            button.classList.add('bg-red-500', 'hover:bg-red-600');
                            return;
                        }
                        try {
                            button.disabled = true;
                            button.textContent = 'Eliminando...';
                            await deleteDoc(doc(db, poiCollectionRef.path, docId));
                            showMessage('Punto de interés eliminado.', 3000);
                        } catch (error) {
                            console.error("Error deleting document: ", error);
                            showMessage("No se pudo eliminar: " + error.message, 5000);
                            button.disabled = false;
                            button.textContent = 'Eliminar';
                            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                            button.classList.add('bg-red-500', 'hover:bg-red-600');
                        }
                    }
                });
            }

            if (placedPoisPanel) {
                placedPoisPanel.addEventListener('click', async (e) => {
                    if (e.target?.classList.contains('delete-btn-map')) {
                        const docId = e.target.getAttribute('data-id');
                        const button = e.target;
                        if (!docId || button.disabled) return;
                        if (button.textContent.includes('Eliminar')) {
                            button.textContent = '¿Seguro? Clic otra vez';
                            button.classList.add('confirm');
                            setTimeout(() => {
                                if (button.textContent.includes('Clic otra vez')) {
                                    button.textContent = 'Eliminar';
                                    button.classList.remove('confirm');
                                }
                            }, 3000);
                            return;
                        }
                        if (!firebaseReady || !poiCollectionRef) {
                            showMessage("Error: La base de datos no está lista.", 4000);
                            button.textContent = 'Eliminar';
                            button.classList.remove('confirm');
                            return;
                        }
                        try {
                            button.disabled = true;
                            button.textContent = 'Eliminando...';
                            await deleteDoc(doc(db, poiCollectionRef.path, docId));
                            showMessage('Punto de interés eliminado.', 3000);
                        } catch (error) {
                            console.error("Error deleting document from map: ", error);
                            showMessage("No se pudo eliminar: " + error.message, 5000);
                            button.disabled = false;
                            button.textContent = 'Eliminar';
                            button.classList.remove('confirm');
                        }
                    }
                });
            }

            initializeMap();
            initializeFirebase();
        });

        function displayAppVersion() {
            if (versionDisplay) versionDisplay.textContent = `Versión ${APP_VERSION}`;
        }
    </script>
</body>
</html>


