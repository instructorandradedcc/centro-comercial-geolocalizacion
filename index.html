<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panel de Administración AR (Geolocalización) - Prototipo</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- Three.js (ya está incluido, se usa para cálculos) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page {
            display: none; height: 100%; width: 100%;
            position: relative; overflow-y: auto;
            padding-bottom: 60px;
        }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; }

        .page#login-page {
            display: none; align-items: center;
            justify-content: center; background-color: #f3f4f6;
        }
        .page#login-page.active { display: flex; }

        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover:not(:disabled) { background-color: #45a049; }
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.7; }

        .delete-btn-map {
            background-color: #f44336; color: white;
            font-size: 0.75rem; padding: 0.25rem 0.5rem;
            border-radius: 0.25rem; margin-left: 0.25rem; transition: background-color 0.3s;
        }
        .delete-btn-map:hover:not(:disabled) { background-color: #d32f2f; }
        .delete-btn-map.confirm { background-color: #ff9800; }
        .delete-btn-map.confirm:hover:not(:disabled) { background-color: #f57c00; }

        .secondary-action-btn {
            background-color: #607d8b; color: white;
            padding: 8px 16px; border: none;
            border-radius: 6px; font-size: 14px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 8px;
        }
        .secondary-action-btn:hover:not(:disabled) { background-color: #546e7a; }

        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem;
            z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out;
            pointer-events: none; max-width: 90%; text-align: center;
        }
        #message-box.show { opacity: 1; }

        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-controls { position: fixed; top: 20px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px; }

        #map-crosshair {
            position: absolute !important;
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 30px !important; height: 30px !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            box-shadow: 0 0 10px black, 0 0 0 2px rgba(0, 0, 0, 0.5) !important;
            pointer-events: none !important; z-index: 1000 !important;
        }

        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center;
        }
        #map-center-coords {
            position: fixed; top: 75px; left: 20px;
            z-index: 402; background-color: rgba(0, 0, 0, 0.75);
            color: white; padding: 8px 12px;
            border-radius: 8px; font-size: 0.8rem;
            font-family: monospace; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #map-center-coords span { display: block; }

        .map-panel {
            position: fixed; top: 80px; left: 10px;
            z-index: 401; background-color: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px; width: 90%;
            max-height: calc(100vh - 180px); overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        #edit-location-panel { border: 2px solid #f59e0b; }
        #placed-pois-panel {
            left: auto; right: 10px; max-width: 250px;
            transition: transform 0.3s ease-out;
        }
        #placed-pois-panel.minimized {
            transform: translateX(calc(100% - 40px));
            overflow-y: hidden; box-shadow: none; padding: 5px;
        }
        #placed-pois-panel.minimized h3,
        #placed-pois-panel.minimized .text-xs,
        #placed-pois-panel.minimized #placed-pois-list { display: none; }
        #toggle-pois-btn-map { background-color: #607d8b; } /* Adjusted ID for prototype */

        #placement-preview-image {
            max-width: 100px; max-height: 100px;
            margin: 10px auto; border: 1px solid #ccc;
            border-radius: 4px; display: none; object-fit: contain;
        }
        .leaflet-popup-content img.popup-image {
            max-width: 100px; max-height: 100px;
            display: block; margin: 5px auto;
            border-radius: 4px;
        }

        a-scene { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; }
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }

        #ar-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; align-items: center; }
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }

        .ar-loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10002;
        }
        .ar-loading-screen.active { display: flex; }
        #progress-bar-container {
            width: 80%; max-width: 400px; background: rgba(255, 255, 255, 0.2);
            border-radius: 5px; margin-top: 20px; height: 10px; overflow: hidden;
        }
        #progress-bar {
            width: 0%; height: 100%; background: #4CAF50;
            border-radius: 5px; transition: width 0.3s ease;
        }
        #loading-asset-status {
            margin-top: 10px; font-size: 0.9rem;
            color: #ccc; min-height: 20px; text-align: center;
        }

        #ar-guide {
            position: fixed; top: 100px; left: 50%;
            transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7);
            color: white; padding: 10px 15px; border-radius: 8px;
            font-size: 1.1rem; font-weight: bold; z-index: 9999;
            text-align: center; display: none; border: 2px solid #FFC107;
        }

        #ar-scale-controls {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); z-index: 9999;
            width: 80%; max-width: 400px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px; border-radius: 8px;
            color: white; display: flex; flex-direction: column; gap: 5px;
        }
        .scale-label-ar { font-size: 0.8rem; font-weight: normal; }
        .scale-value-ar { font-weight: bold; color: #4CAF50; }

        a-video { border: 2px solid white; background-color: black; }

        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; object-fit: cover !important;
            z-index: -1 !important; display: block !important; opacity: 1 !important;
            visibility: visible !important; autoplay: true !important;
            playsinline: true !important; webkit-playsinline: true !important;
            muted: true !important;
        }
        canvas, .a-canvas {
            background: transparent !important; background-color: rgba(0, 0, 0, 0) !important;
            z-index: 1 !important; position: fixed !important; top: 0 !important;
            left: 0 !important; width: 100% !important; height: 100% !important;
        }

        #ar-rotation-controls {
            position: fixed; bottom: 100px; left: 50%;
            transform: translateX(-50%); z-index: 9999;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px; border-radius: 8px; display: none;
            flex-direction: column; gap: 5px;
        }
        #ar-rotation-controls.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- PAGE 0: Login -->
    <div id="login-page" class="page active flex items-center justify-center bg-gray-200">
        <div class="bg-white p-10 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Admin AR</h1>
            <p class="text-gray-600 mb-8">Por favor, inicia sesión para continuar.</p>
            <button id="google-login-btn" class="control-button bg-blue-500 hover:bg-blue-600 w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.35 12.24c0-.79-.07-1.54-.2-2.28h-9.15v4.3h5.16c-.22 1.4-.87 2.6-1.95 3.4v2.8h3.59c2.1-1.9 3.3-4.5 3.3-7.22z"/><path d="M12 21.8c2.6 0 4.7-.87 6.2-2.3l-3.6-2.8c-.87.6-1.9.9-3.1.9-2.4 0-4.5-1.6-5.2-3.8H3.1v2.9c1.5 3 4.5 5 8.2 5z"/><path d="M6.8 14.3c-.2-.6-.3-1.2-.3-1.8s.1-1.2.3-1.8V7.8H3.1c-.6 1.2-1 2.5-1 4s.4 2.8 1 4l3.7-2.9z"/><path d="M12 6.3c1.4 0 2.6.5 3.6 1.4l3.2-3.2C17.2 2.8 14.8 2 12 2c-3.7 0-6.7 2-8.2 5l3.7 2.9c.7-2.2 2.8-3.8 5.2-3.8z"/></svg>
                <span>Iniciar Sesión con Google</span>
            </button>
            <!-- Hidden elements for user info, assuming IDs from v1.44 -->
            <div id="user-info" class="hidden mt-4 text-sm">Logueado como: <strong id="user-email"></strong></div>
            <button id="logout-btn" class="control-button bg-red-500 hover:bg-red-600 mt-4 hidden">Salir</button>
        </div>
    </div>

    <!-- PAGE 1: Admin Panel (Simplified for Prototype) -->
    <div id="admin-page" class="page">
        <div class="container mx-auto p-6 max-w-4xl">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Panel Prototipo AR</h1>
            <p class="mb-4">Funcionalidad de Admin simplificada. Usa los controles de Mapa y AR.</p>
            <div class="flex gap-2">
                <button id="goto-map-btn-admin" class="control-button bg-indigo-500 hover:bg-indigo-600">Ir al Mapa</button>
                 <button id="goto-summary-btn-admin" class="control-button bg-purple-500 hover:bg-purple-600">Ver Resumen</button>
            </div>
             <!-- Simplified POI List display -->
            <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                 <h2 class="text-2xl font-semibold mb-4">Contenido Guardado (Simple)</h2>
                 <div id="poi-list-container" class="space-y-2">
                     <p id="loading-pois" class="text-gray-500 font-semibold">Cargando...</p>
                     <!-- List items will be added by JS -->
                 </div>
             </div>
        </div>
    </div>

    <!-- PAGE 2: Map View (Simplified Placement/Edit) -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
        </div>

        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        <div id="map-center-coords">
            <span>Lat: --</span>
            <span>Lon: --</span>
        </div>

        <!-- Simplified Placement Panel -->
        <div id="placement-panel" class="map-panel">
             <h3 class="text-lg font-semibold mb-2">Colocar Nuevo POI (Simple)</h3>
             <input type="text" id="place-name-simple" class="w-full p-2 border rounded mb-2" placeholder="Nombre del POI">
             <input type="url" id="place-model-url-simple" class="w-full p-2 border rounded mb-2" placeholder="URL Modelo GLB">
             <button id="save-placement-btn-simple" class="control-button w-full">Guardar en la Cruz</button>
         </div>

         <!-- Simplified Placed POIs Panel -->
         <div id="placed-pois-panel" class="map-panel right-3">
             <h3 class="text-lg font-semibold mb-2">POIs en Mapa</h3>
             <div id="placed-pois-list">
                 <p class="text-sm text-gray-500">Cargando...</p>
             </div>
         </div>

        <!-- Map Controls -->
        <div id="map-controls">
             <button id="toggle-pois-btn-map" class="control-button bg-gray-700 hover:bg-gray-800">Ocultar POIs</button>
             <button id="back-to-admin-btn-map" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Panel</button>
             <button id="goto-summary-btn-map" class="control-button bg-purple-500 hover:bg-purple-600">Ver Resumen</button>
         </div>
    </div>

    <!-- PAGE 3: Summary View -->
    <div id="summary-page" class="page">
        <div class="container mx-auto p-6 max-w-4xl">
             <h1 class="text-3xl font-bold text-purple-700 mb-6">Resumen de Contenido AR</h1>
             <div class="flex gap-2 mb-6">
                <button id="back-to-map-btn-summary" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Mapa</button>
                <button id="launch-ar-btn-summary" class="control-button bg-green-500 hover:bg-green-600">¡Probar AR!</button>
             </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold mb-4">Contenido Activo</h2>
                 <div id="summary-poi-list" class="space-y-4">
                     <p id="loading-summary-pois" class="text-gray-500">Cargando...</p>
                 </div>
             </div>
        </div>
    </div>

    <!-- PAGE 4: Augmented Reality View -->
    <div id="ar-page" class="page">
        <div id="ar-scene-container"></div> <!-- A-Frame scene injected here -->

        <!-- AR Loading Screen -->
        <div id="ar-loading-screen" class="ar-loading-screen active">
             <div class="loader"></div>
             <div id="loading-status-text">Cargando escena AR...</div>
             <div id="progress-bar-container"><div id="progress-bar"></div></div>
             <div id="loading-asset-status"></div>
         </div>

         <!-- AR Guide -->
        <div id="ar-guide" style="display:none;">
            Cercano: <span id="guide-name"></span> | Dist: <span id="guide-distance"></span> | Dir: <span id="guide-bearing"></span>
        </div>

        <!-- AR Scale Controls -->
        <div id="ar-scale-controls">
            <label class="scale-label-ar">Escala Visual: <span id="ar-scale-value-display" class="scale-value-ar">1.00x</span></label>
            <input id="ar-scale-slider" type="range" min="0.1" max="5.0" step="0.05" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>

        <!-- AR Info Panel -->
        <div class="ar-info-panel">
            GPS: <span id="gps-status">Buscando...</span> | Precisión: <span id="gps-accuracy">--</span>m
        </div>

        <!-- AR Controls -->
        <div id="ar-controls">
            <button id="back-to-summary-btn" class="secondary-action-btn">Volver al Resumen</button>
            <button id="save-ar-scale-btn" class="control-button bg-orange-500 hover:bg-orange-600" disabled>Guardar Escala</button>
        </div>
    </div>

    <!-- Message Box and Permission Modal -->
    <div id="message-box"></div>
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <p>Se requieren permisos de cámara y GPS (Alta Precisión) para AR.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder</button>
        </div>
    </div>

    <!-- Firebase SDK Module -->
    <script type="module">
        // Importar Firebase SDK v11.6.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            signInAnonymously // Importar signInAnonymously si se usa como fallback
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            deleteDoc,
            updateDoc,
            onSnapshot,
            query,
            setLogLevel
         } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración ---
        const APP_VERSION = '1.47-Proto-ManualConfig-Complete'; // Versión específica del prototipo
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'manual-app-id'; // Usar 'manual-app-id' si __app_id no está

        // --- CONFIGURACIÓN MANUAL DE FIREBASE ---
        // INTENTA LEER LA CONFIGURACIÓN DEL ENTORNO (__firebase_config)
        // SI NO EXISTE, USA LOS VALORES MANUALES DE ABAJO.
        // !! REEMPLAZA LOS VALORES "TU_..." CON LOS DE TU PROYECTO !!
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Usando configuración de Firebase del entorno (__firebase_config).");
            } catch (e) {
                console.error("Error al parsear __firebase_config. Usando configuración manual.", e);
                firebaseConfig = null; // Marcar como inválido para usar el bloque manual
            }
        } else {
             firebaseConfig = null; // Marcar como nulo para usar el bloque manual
        }

        if (!firebaseConfig) {
            console.warn("Variable __firebase_config no encontrada o inválida. Usando configuración manual. ¡REEMPLAZA LOS VALORES 'TU_...'!");
            firebaseConfig = {
                apiKey: "TU_API_KEY", // Reemplaza esto
                authDomain: "TU_AUTH_DOMAIN", // Reemplaza esto (ej: tu-proyecto.firebaseapp.com)
                projectId: "TU_PROJECT_ID", // Reemplaza esto
                storageBucket: "TU_STORAGE_BUCKET", // Reemplaza esto (ej: tu-proyecto.appspot.com)
                messagingSenderId: "TU_MESSAGING_SENDER_ID", // Reemplaza esto
                appId: "TU_APP_ID" // Reemplaza esto (formato: 1:xxxx:web:xxxx)
            };
        }
        // --- FIN CONFIGURACIÓN MANUAL ---

        // --- Variables Globales ---
        let db, auth, userId, poiCollectionRef;
        let map; // Instancia del mapa Leaflet
        let poiMarkers = {}; // Cache de marcadores del mapa
        let allPoisData = []; // Cache local de datos de POIs
        let firebaseReady = false;

        // AR
        let arScene = null;
        let lastKnownGps = { latitude: 0, longitude: 0, accuracy: 9999, heading: null };
        let arFineScaleMultiplier = 1.0;
        let closestPoiIdForScaling = null;

        // Elementos UI (asignados en DOMContentLoaded)
        let pages = {};
        let messageBox, permissionModal, arLoadingScreen, loadingStatusText, progressBar, progressBarContainer, loadingAssetStatus, versionDisplay, arGuide, guideName, guideDistance, guideBearing, arScaleSlider, arScaleValueDisplay, saveArScaleBtn, listContainer, loadingPois, gotoMapButton, googleLoginBtn, logoutBtn, userInfo, userEmail, placedPoisList, summaryPoiList, loadingSummaryPois, mapCenterCoordsEl, jumptoBtn; // Añadido jumptoBtn

        // --- Funciones Utilitarias ---
        function showMessage(msg, duration = 3000) {
            if (!messageBox) return;
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            if (messageBox.timeoutId) clearTimeout(messageBox.timeoutId);
            messageBox.timeoutId = setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.timeoutId = null;
            }, duration);
        }

        function navigateTo(pageName) {
            console.log(`Navigating to: ${pageName}`);
            Object.values(pages).forEach(p => p?.classList.remove('active'));
            if (pages[pageName]) {
                pages[pageName].classList.add('active');
            } else {
                console.error(`Page not found: ${pageName}. Falling back to login.`);
                if (pages.login) pages.login.classList.add('active');
                 return;
            }
             // Cleanup/Setup específico de página
             if (pageName === 'map') { stopAR(); setTimeout(initializeMap, 100); }
             else if (pageName === 'summary') { stopAR(); stopMap(); loadPoisFromFirebase(true); } // Forzar actualización de resumen
             else if (pageName === 'ar') { stopMap(); startARFlow(); }
             else if (pageName === 'admin') { stopAR(); stopMap(); }
             else if (pageName === 'login') { stopAR(); stopMap(); }
        }

        // --- Lógica Firebase ---
        async function initializeFirebase() {
             console.log("Initializing Firebase...");

             // Validar config básica - MODIFICADO para permitir config manual
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId.startsWith("TU_")) {
                const errorMsg = "Error fatal: Configuración de Firebase inválida. Reemplaza los valores 'TU_...' en el código.";
                console.error(errorMsg, firebaseConfig);
                showMessage(errorMsg, 15000); // Mensaje más largo
                // Bloquear UI o mostrar mensaje permanente
                if(googleLoginBtn) googleLoginBtn.disabled = true;
                return; // Detener inicialización
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('Firebase User Authenticated:', userId);
                        // Actualizar UI
                        if (userEmail) userEmail.textContent = user.email || userId;
                        if (userInfo) userInfo.classList.remove('hidden');
                        if (logoutBtn) logoutBtn.classList.remove('hidden');
                        if (googleLoginBtn) googleLoginBtn.classList.add('hidden');

                        // Configurar referencia de colección
                        // Usar appId manual si no se detecta el del entorno
                        const currentAppId = (typeof __app_id !== 'undefined' && __app_id !== 'default-app-id') ? __app_id : 'manual-app-id-for-testing'; // Usa un ID claro si es manual
                        const collectionPath = `/artifacts/${currentAppId}/users/${userId}/pois`;
                        poiCollectionRef = collection(db, collectionPath);
                        console.log('POI Collection Path:', collectionPath);

                        firebaseReady = true;
                        if (gotoMapButton) gotoMapButton.disabled = false;

                        showMessage(`Bienvenido, ${user.displayName || user.email}`, 2000);
                        loadPoisFromFirebase();

                        if (pages.login?.classList.contains('active')) {
                            navigateTo('admin');
                        }
                     } else {
                        // Usuario deslogueado
                        userId = null;
                        poiCollectionRef = null;
                        firebaseReady = false;
                        console.log('Firebase User signed out.');
                        if (gotoMapButton) gotoMapButton.disabled = true;
                        // Actualizar UI
                        if (userInfo) userInfo.classList.add('hidden');
                        if (logoutBtn) logoutBtn.classList.add('hidden');
                        if (googleLoginBtn) googleLoginBtn.classList.remove('hidden');

                        allPoisData = [];
                        updatePoiLists();
                        navigateTo('login');
                    }
                });
            } catch (initError) {
                console.error("Firebase Initialization Error:", initError);
                firebaseReady = false;
                const errorMsg = `Error al inicializar Firebase: ${initError.message}. Verifica tu configuración manual.`;
                showMessage(errorMsg, 10000);
            }
        }

        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            if (!auth) {
                 showMessage("Servicio de autenticación no listo.", 3000);
                 return;
            }
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged se encargará del resto
            } catch (error) {
                console.error("Google Login Error:", error);
                 // Mostrar mensaje más específico si el popup fue cerrado
                 if (error.code === 'auth/popup-closed-by-user') {
                    showMessage("Inicio de sesión cancelado.", 3000);
                 } else {
                    showMessage("Error al iniciar sesión: " + (error.message || "Intenta de nuevo."), 5000);
                 }
            }
        }

        async function handleLogout() {
            if (!auth) return;
            try {
                await signOut(auth);
                showMessage("Sesión cerrada.", 2000);
                 // onAuthStateChanged se encargará del resto
            } catch (error) {
                showMessage("Error al cerrar sesión.", 3000);
            }
        }

        // --- Carga y Muestra de Datos Firestore ---
        function loadPoisFromFirebase(forceSummaryUpdate = false) {
             if (!poiCollectionRef) {
                 console.warn("loadPoisFromFirebase called before collection ref is set.");
                 if (loadingPois) loadingPois.textContent = "Esperando login...";
                 return;
             }
             if (loadingPois) loadingPois.textContent = "Cargando POIs...";

             onSnapshot(query(poiCollectionRef), (snapshot) => {
                 allPoisData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 console.log(`Loaded ${allPoisData.length} POIs from Firebase.`);
                 updatePoiLists(); // Actualizar todas las listas UI
                 if (map && pages.map?.classList.contains('active')) {
                     updateMapMarkers(); // Actualizar marcadores si el mapa está activo
                 }
                 if (forceSummaryUpdate && pages.summary?.classList.contains('active')) {
                     populateSummaryList(); // Forzar actualización de la lista de resumen
                 }
             }, (error) => {
                 console.error("Error fetching POIs: ", error);
                 showMessage("Error al cargar POIs: " + error.message, 4000);
                 if (loadingPois) loadingPois.textContent = "Error al cargar.";
             });
        }

        // --- Actualización UI Listas (Separado para claridad) ---
        function updatePoiLists() {
             populateAdminList();
             populateMapPoiList();
             populateSummaryList(); // Llamar siempre, decide internamente si mostrar loading
         }

        function populateAdminList() {
             if (listContainer) {
                 if (allPoisData.length === 0) {
                     listContainer.innerHTML = '<p class="text-gray-500">No hay POIs guardados.</p>';
                 } else {
                     listContainer.innerHTML = allPoisData.map(poi => `
                         <div class="p-2 bg-gray-100 rounded flex justify-between items-center text-sm">
                             <span>${poi.name || poi.id}</span>
                             <button class="text-red-600 hover:text-red-800 text-xs admin-delete-btn" data-id="${poi.id}">Eliminar</button>
                         </div>`).join('');
                 }
                 if (loadingPois) loadingPois.style.display = 'none';
             }
         }

         function populateMapPoiList() {
            if (placedPoisList) {
                // Asegurarse de que listEl es el contenedor correcto
                 const listEl = document.getElementById('placed-pois-list');
                if (!listEl) return;

                if (allPoisData.length === 0) {
                     listEl.innerHTML = '<p class="text-sm text-gray-500">No hay POIs en el mapa.</p>';
                } else {
                    listEl.innerHTML = allPoisData.map(poi => `
                        <div class="p-1 border-b flex justify-between items-center text-xs">
                            <span>${poi.name || poi.id}</span>
                            <button class="delete-btn-map" data-id="${poi.id}">Eliminar</button>
                        </div>`).join('');
                 }
             }
        }

        function populateSummaryList() {
             if (summaryPoiList) {
                 // Asegurarse de que listEl es el contenedor correcto
                 const listEl = document.getElementById('summary-poi-list');
                 if (!listEl) return;

                 if (!firebaseReady) {
                     listEl.innerHTML = '<p id="loading-summary-pois" class="text-gray-500">Esperando conexión...</p>';
                     return;
                 }

                 const activePois = filterActivePois();
                 if (activePois.length === 0) {
                      listEl.innerHTML = '<p class="text-gray-500">No hay contenido activo para hoy.</p>';
                 } else {
                     listEl.innerHTML = activePois.map(poi => `
                         <div class="p-3 bg-green-50 rounded shadow-sm">
                             <strong class="text-md text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                             <div class="text-xs text-gray-600 mt-1">
                                 <span>Lat: ${poi.lat?.toFixed(5)}</span> | <span>Lon: ${poi.lon?.toFixed(5)}</span>
                             </div>
                             <div class="text-xs text-gray-600">
                                 <span>Escala AR: ${poi.arScaleMultiplier?.toFixed(1) || '1.0'}x</span>
                             </div>
                         </div>`).join('');
                 }
                 // Ocultar el P de carga si existe
                 const loadingSummaryEl = document.getElementById('loading-summary-pois');
                 if (loadingSummaryEl) loadingSummaryEl.style.display = 'none';
             }
         }


        // --- Lógica del Mapa (Leaflet) ---
        function initializeMap() {
             if (map) { // Si ya existe, solo invalidar tamaño
                 setTimeout(() => map.invalidateSize(), 100);
                 updateMapMarkers(); // Actualizar marcadores
                 return;
             }
             const mapContainer = document.getElementById('map-canvas');
             if (!mapContainer) {
                console.error("Map container #map-canvas not found.");
                return;
             }

             map = L.map(mapContainer, { zoomControl: false }).setView([4.0835, -76.1915], 15); // Tuluá
             L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                 maxZoom: 22, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: 'Google'
             }).addTo(map);

             map.on('move', () => {
                 const center = map.getCenter();
                 if (mapCenterCoordsEl) mapCenterCoordsEl.innerHTML = `<span>Lat: ${center.lat.toFixed(6)}</span><span>Lon: ${center.lng.toFixed(6)}</span>`;
             });
             updateMapMarkers(); // Añadir marcadores iniciales
        }

        function stopMap() {
            if (map) {
                map.remove();
                map = null;
                poiMarkers = {};
                console.log("Map stopped.");
            }
        }

        function updateMapMarkers() {
             if (!map) return;
             // Limpiar marcadores existentes
             Object.values(poiMarkers).forEach(marker => map.removeLayer(marker));
             poiMarkers = {};
             // Añadir marcadores para cada POI
             allPoisData.forEach(poi => {
                 if (poi.lat != null && poi.lon != null) { // Check for null or undefined explicitly
                     try {
                         const marker = L.marker([poi.lat, poi.lon]).addTo(map)
                             .bindPopup(`<b>${poi.name || 'POI'}</b><br>Escala: ${poi.arScaleMultiplier || 1.0}x`);
                         poiMarkers[poi.id] = marker;
                     } catch (e) {
                         console.error(`Error adding marker for POI ${poi.id} (${poi.name}) at [${poi.lat}, ${poi.lon}]:`, e);
                     }
                 } else {
                     console.warn(`Skipping marker for POI ${poi.id} (${poi.name}) due to missing coordinates.`);
                 }
             });
             console.log(`Updated ${Object.keys(poiMarkers).length} map markers.`);
        }

        // --- Lógica AR (A-Frame, AR.js) ---
        async function startARFlow() {
             console.log("Starting AR Flow...");
             if (!arLoadingScreen || !permissionModal) {
                console.error("AR UI elements missing.");
                return;
             }

             arLoadingScreen.classList.add('active');
             // Reset UI
             if (arScaleSlider) arScaleSlider.value = 1.0;
             if (arScaleValueDisplay) arScaleValueDisplay.textContent = '1.00x';
             closestPoiIdForScaling = null;
             if (saveArScaleBtn) saveArScaleBtn.disabled = true;

             try {
                 // Pedir permisos
                 console.log("Requesting camera permission...");
                 const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                 stream.getTracks().forEach(track => track.stop());
                 console.log("Camera permission granted.");

                 console.log("Requesting high accuracy GPS permission...");
                 await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }));
                 console.log("GPS permission granted.");

                 initializeARScene(); // Inicializar A-Frame

             } catch (err) {
                 console.error("AR Permission Error:", err);
                 arLoadingScreen.classList.remove('active');
                 permissionModal.style.display = 'flex';
                 showMessage(err.message.includes("denied") ? "Permisos denegados." : "Error de permisos.", 6000);
             } finally {
                 // Quitar pantalla de carga después de un tiempo (A-Frame/AR.js manejan su propia carga)
                 setTimeout(() => arLoadingScreen.classList.remove('active'), 1500);
             }
        }

        function initializeARScene() {
             const arContainer = document.getElementById('ar-scene-container');
             if (!arContainer) {
                 console.error("AR container #ar-scene-container not found!");
                 return;
             }
             arContainer.innerHTML = ''; // Limpiar

             const activePois = filterActivePois();
             if (activePois.length === 0) {
                 showMessage("No hay POIs activos para mostrar en AR hoy.", 4000);
                 stopAR(); // Ensure AR view is properly cleaned up if nothing to show
                 navigateTo('summary'); // Go back to summary
                 return; // No crear escena si no hay nada que mostrar
             }

             // Construir HTML de la escena
             let assetsHTML = '<a-assets timeout="30000">';
             activePois.forEach(poi => {
                 if (poi.modelUrl) { // Asumiendo que modelUrl existe para modelos
                     assetsHTML += `<a-asset-item id="model-${poi.id}" src="${poi.modelUrl}" crossOrigin="anonymous"></a-asset-item>`; // Added crossOrigin
                 }
                 // Añadir assets para videos o sonidos si es necesario
             });
             assetsHTML += '</a-assets>';

             let entitiesHTML = '';
             activePois.forEach(poi => {
                 const scaleMultiplier = poi.arScaleMultiplier || 1.0; // Use saved multiplier or default
                 // NOTE: Base scale (poi.scale) is NOT used here as AR.js handles scale differently
                 const height = poi.height || 0; // Use 'height' if exists, otherwise 0

                 entitiesHTML += `
                     <a-entity
                         class="poi-entity"
                         data-poi-id="${poi.id}"
                         gps-entity-place="latitude: ${poi.lat}; longitude: ${poi.lon};"
                         gltf-model="#model-${poi.id}"
                         scale="${scaleMultiplier} ${scaleMultiplier} ${scaleMultiplier}"
                         position="0 ${height} 0">
                     </a-entity>`;
             });

             const sceneHTML = `
                 <a-scene id="ar-scene" embedded vr-mode-ui="enabled: false"
                          renderer="logarithmicDepthBuffer: true; alpha: true;"
                          arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
                     ${assetsHTML}
                     <a-camera id="ar-camera" gps-camera="gpsTimeInterval: 1000" rotation-reader></a-camera>
                     ${entitiesHTML}
                     <a-light type="ambient" color="#BBB"></a-light>
                     <a-light type="directional" color="#FFF" intensity="0.6" position="-1 1 0.5"></a-light>
                 </a-scene>`;

             arContainer.innerHTML = sceneHTML;
             arScene = document.getElementById('ar-scene');

             // Adjuntar listeners de GPS a la cámara
             const camera = document.getElementById('ar-camera');
             if (camera) {
                 console.log("Attaching GPS listeners to camera...");
                 camera.removeEventListener('gps-camera-update-position', onGPSUpdate); // Prevent duplicates
                 camera.removeEventListener('gps-camera-error', onGPSError);
                 camera.addEventListener('gps-camera-update-position', onGPSUpdate);
                 camera.addEventListener('gps-camera-error', onGPSError);
             } else {
                 console.error("AR camera not found after scene creation!");
             }
             console.log("AR Scene initialized.");
        }

        function stopAR() {
            if (arScene) {
                 const camera = document.getElementById('ar-camera');
                 if (camera) {
                     camera.removeEventListener('gps-camera-update-position', onGPSUpdate);
                     camera.removeEventListener('gps-camera-error', onGPSError);
                 }
                try { // Wrap in try-catch as pause() might fail if scene is already removed
                   arScene.pause();
                } catch(e) { console.warn("Error pausing AR scene:", e); }

                const container = document.getElementById('ar-scene-container');
                if(container) container.innerHTML = ''; // Limpiar escena
                arScene = null;
                console.log("AR Stopped.");
            }
             // Reset UI
            const gpsStatusEl = document.getElementById('gps-status');
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsStatusEl) gpsStatusEl.textContent = "Buscando...";
            if (gpsAccuracyEl) gpsAccuracyEl.textContent = "--";
            if (arGuide) arGuide.style.display = 'none';
            closestPoiIdForScaling = null;
            if (saveArScaleBtn) saveArScaleBtn.disabled = true;
        }

        // --- Handlers GPS y AR ---
         function filterActivePois() {
             const now = new Date();
             return allPoisData.filter(poi => {
                 if (!poi.lat || !poi.lon) return false;
                 // Lógica simple de activación, se puede expandir con fechas
                 // Aquí podrías añadir comprobación de poi.startDate y poi.endDate si los usas
                 return true; // Asumiendo todos activos por ahora
             });
         }
        // --- Math Functions ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (lat1 == null || lon1 == null || lat2 == null || lon2 == null) return Infinity;
            const R = 6371e3; // meters
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in meters
        }
        function calculateBearing(lat1, lon1, lat2, lon2) {
            if (lat1 == null || lon1 == null || lat2 == null || lon2 == null) return 0;
             const phi1 = lat1 * Math.PI / 180;
             const phi2 = lat2 * Math.PI / 180;
             const lambda1 = lon1 * Math.PI / 180;
             const lambda2 = lon2 * Math.PI / 180;
             const y = Math.sin(lambda2 - lambda1) * Math.cos(phi2);
             const x = Math.cos(phi1) * Math.sin(phi2) -
                       Math.sin(phi1) * Math.cos(phi2) * Math.cos(lambda2 - lambda1);
             const theta = Math.atan2(y, x);
             return (theta * 180 / Math.PI + 360) % 360; // in degrees
        }
         function getDirectionArrow(bearingDiff) {
            let normalizedDiff = bearingDiff % 360;
            if (normalizedDiff > 180) normalizedDiff -= 360;
            if (normalizedDiff <= -180) normalizedDiff += 360;

            if (normalizedDiff >= -22.5 && normalizedDiff <= 22.5) return "↑"; // Forward
            if (normalizedDiff > 22.5 && normalizedDiff <= 67.5) return "↗"; // Forward-Right
            if (normalizedDiff > 67.5 && normalizedDiff <= 112.5) return "→"; // Right
            if (normalizedDiff > 112.5 && normalizedDiff <= 157.5) return "↘"; // Back-Right
            if (normalizedDiff > 157.5 || normalizedDiff < -157.5) return "↓"; // Back
            if (normalizedDiff < -112.5 && normalizedDiff >= -157.5) return "↙"; // Back-Left
            if (normalizedDiff < -67.5 && normalizedDiff >= -112.5) return "←"; // Left
            if (normalizedDiff < -22.5 && normalizedDiff >= -67.5) return "↖"; // Forward-Left
            return "?";
        }


        function onGPSUpdate(event) {
             if (!arScene) return;
             const pos = event.detail?.position?.coords; // Safely access coords
             if (!pos) return;
             lastKnownGps = { latitude: pos.latitude, longitude: pos.longitude, accuracy: pos.accuracy, heading: pos.heading };
             const gpsStatusEl = document.getElementById('gps-status');
             const gpsAccuracyEl = document.getElementById('gps-accuracy');
             if(gpsStatusEl) gpsStatusEl.textContent = 'OK';
             if(gpsAccuracyEl) gpsAccuracyEl.textContent = pos.accuracy?.toFixed(1) ?? '--';
             updateARGuide(); // Actualizar guía y botón de guardar escala
        }

        function onGPSError(event) {
             if (!arScene) return;
             console.error("GPS Error:", event.detail);
             const gpsStatusEl = document.getElementById('gps-status');
             const gpsAccuracyEl = document.getElementById('gps-accuracy');
             if(gpsStatusEl) gpsStatusEl.textContent = 'Error';
             if(gpsAccuracyEl) gpsAccuracyEl.textContent = 'N/A';
             showMessage("Error de GPS: " + (event.detail?.message || "Desconocido"), 4000);
             closestPoiIdForScaling = null;
             if(saveArScaleBtn) saveArScaleBtn.disabled = true;
        }

        function updateARGuide() {
            if (!lastKnownGps.latitude) return; // Esperar GPS
            const activePois = filterActivePois();
            let closestPoi = null;
            let minDistance = Infinity;
            activePois.forEach(poi => {
                 const dist = calculateDistance(lastKnownGps.latitude, lastKnownGps.longitude, poi.lat, poi.lon);
                 if (dist < minDistance) {
                     minDistance = dist;
                     closestPoi = poi;
                 }
            });

            if (closestPoi && minDistance < 1000 && lastKnownGps.accuracy < 150) { // Mostrar si está a menos de 1km y GPS aceptable
                 const bearing = calculateBearing(lastKnownGps.latitude, lastKnownGps.longitude, closestPoi.lat, closestPoi.lon);
                 const bearingDiff = bearing - (lastKnownGps.heading || 0);
                 if (arGuide) {
                    guideName.textContent = closestPoi.name || 'POI';
                    guideDistance.textContent = `${minDistance.toFixed(0)}m`;
                    guideBearing.textContent = getDirectionArrow(bearingDiff);
                    arGuide.style.display = 'block';
                 }
                 // Lógica para guardar escala
                 if (closestPoiIdForScaling !== closestPoi.id) {
                    closestPoiIdForScaling = closestPoi.id;
                    const savedMultiplier = closestPoi.arScaleMultiplier || 1.0;
                    if(arScaleSlider) arScaleSlider.value = savedMultiplier;
                    if(arScaleValueDisplay) arScaleValueDisplay.textContent = `${savedMultiplier.toFixed(2)}x`;
                    applyFineScaleAdjustment(); // Aplicar visualmente
                 }
                 if(saveArScaleBtn) saveArScaleBtn.disabled = false;
            } else {
                if(arGuide) arGuide.style.display = 'none';
                closestPoiIdForScaling = null;
                if(saveArScaleBtn) saveArScaleBtn.disabled = true;
            }
        }

        function applyFineScaleAdjustment() {
             if (!arScene || !arScaleSlider) return;
             arFineScaleMultiplier = parseFloat(arScaleSlider.value);
             if (arScaleValueDisplay) arScaleValueDisplay.textContent = `${arFineScaleMultiplier.toFixed(2)}x`;
             arScene.querySelectorAll('.poi-entity').forEach(entity => {
                const poiId = entity.dataset.poiId;
                 const poiData = allPoisData.find(p => p.id === poiId); // Find corresponding data
                 // Apply scale based on type (simple multiplier for now)
                 // A more robust approach would involve base scale stored in poiData
                entity.setAttribute('scale', `${arFineScaleMultiplier} ${arFineScaleMultiplier} ${arFineScaleMultiplier}`);
             });
             if(saveArScaleBtn) saveArScaleBtn.disabled = !closestPoiIdForScaling; // Habilitar/deshabilitar guardar
         }

         async function handleSaveARScale() {
             if (!closestPoiIdForScaling || !firebaseReady || !saveArScaleBtn) return;
             const newMultiplier = parseFloat(arScaleSlider.value);
             const poiName = allPoisData.find(p => p.id === closestPoiIdForScaling)?.name || 'este POI';

             saveArScaleBtn.disabled = true;
             saveArScaleBtn.textContent = 'Guardando...';
             try {
                 await updateDoc(doc(poiCollectionRef, closestPoiIdForScaling), { arScaleMultiplier: newMultiplier });
                 showMessage(`Escala ${newMultiplier.toFixed(2)}x guardada para '${poiName}'.`, 3000);
                 // Actualizar datos locales
                 const poiIndex = allPoisData.findIndex(p => p.id === closestPoiIdForScaling);
                 if (poiIndex > -1) allPoisData[poiIndex].arScaleMultiplier = newMultiplier;
             } catch (error) {
                 showMessage("Error al guardar escala: " + error.message, 4000);
             } finally {
                 saveArScaleBtn.disabled = false;
                 saveArScaleBtn.textContent = 'Guardar Escala';
             }
         }

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
             // Asignar referencias DOM
             pages = { login: document.getElementById('login-page'), admin: document.getElementById('admin-page'), map: document.getElementById('map-page'), summary: document.getElementById('summary-page'), ar: document.getElementById('ar-page') };
             messageBox = document.getElementById('message-box');
             permissionModal = document.getElementById('permission-modal');
             arLoadingScreen = document.getElementById('ar-loading-screen');
             loadingStatusText = document.getElementById('loading-status-text');
             progressBar = document.getElementById('progress-bar');
             progressBarContainer = document.getElementById('progress-bar-container');
             loadingAssetStatus = document.getElementById('loading-asset-status');
             versionDisplay = document.getElementById('version-display'); // Asumiendo que existe
             arGuide = document.getElementById('ar-guide');
             guideName = document.getElementById('guide-name');
             guideDistance = document.getElementById('guide-distance');
             guideBearing = document.getElementById('guide-bearing');
             arScaleSlider = document.getElementById('ar-scale-slider');
             arScaleValueDisplay = document.getElementById('ar-scale-value-display');
             saveArScaleBtn = document.getElementById('save-ar-scale-btn');
             listContainer = document.getElementById('poi-list-container'); // Para lista admin
             loadingPois = document.getElementById('loading-pois'); // Para loading admin
             gotoMapButton = document.getElementById('goto-map-btn-admin'); // Botón específico admin
             googleLoginBtn = document.getElementById('google-login-btn');
             logoutBtn = document.getElementById('logout-btn');
             userInfo = document.getElementById('user-info'); // Asumiendo que existe
             userEmail = document.getElementById('user-email'); // Asumiendo que existe
             placedPoisList = document.getElementById('placed-pois-list'); // Lista en mapa
             summaryPoiList = document.getElementById('summary-poi-list'); // Lista en resumen
             loadingSummaryPois = document.getElementById('loading-summary-pois'); // Loading resumen
             mapCenterCoordsEl = document.getElementById('map-center-coords'); // Coords en mapa
             jumptoBtn = document.getElementById('jumpto-btn'); // Botón Jump To

             // Asignar listeners de navegación principales (ajustar IDs si es necesario)
             document.getElementById('goto-map-btn-admin')?.addEventListener('click', () => navigateTo('map'));
             document.getElementById('back-to-admin-btn-map')?.addEventListener('click', () => navigateTo('admin'));
             document.getElementById('goto-summary-btn-admin')?.addEventListener('click', () => navigateTo('summary'));
             document.getElementById('goto-summary-btn-map')?.addEventListener('click', () => navigateTo('summary'));
             document.getElementById('back-to-map-btn-summary')?.addEventListener('click', () => navigateTo('map'));
             document.getElementById('launch-ar-btn-summary')?.addEventListener('click', () => navigateTo('ar'));
             document.getElementById('back-to-summary-btn')?.addEventListener('click', () => navigateTo('summary'));
             document.getElementById('grant-permissions-btn')?.addEventListener('click', () => { permissionModal.style.display = 'none'; startARFlow(); });

             // Listeners específicos del prototipo
             googleLoginBtn?.addEventListener('click', handleGoogleLogin);
             logoutBtn?.addEventListener('click', handleLogout);
             document.getElementById('save-placement-btn-simple')?.addEventListener('click', handleSaveSimplePlacement);
             if (listContainer) listContainer.addEventListener('click', handleDeleteAdminPoi); // Listener delegado para borrar en admin
             if (placedPoisList) placedPoisList.addEventListener('click', handleDeleteMapPoi); // Listener delegado para borrar en mapa
             if (arScaleSlider) arScaleSlider.addEventListener('input', applyFineScaleAdjustment);
             if (saveArScaleBtn) saveArScaleBtn.addEventListener('click', handleSaveARScale);
             // Añadir otros listeners necesarios para el mapa (zoom, jump, toggle)
             if (jumptoBtn) jumptoBtn.addEventListener('click', jumpToCoords);
             // Asumiendo que existe un slider de zoom para el mapa
             const mapZoomSliderEl = document.querySelector('#map-page input[type="range"]'); // Selector genérico
             if(mapZoomSliderEl && map) mapZoomSliderEl.addEventListener('input', (e) => map.setZoom(parseFloat(e.target.value)));
             // Asumiendo que existe un botón toggle para el panel de POIs en mapa
             const togglePoisBtnMap = document.getElementById('toggle-pois-btn-map');
             if (togglePoisBtnMap) togglePoisBtnMap.addEventListener('click', handleTogglePoisPanel);


             // Iniciar Firebase
             initializeFirebase();
             if (versionDisplay) versionDisplay.textContent = `v${APP_VERSION}`;
        });

         // --- Funciones Simplificadas del Prototipo ---
         async function handleSaveSimplePlacement() {
             if (!firebaseReady || !map || !poiCollectionRef) {
                 showMessage("Firebase no está listo o el mapa no está inicializado.", 3000);
                 return;
             }
             const nameInput = document.getElementById('place-name-simple');
             const modelUrlInput = document.getElementById('place-model-url-simple');
             const name = nameInput?.value.trim();
             const modelUrl = modelUrlInput?.value.trim();
             const center = map.getCenter();

             if (!name || !modelUrl) {
                 showMessage("Por favor, ingresa nombre y URL del modelo.", 3000);
                 return;
             }
             const newPoi = {
                 name: name,
                 modelUrl: modelUrl,
                 lat: center.lat,
                 lon: center.lng,
                 arScaleMultiplier: 1.0, // Default
                 poiType: 'model' // Assuming simple placement is always model
                 // Añadir otros campos si es necesario (height, dates, etc.)
             };
             try {
                 await addDoc(poiCollectionRef, newPoi);
                 showMessage(`'${name}' guardado en ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 3000);
                 // Limpiar inputs
                 if(nameInput) nameInput.value = '';
                 if(modelUrlInput) modelUrlInput.value = '';
             } catch (error) {
                 showMessage("Error al guardar POI: " + error.message, 4000);
             }
         }

        async function handleDeleteAdminPoi(e) {
             if (e.target.classList.contains('admin-delete-btn')) {
                 const docId = e.target.dataset.id;
                 if (docId && confirm(`¿Seguro que quieres eliminar este POI?`)) {
                     try {
                         await deleteDoc(doc(poiCollectionRef, docId));
                         showMessage('POI eliminado.', 2000);
                     } catch (error) {
                         showMessage('Error al eliminar: ' + error.message, 4000);
                     }
                 }
             }
         }

        async function handleDeleteMapPoi(e) {
             if (e.target.classList.contains('delete-btn-map')) {
                 const docId = e.target.dataset.id;
                 const button = e.target;
                 if (!docId || button.disabled) return;

                 if (!button.classList.contains('confirm')) {
                     button.textContent = '¿Seguro?';
                     button.classList.add('confirm');
                     setTimeout(() => {
                         const currentButton = placedPoisList?.querySelector(`.delete-btn-map[data-id="${docId}"]`);
                         if (currentButton?.classList.contains('confirm')) {
                             currentButton.textContent = 'Eliminar';
                             currentButton.classList.remove('confirm');
                         }
                     }, 3000);
                     return;
                 }
                  // Confirmado
                  try {
                     button.disabled = true; button.textContent = '...';
                     await deleteDoc(doc(poiCollectionRef, docId));
                     showMessage('POI eliminado del mapa.', 2000);
                 } catch (error) {
                     showMessage('Error al eliminar del mapa: ' + error.message, 4000);
                     button.disabled = false; button.textContent = 'Eliminar'; button.classList.remove('confirm');
                 }
             }
         }
         // Función para manejar el botón de ocultar/mostrar POIs en el mapa
         function handleTogglePoisPanel() {
             const panel = document.getElementById('placed-pois-panel');
             const button = document.getElementById('toggle-pois-btn-map');
             if (panel && button) {
                 const isMinimized = panel.classList.toggle('minimized');
                 button.textContent = isMinimized ? 'Mostrar POIs' : 'Ocultar POIs';
             }
         }
          // Función para manejar el botón de salto a coordenadas
         function jumpToCoords() {
            const latInput = document.getElementById('jumpto-lat');
            const lonInput = document.getElementById('jumpto-lon');
             if (!latInput || !lonInput || !map) return;
             const lat = parseFloat(latInput.value);
             const lon = parseFloat(lonInput.value);
             if (!isNaN(lat) && !isNaN(lon)) {
                map.setView([lat, lon], map.getZoom() > 15 ? map.getZoom() : 18); // Zoom in if needed
             } else {
                showMessage("Latitud o longitud inválida.", 3000);
             }
         }


    </script>
</body>
</html>



