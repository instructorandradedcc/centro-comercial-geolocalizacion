<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panel de Administración AR (Geolocalización)</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page {
            display: none; height: 100%; width: 100%;
            position: relative; overflow-y: auto; /* Allow scrolling on pages */
             padding-bottom: 60px; /* Add padding for controls */
        }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; } /* Map page should not scroll */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover:not(:disabled) { background-color: #45a049; } /* Added :not(:disabled) */
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.7; } /* Added opacity */

        
        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem;
            z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show { opacity: 1; }
        
        /* Estilos de Mapa y AR (adaptados) */
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-controls { position: fixed; top: 20px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px; }
        
        #map-crosshair {
            /* !important añadido para asegurar visibilidad */
            position: absolute !important; 
            top: 50% !important; 
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 30px !important; 
            height: 30px !important; 
            border: 2px solid white !important;
            border-radius: 50% !important; 
            box-shadow: 0 0 10px black, 0 0 0 2px rgba(0, 0, 0, 0.5) !important; /* Sombra doble para contraste */
            pointer-events: none !important; 
            z-index: 1000 !important; /* Aumentado z-index */
        }
        
        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center;
        }
        /* Nuevo: Panel para coordenadas del centro */
        #map-center-coords {
             position: fixed;
             top: 75px; /* Ajustado para no superponer */
             left: 20px;
             z-index: 402;
             background-color: rgba(0, 0, 0, 0.75); /* Más opaco */
             color: white;
             padding: 8px 12px;
             border-radius: 8px;
             font-size: 0.8rem;
             font-family: monospace;
             box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #map-center-coords span { display: block; } 

        /* Panels on Map */
        .map-panel {
             position: fixed;
             top: 80px; /* Adjust as needed */
             left: 10px;
             z-index: 401; /* Ligeramente debajo de coords y crosshair */
             background-color: rgba(255, 255, 255, 0.95);
             padding: 15px;
             border-radius: 8px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.2);
             max-width: 300px;
             width: 90%;
             max-height: calc(100vh - 180px); /* Adjust based on top/bottom spacing */
             overflow-y: auto;
             backdrop-filter: blur(5px);
        }
         #edit-location-panel {
             border: 2px solid #f59e0b; /* Orange border for editing */
         }
        /* Asegurar que el panel derecho se posicione correctamente */
         #placed-pois-panel {
            left: auto; /* Reset left positioning */
            right: 10px; /* Position on the right */
         }
         /* Estilo para la imagen previa en el panel */
         #placement-preview-image {
             max-width: 100px;
             max-height: 100px;
             margin: 10px auto; /* Centrar imagen */
             border: 1px solid #ccc;
             border-radius: 4px;
             display: none; /* Oculta por defecto */
             object-fit: contain; /* Para que la imagen no se deforme */
         }


        a-scene { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; }
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }
        
        #ar-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; }
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }
        .ar-loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10002; }
        .ar-loading-screen.active { display: flex; }
        
        /* Video AR styles */
        a-video { border: 2px solid white; background-color: black; }

        /* Correcciones de Video y Canvas AR */
        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; object-fit: cover !important;
            z-index: -1 !important; display: block !important; opacity: 1 !important;
            visibility: visible !important; autoplay: true !important;
            playsinline: true !important; webkit-playsinline: true !important;
            muted: true !important;
        }
        canvas, .a-canvas {
            background: transparent !important; background-color: rgba(0, 0, 0, 0) !important;
            z-index: 1 !important; position: fixed !important; top: 0 !important;
            left: 0 !important; width: 100% !important; height: 100% !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- PÁGINA 1: Panel de Administración (Selección de Modelos) -->
    <div id="admin-page" class="page active">
        <div class="container mx-auto p-6 max-w-4xl">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-blue-700">
                    Panel de Administración AR
                    <!-- 
                        ================================================
                        ¡¡¡ADVERTENCIA DE DESARROLLO - NO ELIMINAR!!!
                        El <span> de abajo muestra la versión de la app.
                        Es vital para el seguimiento de cambios.
                        ================================================
                    -->
                    <span id="version-display" class="text-sm align-middle font-normal text-gray-400 ml-2"></span>
                </h1>
                <div>
                    <!-- Botón deshabilitado inicialmente -->
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600" disabled>Ir al Mapa</button> 
                </div>
            </div>

            <!-- Sección de Selección de Modelos -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">1. Seleccionar Contenido para Colocar</h2>
                <p class="text-gray-600 mb-4">Marca los modelos o define el video que quieres posicionar en el mapa.</p>
                <div id="ecopiensa-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                     <p id="loading-models-placeholder" class="text-gray-500 col-span-full">Cargando modelos...</p>
                </div>
                <!-- Sección para Video (opcional) -->
                <div class="mt-4 pt-4 border-t">
                     <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                           <input type="checkbox" id="select-video-cb" class="h-5 w-5 text-blue-600">
                           <span>Añadir un Video Personalizado</span>
                     </label>
                </div>

                <h2 class="text-2xl font-semibold mt-6 mb-4">2. Ir al Mapa para Posicionar</h2>
                <p class="text-gray-600">El contenido que selecciones aquí estará disponible en el panel del mapa.</p>
            </div>

            <!-- Lista de POIs existentes (para eliminar) -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Contenido Geoposicionado Guardado</h2>
                <div id="poi-list-container" class="space-y-4">
                    <p id="loading-pois" class="text-gray-500 font-semibold">Inicializando Firebase...</p> 
                    <!-- Los POIs se insertarán aquí dinámicamente -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- PÁGINA 2: Vista de Mapa (Posicionar y Editar) -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div> <!-- Cruz central -->
        </div>

        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        
        <!-- Nuevo: Panel Coordenadas Centro -->
         <div id="map-center-coords">
             <span>Lat: --</span>
             <span>Lon: --</span>
         </div>


        <!-- Panel de Colocación (Izquierda) -->
        <div id="placement-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Colocar Nuevo Contenido</h3>
            <div id="models-to-place-list" class="space-y-2 mb-4">
                <p class="text-sm text-gray-500">No hay contenido nuevo seleccionado. Vuelve al Panel.</p>
                <!-- Botones para colocar modelos/video se insertarán aquí -->
            </div>
            
            <div class="slider-container mb-4">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="15" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            
            <div id="placement-form-container" class="hidden space-y-3">
                <h4 id="placing-model-name" class="font-semibold text-blue-600 text-center text-lg mb-2"></h4>
                
                 <!-- Nueva: Imagen Previa -->
                 <img id="placement-preview-image" src="" alt="Vista previa">

                <!-- Selector de Tipo -->
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Tipo de POI</label>
                     <select id="place-poi-type" class="mt-1 w-full p-2 border border-gray-300 rounded">
                         <option value="model" selected>Modelo 3D</option>
                         <option value="video">Video (.mp4)</option>
                     </select>
                 </div>

                <!-- Campos específicos por tipo -->
                 <div id="model-fields">
                     <div>
                         <label for="place-model-url" class="block text-sm font-medium text-gray-700">URL Modelo (.glb)</label>
                         <input type="url" id="place-model-url" class="mt-1 w-full p-2 border border-gray-300 rounded bg-gray-100" readonly>
                     </div>
                 </div>
                 <div id="video-fields" class="hidden"> 
                      <div>
                          <label for="place-video-url" class="block text-sm font-medium text-gray-700">URL Video (.mp4)</label>
                          <input type="url" id="place-video-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../video.mp4">
                      </div>
                 </div>

                 <!-- Campos Comunes -->
                <div>
                    <label for="place-name" class="block text-sm font-medium text-gray-700">Nombre Descriptivo</label>
                    <input type="text" id="place-name" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-scale" class="block text-sm font-medium text-gray-700">Escala (Video: ancho en metros)</label>
                    <input type="number" id="place-scale" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="1.0">
                </div>
                <div>
                    <label for="place-ground-height" class="block text-sm font-medium text-gray-700">Altura sobre terreno (m)</label>
                    <input type="number" id="place-ground-height" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="0.0">
                </div>
                <div>
                    <label for="place-sound-url" class="block text-sm font-medium text-gray-700">URL Sonido Fondo (Opcional, .mp3)</label>
                    <input type="url" id="place-sound-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../musica.mp3">
                </div>
                <div>
                    <label for="place-start-date" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                    <input type="date" id="place-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-end-date" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                    <input type="date" id="place-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                
                <p class="text-sm text-blue-600 font-semibold pt-2">Mueve el mapa para centrar la cruz en la ubicación deseada.</p>
                <button id="save-placement-btn" class="w-full bg-green-500 hover:bg-green-600 text-white p-2 rounded transition duration-300 font-bold">
                    Guardar Ubicación (en la Cruz)
                </button>
                <button id="cancel-placement-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300">Cancelar Colocación</button>
            </div>
        </div>
        
        <!-- Panel de POIs Guardados (Derecha) -->
         <div id="placed-pois-panel" class="map-panel right-3"> 
             <h3 class="text-lg font-semibold mb-2">Contenido en el Mapa</h3>
              <p class="text-xs text-amber-700 mb-2">Datos guardados en Firebase.</p>
             <div id="placed-pois-list" class="space-y-3">
                 <p class="text-sm text-gray-500">Cargando contenido guardado...</p>
                 <!-- Lista de POIs con botón de editar se insertará aquí -->
             </div>
         </div>
        
        <!-- Panel de Edición de Ubicación (Aparece al editar) -->
         <div id="edit-location-panel" class="map-panel hidden">
             <h3 class="text-lg font-semibold mb-2">Editando Ubicación</h3>
             <p id="editing-poi-name" class="text-sm font-medium text-gray-700 mb-2"></p>
             <p class="text-sm text-amber-700 font-semibold mb-3">Mueve el mapa para centrar la cruz en la NUEVA ubicación.</p>
             <button id="save-edit-location-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white p-2 rounded transition duration-300 font-bold mb-2">
                 Guardar Nueva Ubicación (en la Cruz)
             </button>
             <button id="cancel-edit-location-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300">
                 Cancelar Edición
             </button>
         </div>


        <div id="map-controls">
            <button id="back-to-admin-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Panel</button>
            <button id="goto-summary-btn" class="control-button bg-purple-500 hover:bg-purple-600">Ver Resumen</button> 
        </div>
    </div>

    <!-- PÁGINA 3: Resumen y Lanzamiento AR (NUEVA) -->
    <div id="summary-page" class="page">
         <div class="container mx-auto p-6 max-w-4xl">
             <div class="flex justify-between items-center mb-8">
                 <h1 class="text-3xl font-bold text-purple-700">Resumen de Configuración AR</h1>
                 <div>
                     <button id="back-to-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Mapa</button>
                     <button id="launch-ar-btn" class="control-button bg-green-500 hover:bg-green-600">¡Probar AR!</button> 
                 </div>
             </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold mb-4">Contenido Configurado</h2>
                  <p class="text-gray-600 mb-4">Este es el contenido que se mostrará en la Realidad Aumentada (si está dentro de las fechas activas).</p>
                 <div id="summary-poi-list" class="space-y-4">
                     <p id="loading-summary-pois" class="text-gray-500">Cargando resumen...</p>
                     <!-- Resumen de POIs se insertará aquí -->
                 </div>
             </div>
         </div>
    </div>


    <!-- PÁGINA 4: Vista de Realidad Aumentada -->
    <div id="ar-page" class="page">
        <!-- Pantalla de carga interactiva para AR -->
        <div id="ar-loading-screen" class="ar-loading-screen active">
            <div class="loading-content">
                <div class="loader"></div>
                <div id="loading-status-text" class="text-xl">Preparando componentes...</div>
            </div>
        </div>

        <div id="ar-scene-container"></div>
        
        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy" style="font-weight: bold;">--</span>m</div>
        </div>
        <div id="ar-controls">
            <button id="back-to-summary-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Resumen</button> 
        </div>
    </div>

    <!-- Modal para solicitar permisos -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h2>Permisos necesarios</h2>
            <p>Esta aplicación necesita acceso a tu cámara y ubicación para la experiencia de Realidad Aumentada.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder Permisos</button>
        </div>
    </div>

    <div id="message-box"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            deleteDoc,
            updateDoc, // Needed for editing location
            onSnapshot, 
            getDocs,
            query,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- Versión de la App ---
        // ¡¡¡ADVERTENCIA DE DESARROLLO - NO ELIMINAR!!!
        // Esta constante es vital para el seguimiento de cambios.
        // Incrementar en 0.01 por CADA cambio realizado al código.
        const APP_VERSION = '1.21'; // Reordenada inicialización y añadidas funciones de mapa

        // --- Modelos de ECOPIENSA (con imageUrl) ---
        const GITHUB_BASE_URL_MODELS = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/';
        const GITHUB_BASE_URL_IMAGES = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/'; 
        const ECOPIENSA_MODELS = [
            { name: 'Botellita Azul', modelUrl: `${GITHUB_BASE_URL_MODELS}botellytaazul.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}botellytaazul.jpg` },
            { name: 'Ecoladrillo', modelUrl: `${GITHUB_BASE_URL_MODELS}ecoladrillo.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}ecoladrillo.jpg` },
            { name: 'Lata Plateada', modelUrl: `${GITHUB_BASE_URL_MODELS}lataplateada.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}lataplateada.jpg` },
            { name: 'Papelito Verde', modelUrl: `${GITHUB_BASE_URL_MODELS}papelitoverde.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}papelitoverde.jpg` },
            { name: 'Señor Contenedor', modelUrl: `${GITHUB_BASE_URL_MODELS}senorcontenedor.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}senorcontenedor.jpg` },
            { name: 'Tapa Roja', modelUrl: `${GITHUB_BASE_URL_MODELS}taparoja.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}taparoja.jpg` }
        ];
        const CUSTOM_VIDEO_PLACEHOLDER = { name: "Video Personalizado", url: "CUSTOM_VIDEO", isCustomVideo: true, imageUrl: "https://placehold.co/100x100/764ba2/white?text=Video" }; 

        // --- Configuración de Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firebaseConfig = {
          apiKey: "AIzaSyBkxP7vqrVZMRhl-vUpHMMKjj5aIujDQ3k",
          authDomain: "centro-comercial-1ea64.firebaseapp.com",
          projectId: "centro-comercial-1ea64",
          storageBucket: "centro-comercial-1ea64.appspot.com", 
          messagingSenderId: "667808330264",
          appId: "1:667808330264:web:9718955b58aba4359b096d",
          measurementId: "G-3ZPG0Q8FL6"
        };

        let db, auth, userId, poiCollectionRef;
        let map;
        let poiMarkers = {}; 
        let allPoisData = []; 

        // --- Estado Global ---
        let modelsToPlace = []; 
        let isPlacingModel = false;
        let currentPlacingModel = {}; 
        let isEditingLocation = false; 
        let currentEditingPoiId = null; 
        let currentEditingMarker = null; 
        let firebaseReady = false; 

        // Variables AR
        let arScene = null;
        let gpsWatchId = null; 

        // --- Referencias a Elementos DOM ---
        let pages = {};
        let messageBox, permissionModal, arLoadingScreen, loadingStatusText, versionDisplay; 
        let listContainer, loadingPois, ecopiensaSelectionList, loadingModelsPlaceholder, selectVideoCheckbox;
        let placementPanel, modelsToPlaceList, placementFormContainer, placingModelName, cancelPlacementBtn, savePlacementBtn;
        let mapZoomSlider, jumptoBtn, placePoiTypeSelect, modelFieldsDiv, videoFieldsDiv, placeModelUrlInput, placeVideoUrlInput, placeNameInput;
        let placedPoisPanel, placedPoisList, editLocationPanel, editingPoiNameEl, saveEditLocationBtn, cancelEditLocationBtn;
        let summaryPoiList, loadingSummaryPois;
        let gotoMapButton; 
        let mapCenterCoordsEl; 
        let placementPreviewImageEl; 

        // --- Funciones ---

        function showMessage(msg, duration = 3000) {
            if (!messageBox) { console.warn("Message box not found"); return; }
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function navigateTo(pageName) {
            if ((pageName === 'map' || pageName === 'summary' || pageName === 'ar') && !firebaseReady) {
                showMessage("Aguarde un momento, conectando con la base de datos...", 3000);
                console.warn(`Attempt to navigate to ${pageName} before Firebase is ready.`);
                return; 
            }

            console.log(`Navigating to: ${pageName}`);
             if (Object.keys(pages).length === 0) { console.error("Pages object not populated."); return; }
            Object.values(pages).forEach(p => p.classList.remove('active'));
            if(pages[pageName]) {
                pages[pageName].classList.add('active');
                 console.log(`Page ${pageName} activated.`);
            } else {
                 console.error(`Page not found: ${pageName}. Falling back to admin.`);
                 if (pages.admin) pages.admin.classList.add('active'); 
                 return;
            }

            // Page specific logic
            if (pageName === 'map') {
                 stopAR(); 
                setTimeout(initMap, 100); 
            } else if (pageName === 'summary') {
                 stopAR(); 
                 stopMap(); 
                 populateSummaryPage(); 
            } else if (pageName === 'ar') {
                 stopMap(); 
                startARFlow(); 
            } else if (pageName === 'admin') {
                stopAR();
                stopMap();
                 initializeModelSelection(); 
                 loadAndDisplayPois(); 
            }
        }

        function stopMap() {
            if (map) {
                 map.off('move', updateCenterCoordsDisplay);
                map.remove(); 
                map = null;
                 Object.values(poiMarkers).forEach(marker => marker.remove());
                 poiMarkers = {}; 
                console.log("Map stopped and removed.");
            }
             isPlacingModel = false;
             isEditingLocation = false;
             currentEditingPoiId = null;
             currentEditingMarker = null;
        }


        // --- Firebase Logic ---
        async function initializeFirebase() { 
            console.log("Initializing Firebase with provided config..."); 
            if (loadingPois) loadingPois.textContent = "Inicializando conexión Firebase...";
            if (gotoMapButton) gotoMapButton.disabled = true; 

            if (!firebaseConfig || firebaseConfig.apiKey === "TU_API_KEY" || !firebaseConfig.projectId || firebaseConfig.projectId === "TU_PROYECTO_ID") {
                 console.error("Firebase Config Error: La configuración manual 'firebaseConfig' parece tener los valores de ejemplo. Por favor, pega tu configuración real.");
                 firebaseReady = false;
                 if (gotoMapButton) gotoMapButton.disabled = true;
                 const errorMsg = "Error fatal: Configuración de Firebase inválida. Revisa el código y pega tus credenciales.";
                 if(loadingPois) loadingPois.textContent = errorMsg;
                 showMessage(errorMsg, 10000); 
                 return; 
            }
            
            try {
                 console.log("Calling initializeApp with manual config...");
                 const app = initializeApp(firebaseConfig);
                 console.log("Firebase App initialized.");
                 db = getFirestore(app);
                 auth = getAuth(app);
                 console.log("Firestore and Auth services obtained.");
                 setLogLevel('Debug'); 
                 
                 onAuthStateChanged(auth, async (user) => {
                     console.log("Auth state changed. User:", user ? user.uid : 'null');
                     if (user) {
                         userId = user.uid;
                         console.log('Firebase User Authenticated:', userId);
                         const currentAppId = appId === 'default-app-id' ? (firebaseConfig.appId || 'default-app-id') : appId; 
                         const collectionPath = `/artifacts/${currentAppId}/public/data/pois`;
                         poiCollectionRef = collection(db, collectionPath);
                         console.log('POI Collection configured:', collectionPath);
                         
                         firebaseReady = true; 
                         if (gotoMapButton) {
                              gotoMapButton.disabled = false; 
                              console.log("GoToMap button enabled.");
                         }
                         if (loadingPois && (loadingPois.textContent.startsWith("Conectando") || loadingPois.textContent.startsWith("Inicializando"))) { 
                              loadingPois.textContent = "Conexión exitosa. Cargando POIs..."; 
                         }
                         showMessage("Conectado a la base de datos.", 2000); 
                         
                         loadAndListenPois(); 
                     } else {
                         userId = null;
                         poiCollectionRef = null;
                         firebaseReady = false; 
                         if (gotoMapButton) gotoMapButton.disabled = true; 
                         if (listContainer) listContainer.innerHTML = '<p class="text-red-500 font-semibold">Error: Autenticación fallida o cerrada.</p>';
                         allPoisData = []; 
                         console.error("Firebase User signed out or failed authentication.");
                         showMessage("Error de autenticación con Firebase. No se pueden cargar datos.", 5000);
                     }
                 });
                 console.log("Auth state listener attached.");

                 try {
                     if (initialAuthToken) {
                          console.log("Attempting sign in with custom token...");
                         await signInWithCustomToken(auth, initialAuthToken);
                         console.log("Signed in with custom token.");
                     } else {
                          console.log("Attempting anonymous sign in...");
                         await signInAnonymously(auth);
                          console.log("Signed in anonymously.");
                     }
                 } catch (authError) {
                      console.error("Auth Error:", authError);
                      firebaseReady = false;
                      if (gotoMapButton) gotoMapButton.disabled = true;
                      let detailedErrorMsg = `Error de Autenticación: ${authError.code || authError.message}`;
                      if (authError.code === 'auth/configuration-not-found') {
                           detailedErrorMsg += " (Verifica que 'Anónimo' esté habilitado en Firebase Authentication > Sign-in method)";
                      } else if (authError.message.includes("network")) {
                            detailedErrorMsg += " (Problema de red)";
                      } else if (authError.code === 'auth/admin-restricted-operation') {
                           detailedErrorMsg += " (Operación restringida. Habilita 'Anónimo' en Firebase Auth y revisa los dominios autorizados)";
                      }
                      if (loadingPois) loadingPois.textContent = detailedErrorMsg;
                      showMessage(detailedErrorMsg, 8000); 
                 }

            } catch (initError) {
                console.error("Firebase Init Error:", initError);
                firebaseReady = false; 
                if (gotoMapButton) gotoMapButton.disabled = true;
                const errorMsg = `Error fatal al inicializar Firebase: ${initError.message}. Verifica la configuración manual y la conexión a internet.`;
                if(loadingPois) loadingPois.textContent = errorMsg;
                 showMessage(errorMsg, 10000); 
            }
        }

        // --- UI Initialization and Population ---

        function displayAppVersion() {
             if (versionDisplay) {
                 versionDisplay.textContent = `v${APP_VERSION}`;
                  console.log(`App Version ${APP_VERSION} displayed.`);
             } else {
                  console.warn("Version display element not found.");
             }
        }


        function initializeModelSelection() {
             console.log("Initializing model selection UI..."); 
             if (!ecopiensaSelectionList || !loadingModelsPlaceholder || !selectVideoCheckbox) {
                  console.error("Required elements for model selection not found.");
                  return; 
             }

            loadingModelsPlaceholder.style.display = 'none'; 
            
            if (ecopiensaSelectionList.children.length <= 1) { 
                ecopiensaSelectionList.innerHTML = ''; 
                ECOPIENSA_MODELS.forEach(model => {
                    const isSelected = modelsToPlace.some(m => !m.isCustomVideo && m.url === model.modelUrl); // Usar modelUrl
                    createCheckbox(model.name, model.modelUrl, isSelected, false, model.imageUrl); // Pasar imageUrl
                });
                 console.log("Model checkboxes created.");
            } else {
                 console.log("Model checkboxes already exist, updating states.");
                 const checkboxes = ecopiensaSelectionList.querySelectorAll('.model-select-cb');
                 checkboxes.forEach(cb => {
                      const url = cb.dataset.url;
                      if (url !== CUSTOM_VIDEO_PLACEHOLDER.url) { 
                           cb.checked = modelsToPlace.some(m => m.url === url);
                      }
                 });
            }
            
            selectVideoCheckbox.removeEventListener('change', handleVideoCheckboxChange);
            selectVideoCheckbox.addEventListener('change', handleVideoCheckboxChange);
            selectVideoCheckbox.checked = modelsToPlace.some(m => m.isCustomVideo);

             console.log("Model/Video checkbox UI initialized/updated.");
        }
        
        function createCheckbox(name, url, isChecked, isVideoPlaceholder = false, imageUrl = '') {
             if (!ecopiensaSelectionList) return; 

             const label = document.createElement('label');
             label.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer';
             const input = document.createElement('input');
             input.type = 'checkbox';
             input.className = 'model-select-cb h-5 w-5 text-blue-600';
             input.dataset.name = name;
             input.dataset.url = url; 
             input.checked = isChecked;
             input.dataset.imageUrl = imageUrl; // Añadir imageUrl al dataset
             if (isVideoPlaceholder) {
                 input.dataset.isCustomVideo = "true";
             }
             
             input.removeEventListener('change', handleCheckboxChange); 
             input.addEventListener('change', handleCheckboxChange); 

             const span = document.createElement('span');
             span.textContent = name;
             
             label.appendChild(input);
             label.appendChild(span);
             ecopiensaSelectionList.appendChild(label);
        }

         function handleVideoCheckboxChange(e) {
             const placeholderExists = modelsToPlace.some(m => m.isCustomVideo);
             if (e.target.checked) {
                 if (!placeholderExists) {
                     modelsToPlace.push({...CUSTOM_VIDEO_PLACEHOLDER});
                 }
             } else {
                 if (placeholderExists) {
                     modelsToPlace = modelsToPlace.filter(m => !m.isCustomVideo);
                 }
             }
             console.log("Models to place (video toggle):", modelsToPlace);
         }

        function handleCheckboxChange(e) {
             const itemData = { 
                 name: e.target.dataset.name, 
                 url: e.target.dataset.url, 
                 isCustomVideo: e.target.dataset.isCustomVideo === "true",
                 imageUrl: e.target.dataset.imageUrl || '' // Obtener imageUrl
             };
             const itemExists = modelsToPlace.some(m => m.url === itemData.url); 
             
             if (e.target.checked) {
                 if (!itemExists) {
                     modelsToPlace.push(itemData);
                 }
             } else {
                 if (itemExists) {
                     modelsToPlace = modelsToPlace.filter(m => m.url !== itemData.url);
                 }
             }
             console.log("Models to place updated:", modelsToPlace);
         }


        function loadAndListenPois() {
             if (!poiCollectionRef) { 
                  console.warn("loadAndListenPois called before poiCollectionRef is set.");
                  if (loadingPois && !loadingPois.textContent.toLowerCase().includes("error")) loadingPois.textContent = "Esperando configuración de base de datos...";
                  return; 
             }
             if (!listContainer || !loadingPois) { 
                  console.error("loadAndListenPois called but listContainer or loadingPois element not found.");
                  return; 
             }
            
            if (loadingPois && !loadingPois.textContent.toLowerCase().includes("error")) {
                 loadingPois.textContent = "Cargando puntos guardados..."; 
                 loadingPois.style.display = 'block'; 
            }
            const q = query(poiCollectionRef);
            
            onSnapshot(q, (querySnapshot) => {
                 if (!listContainer || !loadingPois) return; 
                
                loadingPois.style.display = 'none'; 
                allPoisData = []; 
                listContainer.innerHTML = ''; 

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">No hay contenido guardado en Firebase.</p>';
                     if (map && pages.map.classList.contains('active')) {
                          updateMapMarkersAndPlacedList();
                     }
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const poi = { id: doc.id, ...doc.data() }; 
                    allPoisData.push(poi); 

                    const poiElement = document.createElement('div');
                    poiElement.className = 'poi-item p-4 border border-gray-200 rounded-lg shadow-sm grid grid-cols-2 md:grid-cols-4 gap-4 items-center';
                    let typeLabel = poi.poiType === 'video' ? 'Video' : 'Modelo 3D';
                    let urlToShow = poi.poiType === 'video' ? (poi.videoUrl || 'N/A') : (poi.modelUrl || 'N/A');
                     if (urlToShow.length > 30) urlToShow = urlToShow.substring(0, 27) + '...'; 

                    poiElement.innerHTML = `
                        <div>
                            <strong class="block text-sm text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                            <span class="block text-xs ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                            <span class="block text-xs text-gray-500" title="${poi.poiType === 'video' ? poi.videoUrl : poi.modelUrl}">URL: ${urlToShow}</span>
                        </div>
                        <div class="text-sm">
                            <span class="block">Lat: ${poi.lat?.toFixed(6) || 'N/A'}</span>
                            <span class="block">Lon: ${poi.lon?.toFixed(6) || 'N/A'}</span>
                        </div>
                        <div class="text-sm">
                            <span class="block">Inicia: ${poi.startDate || 'N/A'}</span>
                            <span class="block">Termina: ${poi.endDate || 'N/A'}</span>
                        </div>
                        <div class="text-right">
                            <button data-id="${poi.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300">
                                Eliminar
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(poiElement);
                });
                 console.log(`Cache local 'allPoisData' actualizado con ${allPoisData.length} POIs.`);
                 if (map && pages.map.classList.contains('active')) {
                      updateMapMarkersAndPlacedList();
                 }

            }, (error) => {
                console.error("Error al escuchar POIs (Firestore):", error);
                 if (loadingPois) loadingPois.style.display = 'none'; 
                 if (listContainer) listContainer.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar datos de Firestore: ${error.message}. Verifica las reglas de seguridad y la conexión.</p>`;
                allPoisData = []; 
                 showMessage("Error al actualizar la lista de contenido.", 5000);
            });
        }
        
        // --- Map Logic (Page 2) ---
        
        function initMap() {
             console.log("Initializing Map..."); 
            if (!firebaseReady || !poiCollectionRef) { 
                 showMessage("La base de datos no está lista. Por favor espere...", 3000);
                 console.warn("Attempted to initMap before Firebase was ready.");
                 return; 
            }
             if (map) { 
                 console.log("Map already exists. Invalidating size.");
                 setTimeout(() => { if (map) map.invalidateSize(); }, 100); 
                 populatePlacementPanel(); 
                 populatePlacedPoisPanel(); 
                 return; 
             }

            const mapContainer = document.getElementById('map-canvas');
             if (!mapContainer) { console.error("Map container element not found."); return; }
            const defaultCenter = [4.0835, -76.1915]; 
            map = L.map(mapContainer, { zoomControl: false, preferCanvas: true }).setView(defaultCenter, 15);

            L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 22, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: 'Imagery &copy;2025 Google' }).addTo(map);

            updateMapMarkersAndPlacedList(); 

            populatePlacementPanel(); 
            cancelPlacement(); 
            cancelEditLocation(); 

            // Listener para actualizar display de coords del centro
            map.off('move', updateCenterCoordsDisplay); // Quitar previo
            map.on('move', updateCenterCoordsDisplay); 
            updateCenterCoordsDisplay(); // Llamar una vez
            console.log("Map 'move' listener attached for center coords display."); 

            // Zoom slider sync
            if (mapZoomSlider) { 
                 mapZoomSlider.value = map.getZoom();
                 mapZoomSlider.removeEventListener('input', handleZoomSlider); 
                 mapZoomSlider.addEventListener('input', handleZoomSlider);
            }
            map.off('zoomend', handleMapZoomEnd); 
            map.on('zoomend', handleMapZoomEnd);
            
            // Jump to coords button
            if (jumptoBtn) { 
                 jumptoBtn.removeEventListener('click', jumpToCoords); 
                 jumptoBtn.addEventListener('click', jumpToCoords);
             }

            // POI Type Selector listener
            if (placePoiTypeSelect) { 
                 placePoiTypeSelect.removeEventListener('change', handlePoiTypeChange);
                 placePoiTypeSelect.addEventListener('change', handlePoiTypeChange);
                 handlePoiTypeChange(); 
             }

            setTimeout(() => { if (map) map.invalidateSize(); }, 200); 
            console.log("Map initialization complete.");
        }
        
         function updateCenterCoordsDisplay() {
             // console.log("Map moved, updating coords display..."); // Log frecuente
             if (map && mapCenterCoordsEl) {
                 const center = map.getCenter();
                 mapCenterCoordsEl.innerHTML = `
                     <span>Lat: ${center.lat.toFixed(6)}</span>
                     <span>Lon: ${center.lng.toFixed(6)}</span>
                 `;
             } else if (!mapCenterCoordsEl) {
                  if (typeof mapCenterCoordsEl === 'undefined' || mapCenterCoordsEl === null) {
                       // Evitar loguear repetidamente si el elemento no existe
                       if(!window.mapCenterCoordsElWarned) {
                           console.warn("mapCenterCoordsEl not found during update.");
                           window.mapCenterCoordsElWarned = true; // Marcar que ya se advirtió
                       }
                  }
             }
         }

        // Dibuja/actualiza marcadores y lista derecha desde allPoisData
        function updateMapMarkersAndPlacedList() {
             if (!map || !placedPoisList) {
                  console.warn("Cannot update map markers/list: Map or list element not ready.");
                  return;
             }
             console.log("Updating map markers and placed POIs list from local cache...");
             
             Object.values(poiMarkers).forEach(marker => {
                  if (map.hasLayer(marker)) map.removeLayer(marker);
             });
             poiMarkers = {}; 
             placedPoisList.innerHTML = ''; 
             
             let hasPois = false;
             allPoisData.forEach(poi => { 
                 hasPois = true;
                 if (typeof poi.lat === 'number' && typeof poi.lon === 'number') {
                      let iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png'; 
                      if (poi.poiType === 'video') {
                           iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png'; 
                      }
                     const marker = L.marker([poi.lat, poi.lon], { 
                          icon: L.icon({
                               iconUrl: iconUrl,
                               shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                               iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                          })
                     })
                         .addTo(map)
                         .bindPopup(`<b>${poi.name || 'No Name'}</b> (${poi.poiType || 'model'})`);
                     poiMarkers[poi.id] = marker; 
                 } else { console.warn("POI for map missing coordinates:", poi.id); }
                 
                 const listItem = document.createElement('div');
                 listItem.className = 'placed-poi-item p-2 border-b flex justify-between items-center';
                 listItem.innerHTML = `
                     <span class="text-sm font-medium">${poi.name || 'No Name'}</span>
                     <button data-id="${poi.id}" class="edit-location-btn bg-amber-500 hover:bg-amber-600 text-white text-xs px-2 py-1 rounded">
                         Edit Loc.
                     </button>
                 `;
                 const editBtn = listItem.querySelector('.edit-location-btn');
                 editBtn.removeEventListener('click', handleEditLocationClick);
                 editBtn.addEventListener('click', handleEditLocationClick);
                 placedPoisList.appendChild(listItem);
             });
             
             if (!hasPois) {
                  placedPoisList.innerHTML = '<p class="text-sm text-gray-500">No content saved on map yet.</p>';
             }
             console.log(`Updated ${Object.keys(poiMarkers).length} markers and placed POIs panel.`);
        }


        function handlePoiTypeChange() {
             if (!placePoiTypeSelect || !modelFieldsDiv || !videoFieldsDiv || !placeModelUrlInput || !placeVideoUrlInput) { console.error("POI type change handler missing required form elements."); return; }
             const selectedType = placePoiTypeSelect.value;
             const isVideo = selectedType === 'video';
             
             modelFieldsDiv.classList.toggle('hidden', isVideo);
             videoFieldsDiv.classList.toggle('hidden', !isVideo); 
             
             placeModelUrlInput.disabled = isVideo;
             placeVideoUrlInput.disabled = !isVideo;

             const scaleLabel = document.querySelector('label[for="place-scale"]');
             if (scaleLabel) { scaleLabel.textContent = isVideo ? 'Video Width (meters)' : 'Model Scale'; }
        }


        // --- Location Editing Functions ---
         function handleEditLocationClick(e) {
             const poiId = e.target?.dataset?.id; 
             if (poiId) { startEditLocation(poiId); } 
             else { console.error("Could not get POI ID from edit button."); }
        }

        function startEditLocation(poiId) {
             if (isPlacingModel) cancelPlacement(); 
             if (!allPoisData || allPoisData.length === 0) { showMessage("POI data not loaded yet.", 3000); return; }
             const poiData = allPoisData.find(p => p.id === poiId);
             const marker = poiMarkers[poiId];
             if (!poiData || !marker) { showMessage("Error: Could not find POI data or marker.", 4000); return; }
             if (!map) { showMessage("Map is not initialized.", 3000); return; }

             isEditingLocation = true;
             currentEditingPoiId = poiId;
             currentEditingMarker = marker; 

             if (editingPoiNameEl) editingPoiNameEl.textContent = `Moving: ${poiData.name || 'No Name'}`;
             if (placementPanel) placementPanel.classList.add('hidden');
             if (placedPoisPanel) placedPoisPanel.classList.add('hidden');
             if (editLocationPanel) editLocationPanel.classList.remove('hidden');

             map.setView(marker.getLatLng(), 19); 
             showMessage("Edit Mode: Move map and save new location.", 4000);
        }

        function cancelEditLocation() {
             isEditingLocation = false;
             currentEditingPoiId = null;
             currentEditingMarker = null;
             if (placementPanel) placementPanel.classList.remove('hidden');
             if (placedPoisPanel) placedPoisPanel.classList.remove('hidden');
             if (editLocationPanel) editLocationPanel.classList.add('hidden');
        }
        
        async function handleSaveEditLocation() {
             if (!isEditingLocation || !map || !poiCollectionRef || !currentEditingPoiId || !saveEditLocationBtn) { return; }

             const newLatLng = map.getCenter(); 
             showMessage('Updating location...', 2000);
             saveEditLocationBtn.disabled = true;
             saveEditLocationBtn.textContent = 'Saving...';

             try {
                 const docRef = doc(db, poiCollectionRef.path, currentEditingPoiId);
                 await updateDoc(docRef, { lat: newLatLng.lat, lon: newLatLng.lng });
                 showMessage('Location updated successfully!', 3000);
                 cancelEditLocation(); 
             } catch (error) {
                 console.error("Error updating location:", error);
                 showMessage("Error saving new location.", 5000);
             } finally {
                  if (saveEditLocationBtn) { 
                      saveEditLocationBtn.disabled = false;
                      saveEditLocationBtn.textContent = 'Save New Location (at Crosshair)';
                  }
             }
        }

        function handleZoomSlider(e) { if (map) map.setZoom(parseFloat(e.target.value)); }
        function handleMapZoomEnd() { if (map && mapZoomSlider) mapZoomSlider.value = map.getZoom(); }
        function jumpToCoords() { 
            const latInput = document.getElementById('jumpto-lat');
            const lonInput = document.getElementById('jumpto-lon');
             if (!latInput || !lonInput) return; 
            const lat = parseFloat(latInput.value);
            const lon = parseFloat(lonInput.value);
            if (isNaN(lat) || isNaN(lon) || !map) { showMessage("Please enter valid latitude and longitude.", 3000); return; }
            map.setView([lat, lon], 18); 
         }

        async function populatePlacementPanel() {
             if (!firebaseReady || !poiCollectionRef || !modelsToPlaceList) { /* ... */ return; }
            
            modelsToPlaceList.innerHTML = ''; 
            try {
                const placedContentIdentifiers = new Set(); 
                 allPoisData.forEach(poi => {
                     if (poi.poiType === 'video') placedContentIdentifiers.add(CUSTOM_VIDEO_PLACEHOLDER.url); 
                     else if (poi.modelUrl) placedContentIdentifiers.add(poi.modelUrl);
                 });

                const unplacedContent = modelsToPlace.filter(item => !placedContentIdentifiers.has(item.url));

                if (unplacedContent.length === 0) { 
                    modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">All selected content is already placed, or none selected. Return to Panel.</p>';
                    return; 
                }

                unplacedContent.forEach((item) => {
                    const currentIndex = modelsToPlace.findIndex(m => m.url === item.url); 
                    if (currentIndex === -1) { /* ... */ return; } 

                    const button = document.createElement('button'); 
                    button.className = 'place-btn control-button bg-blue-500 hover:bg-blue-600 w-full text-left'; 
                    button.textContent = `Place ${item.name}`; 
                    button.dataset.name = item.name; 
                    button.dataset.url = item.url; 
                    button.dataset.index = currentIndex; 
                    button.dataset.imageUrl = item.imageUrl || ''; // Usar imageUrl del item
                    if (item.isCustomVideo) { button.dataset.isCustomVideo = "true"; }
                    
                    button.removeEventListener('click', handlePlaceButtonClick); 
                    button.addEventListener('click', handlePlaceButtonClick); 
                    
                    modelsToPlaceList.appendChild(button); 
                });
            } catch (error) { /* ... */ }
        }
        
        function handlePlaceButtonClick(e) { startPlacement(e.target.dataset); }

        function startPlacement(itemData) {
             console.log("Starting placement for:", itemData); 
             const index = parseInt(itemData.index);
             const isCustomVideo = itemData.isCustomVideo === "true";
             
             if (isNaN(index) || index < 0 || index >= modelsToPlace.length) { /* ... */ return; }
             if (modelsToPlace[index].isCustomVideo !== isCustomVideo || modelsToPlace[index].url !== itemData.url) { /* ... */ return; }

            isPlacingModel = true;
            currentPlacingModel = { ...modelsToPlace[index], originalIndex: index }; 

             if (placingModelName) placingModelName.textContent = `Placing: ${currentPlacingModel.name}`;
            
            // Mostrar imagen previa
             if (placementPreviewImageEl && itemData.imageUrl) {
                 console.log("Setting preview image:", itemData.imageUrl);
                 placementPreviewImageEl.src = itemData.imageUrl;
                 placementPreviewImageEl.style.display = 'block';
                 placementPreviewImageEl.onerror = () => { 
                      console.warn("Could not load preview image:", itemData.imageUrl);
                      placementPreviewImageEl.style.display = 'none'; 
                      placementPreviewImageEl.onerror = null; 
                 };
             } else if(placementPreviewImageEl) {
                  console.log("No preview image URL found for this item.");
                  placementPreviewImageEl.style.display = 'none'; 
             } else {
                  console.warn("placementPreviewImageEl not found.");
             }

             if (placePoiTypeSelect) { 
                 placePoiTypeSelect.value = isCustomVideo ? 'video' : 'model';
                 handlePoiTypeChange(); 
             }
             if (placeNameInput) placeNameInput.value = currentPlacingModel.name; 
             if (placeModelUrlInput) placeModelUrlInput.value = isCustomVideo ? '' : currentPlacingModel.url;
             if (placeVideoUrlInput) placeVideoUrlInput.value = ''; 
             const soundUrlInput = document.getElementById('place-sound-url');
             if (soundUrlInput) soundUrlInput.value = '';
             const scaleInput = document.getElementById('place-scale');
             if (scaleInput) scaleInput.value = '1.0';
             const heightInput = document.getElementById('place-ground-height');
             if (heightInput) heightInput.value = '0.0';
            
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0];
             const startDateInput = document.getElementById('place-start-date');
             if (startDateInput) startDateInput.value = today;
             const endDateInput = document.getElementById('place-end-date');
             if (endDateInput) endDateInput.value = nextMonth;


            if (modelsToPlaceList) modelsToPlaceList.classList.add('hidden'); 
            if (placementFormContainer) placementFormContainer.classList.remove('hidden'); 
            
            showMessage(`Move map and press 'Save Location'`);
        }


        function cancelPlacement() { 
            isPlacingModel = false;
            currentPlacingModel = {};
            if (modelsToPlaceList) modelsToPlaceList.classList.remove('hidden'); 
            if (placementFormContainer) placementFormContainer.classList.add('hidden'); 
            if (placementPreviewImageEl) placementPreviewImageEl.style.display = 'none'; 
             console.log("Placement cancelled.");
        }
        

        async function handleSavePlacement() { 
            if (!isPlacingModel || !map || !poiCollectionRef || !savePlacementBtn) { return; }

            const latlng = map.getCenter(); 
            showMessage('Saving...', 2000); 
            savePlacementBtn.disabled = true; 
            savePlacementBtn.textContent = 'Saving...'; 

            try {
                 if (!currentPlacingModel || typeof currentPlacingModel.originalIndex !== 'number') { throw new Error("Internal error: Missing data..."); }

                 const poiType = placePoiTypeSelect.value;
                 let modelUrl = '';
                 let videoUrl = '';
                 let name = placeNameInput.value.trim(); 

                 if (!name) throw new Error("Descriptive name is required.");

                 if (poiType === 'video') { 
                     videoUrl = placeVideoUrlInput.value.trim();
                     if (!videoUrl) throw new Error("Video URL is required for Video type.");
                     if (!videoUrl.startsWith('http') || !videoUrl.toLowerCase().endsWith('.mp4')) {
                          console.warn("Video URL format might be invalid:", videoUrl);
                     }
                      modelUrl = ''; 
                 } else { 
                     modelUrl = placeModelUrlInput.value.trim(); 
                     if (!modelUrl) throw new Error("Model URL is required for Model 3D type.");
                      videoUrl = ''; 
                 }

                const newPoi = { 
                    name: name, 
                    poiType: poiType, 
                    modelUrl: modelUrl, 
                    videoUrl: videoUrl, 
                    soundUrl: document.getElementById('place-sound-url')?.value.trim() || "", 
                    lat: latlng.lat,
                    lon: latlng.lng,
                    scale: parseFloat(document.getElementById('place-scale')?.value || "1.0"), 
                    groundHeight: parseFloat(document.getElementById('place-ground-height')?.value || "0.0"), 
                    startDate: document.getElementById('place-start-date')?.value || "", 
                    endDate: document.getElementById('place-end-date')?.value || "" 
                };

                // Validation
                if (isNaN(newPoi.scale) || isNaN(newPoi.groundHeight)) throw new Error("Scale/Height must be valid numbers.");
                if (newPoi.scale <= 0) throw new Error("Scale must be positive.");
                if (!newPoi.startDate || !newPoi.endDate) throw new Error("Start and End dates are required.");
                const startDate = new Date(newPoi.startDate);
                const endDate = new Date(newPoi.endDate);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) throw new Error("Invalid date format.");
                if (endDate < startDate) throw new Error("End date cannot be before start date.");

                await addDoc(poiCollectionRef, newPoi); 
                
                showMessage(`'${newPoi.name}' saved successfully!`, 3000); 

                // --- Remove from 'modelsToPlace' and uncheck checkbox ---
                 const indexToRemove = currentPlacingModel.originalIndex;
                 if (indexToRemove >= 0 && indexToRemove < modelsToPlace.length) {
                       if (modelsToPlace[indexToRemove]?.url === currentPlacingModel.url) {
                            const removedItem = modelsToPlace.splice(indexToRemove, 1)[0];
                            let checkboxSelector = removedItem.isCustomVideo 
                                 ? '#select-video-cb' 
                                 : `.model-select-cb[data-url="${removedItem.url}"]`;
                            const checkbox = document.querySelector(checkboxSelector);
                            if (checkbox) checkbox.checked = false;
                            console.log("Item removed from modelsToPlace:", removedItem.name);
                       } else { 
                            console.error("Index mismatch when removing placed item. Array may have shifted.");
                            modelsToPlace = modelsToPlace.filter(m => m.url !== currentPlacingModel.url);
                       }
                 } else { 
                      console.error("Invalid original index found when trying to remove placed item:", indexToRemove);
                       modelsToPlace = modelsToPlace.filter(m => m.url !== currentPlacingModel.url);
                 }

                populatePlacementPanel(); 
                cancelPlacement(); 

            } catch (error) { 
                 console.error("Error saving POI: ", error);
                 showMessage("Error saving: " + error.message, 5000);
            } finally { 
                 if (savePlacementBtn) { 
                    savePlacementBtn.disabled = false; 
                    savePlacementBtn.textContent = 'Save Location (at Crosshair)'; 
                 }
            }
         }
         
         function populateSummaryPage() {
             console.log("Populating Summary Page..."); 
             if (!firebaseReady || !poiCollectionRef || !summaryPoiList || !loadingSummaryPois) { 
                  console.warn("Cannot populate summary: Firebase not ready or DOM elements missing.");
                  if(loadingSummaryPois) loadingSummaryPois.textContent = "Waiting for database connection...";
                  if(summaryPoiList) summaryPoiList.innerHTML = ''; 
                  return; 
             }
            
            loadingSummaryPois.textContent = "Loading summary...";
             loadingSummaryPois.style.display = 'block';
             summaryPoiList.innerHTML = ''; 

             // Use local cache 'allPoisData'
             if (allPoisData.length === 0) {
                 loadingSummaryPois.style.display = 'none';
                 summaryPoiList.innerHTML = '<p class="text-gray-500">No configured content to display.</p>';
                 console.log("Summary populated: No POIs found.");
                 return;
             }

             loadingSummaryPois.style.display = 'none';
             allPoisData.forEach(poi => {
                 const summaryElement = document.createElement('div');
                 summaryElement.className = 'p-4 border rounded-lg grid grid-cols-3 gap-3';
                 let typeLabel = poi.poiType === 'video' ? 'Video' : 'Model 3D';
                 summaryElement.innerHTML = `
                     <div>
                         <strong class="block text-gray-800">${poi.name || 'No Name'}</strong>
                         <span class="text-sm ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                     </div>
                     <div class="text-sm text-gray-600">
                         <span class="block">Lat: ${poi.lat?.toFixed(5) || 'N/A'}</span>
                         <span class="block">Lon: ${poi.lon?.toFixed(5) || 'N/A'}</span>
                         <span class="block">Scale: ${poi.scale || 1} ${poi.poiType === 'video' ? 'm width' : ''}</span>
                         <span class="block">Height: ${poi.groundHeight || 0}m</span>
                     </div>
                     <div class="text-sm text-gray-600">
                          <span class="block">Starts: ${poi.startDate || 'N/A'}</span>
                          <span class="block">Ends: ${poi.endDate || 'N/A'}</span>
                          ${poi.soundUrl ? '<span class="block text-green-600">♪ With Sound</span>' : ''}
                     </div>
                 `;
                 summaryPoiList.appendChild(summaryElement);
             });
                 console.log(`Summary populated with ${allPoisData.length} POIs.`);
         }

         async function startARFlow() { 
             console.log("Starting AR Flow..."); 
             if (!pages.ar.classList.contains('active')) return; 
             if (!arLoadingScreen || !loadingStatusText) return;
             
             arLoadingScreen.classList.add('active');
             loadingStatusText.textContent = 'Requesting permissions...';
             
             try {
                  console.log("Requesting camera permissions...");
                  await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                  console.log("Camera permission granted.");
                  
                  console.log("Requesting initial GPS position...");
                  loadingStatusText.textContent = 'Getting initial GPS...';
                  await new Promise((resolve, reject) => { 
                      let watchId;
                      const timeoutId = setTimeout(() => { 
                           navigator.geolocation.clearWatch(watchId);
                           reject(new Error("Timeout getting initial GPS. Try again in an open area."));
                       }, 20000); 

                      watchId = navigator.geolocation.watchPosition(
                          (position) => { 
                               console.log(`GPS reading: Accuracy ${position.coords.accuracy}m`);
                               loadingStatusText.textContent = `Getting GPS (${position.coords.accuracy.toFixed(0)}m)...`;
                               if (position.coords.accuracy < 30) { 
                                   clearTimeout(timeoutId);
                                   navigator.geolocation.clearWatch(watchId);
                                   console.log("Initial GPS lock acquired.");
                                   resolve(position);
                               } 
                           },
                          (error) => { 
                               clearTimeout(timeoutId);
                               navigator.geolocation.clearWatch(watchId);
                               console.error("Error getting initial GPS:", error);
                               reject(error); 
                           },
                          { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 } 
                      );
                   });

                 loadingStatusText.textContent = 'Loading AR scene...';
                 console.log("Initializing AR Scene...");
                 await initializeARScene();

             } catch (error) { 
                  console.error('Error starting AR Flow:', error);
                  if (arLoadingScreen) arLoadingScreen.classList.remove('active');
                  navigateTo('summary'); 
                  let userMsg = "Error starting AR: " + error.message;
                   if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                       userMsg = "Camera and GPS access are required for AR.";
                   } else if (error.code === error.TIMEOUT || error.message.includes("Timeout")) {
                        userMsg = "Could not get an accurate GPS signal. Please try again in an open area.";
                   } else if (error.code === 1) { 
                        userMsg = "GPS permission denied. Please enable location services.";
                   }
                  showMessage(userMsg, 6000);
             }
         }

        async function initializeARScene() {
             console.log("Initializing A-Frame Scene..."); 
             if (!firebaseReady || !poiCollectionRef) { 
                  showMessage("Database connection lost. Cannot start AR.", 5000);
                  navigateTo('summary'); 
                  return; 
             } 
            const arSceneContainer = document.getElementById('ar-scene-container');
             if (!arSceneContainer) { return; }
             
            arSceneContainer.innerHTML = ''; 
            
            arScene = document.createElement('a-scene'); 
            arScene.id = 'ar-scene';
             arScene.setAttribute('embedded', '');
             arScene.setAttribute('vr-mode-ui', 'enabled: false');
             arScene.setAttribute('renderer', 'logarithmicDepthBuffer: true; antialias: true; precision: high; alpha: true;physicallyCorrectLights: true;'); 
             arScene.setAttribute('arjs', 'sourceType: webcam; videoTexture: true; debugUIEnabled: false;'); 


            const arCamera = document.createElement('a-camera'); 
            arCamera.id = 'ar-camera';
             arCamera.setAttribute('gps-camera', 'gpsMinDistance: 5; gpsTimeInterval: 1000;'); 
             arCamera.setAttribute('rotation-reader', ''); 


            const poiContainer = document.createElement('a-entity'); 
            poiContainer.id = 'poi-container';


            if (loadingStatusText) loadingStatusText.textContent = 'Downloading Points of Interest...'; 
            let loadedCount = 0; 

            try {
                const now = new Date(); 
                if (allPoisData.length === 0) { console.log("No POIs in local cache for AR."); }

                 allPoisData.forEach(poi => { 
                     if (typeof poi.lat !== 'number' || typeof poi.lon !== 'number' || (!poi.modelUrl && !poi.videoUrl) || !poi.startDate || !poi.endDate) { return; } 

                    const startDate = new Date(poi.startDate); 
                    const endDate = new Date(poi.endDate); 
                    endDate.setHours(23, 59, 59, 999); 

                    if (now >= startDate && now <= endDate) { 
                         const entity = document.createElement('a-entity');
                         entity.setAttribute('gps-entity-place', `latitude: ${poi.lat}; longitude: ${poi.lon};`);
                         const groundHeight = poi.groundHeight || 0.0;
                         entity.setAttribute('position', `0 ${groundHeight} 0`);
                         const scale = (poi.scale > 0) ? poi.scale : 1.0;

                         if (poi.poiType === 'video' && poi.videoUrl) {
                              console.log(`Creating AR video plane: ${poi.name}`);
                              entity.setAttribute('geometry', `primitive: plane; width: ${scale}; height: ${scale * (9/16)};`); 
                              entity.setAttribute('material', `shader: flat; src: ${poi.videoUrl}; side: double;`); 
                         } else if (poi.modelUrl) { 
                              console.log(`Creating AR model: ${poi.name}`);
                              entity.setAttribute('gltf-model', `url(${poi.modelUrl}); crossorigin: anonymous;`);
                              entity.setAttribute('scale', `${scale} ${scale} ${scale}`);
                              entity.setAttribute('animation-mixer', ''); 
                         } else { return; } 

                        if (poi.soundUrl) { 
                            entity.setAttribute('sound', `src: url(${poi.soundUrl}); autoplay: true; loop: true; volume: 0.5; poolSize: 1; positional: false;`); 
                             console.log(`Added background sound to ${poi.name}`);
                        }
                         entity.id = `poi-${poi.id.substring(0,8)}`; 
                        poiContainer.appendChild(entity);
                        loadedCount++;
                    } 
                });
                
            } catch (error) { 
                 console.error("Error processing POI data for AR:", error);
                 showMessage("Error preparing AR content.", 5000);
                 if (arLoadingScreen) arLoadingScreen.classList.remove('active');
                 navigateTo('summary');
                 return;
            } finally { 
                 console.log(`Processed ${loadedCount} active POIs for the AR scene.`);
                 if (allPoisData.length > 0 && loadedCount === 0) {
                     showMessage("No content is active for today's date.", 4000);
                 } else if (allPoisData.length === 0) {
                      showMessage("No content has been configured yet.", 4000);
                 }
             }

            arScene.appendChild(arCamera); 
            arScene.appendChild(poiContainer); 
            
            // Add lights 
             let ambientLight = arScene.querySelector('a-light[type="ambient"]'); 
             if (!ambientLight) { 
                  ambientLight = document.createElement('a-light');
                  ambientLight.setAttribute('type', 'ambient');
                  ambientLight.setAttribute('color', '#BBB'); 
                  ambientLight.setAttribute('intensity', '0.7'); 
                  arScene.appendChild(ambientLight);
             }
             let directionalLight = arScene.querySelector('a-light[type="directional"]'); 
             if (!directionalLight) { 
                  directionalLight = document.createElement('a-light');
                  directionalLight.setAttribute('type', 'directional');
                  directionalLight.setAttribute('color', '#FFF');
                  directionalLight.setAttribute('intensity', '0.8'); 
                  directionalLight.setAttribute('position', '-1 2 1.5'); 
                  directionalLight.setAttribute('castShadow', 'true'); 
                  arScene.appendChild(directionalLight);
              }

            arSceneContainer.appendChild(arScene); 
            
            // Event listeners
            arScene.addEventListener('loaded', () => { 
                 if (!arScene) return; 
                console.log('A-Frame scene loaded successfully.');
                if (arLoadingScreen) arLoadingScreen.classList.remove('active');
                startGPSWatch(); 
                showMessage("AR Scene Ready! Waiting for GPS signal...", 3000);
            });
            arScene.addEventListener('error', (err) => { 
                 console.error("A-Frame scene error:", err);
                 showMessage("Error loading AR scene.", 5000);
                 navigateTo('summary');
            });
             arScene.addEventListener('arjs-video-loaded', (ev) => { console.log("AR.js video stream loaded.", ev); }); 
             arScene.addEventListener('gps-camera-origin-coord-set', (ev) => { console.log("AR.js GPS origin set.", ev.detail); }); 

        }

        function stopAR() { 
             console.log("Stopping AR..."); 
            if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
            if (arScene) {
                 try {
                     arScene.pause(); 
                     const arSystem = arScene.systems ? arScene.systems['arjs'] : null;
                      if (arSystem && arSystem.stop) { arSystem.stop(); } 
                      else { console.warn("AR.js system not found or stop method unavailable."); }
                     if (arScene.parentNode) { arScene.parentNode.removeChild(arScene); }
                 } catch (e) { console.error("Error during AR cleanup:", e); } 
                 finally { arScene = null; }
            } else { console.log("StopAR called but no active A-Frame scene found."); }
            window.removeEventListener('gps-camera-update-position', onGPSUpdate);
            window.removeEventListener('gps-camera-error', onGPSError);
            if (arLoadingScreen) arLoadingScreen.classList.remove('active'); 
             console.log('AR completely stopped and cleaned up.');
        }


        function onGPSUpdate(event) { 
             const gpsStatusEl = document.getElementById('gps-status');
             const gpsAccuracyEl = document.getElementById('gps-accuracy');
             if (!pages.ar?.classList.contains('active') || !gpsStatusEl || !gpsAccuracyEl) return;
             const pos = event.detail?.position; 
              if (!pos) { return; }
             gpsStatusEl.textContent = 'Active';
             gpsAccuracyEl.textContent = `${pos.accuracy.toFixed(1)}m`;
             gpsAccuracyEl.style.color = pos.accuracy < 10 ? '#4CAF50' : (pos.accuracy < 25 ? '#FFC107' : '#F44336'); 
        }
        function onGPSError(event) { 
              if (!pages.ar?.classList.contains('active')) return;
             const gpsStatusEl = document.getElementById('gps-status');
             if (gpsStatusEl) gpsStatusEl.textContent = 'Error';
              console.error('AR.js GPS Error:', event.detail); 
              let errorMsg = event.detail?.message || "Unknown GPS error";
              if (event.detail?.code) { 
                   switch(event.detail.code) {
                       case 1: errorMsg = "Permission denied."; break;
                       case 2: errorMsg = "Position unavailable."; break;
                       case 3: errorMsg = "GPS Timeout."; break;
                   }
              }
             showMessage('AR GPS Error: ' + errorMsg, 5000);
        }
        function startGPSWatch() { 
              window.removeEventListener('gps-camera-update-position', onGPSUpdate);
              window.removeEventListener('gps-camera-error', onGPSError);
             
             window.addEventListener('gps-camera-update-position', onGPSUpdate);
             window.addEventListener('gps-camera-error', onGPSError);
              console.log("AR.js GPS event listeners attached.");
        }

        // --- Navigation Event Listeners ---
         function setupNavigationListeners() {
             console.log("Setting up navigation listeners..."); 
             const setupListener = (id, event, handler) => { 
                   const element = document.getElementById(id);
                   if (element) {
                        element.removeEventListener(event, handler); 
                        element.addEventListener(event, handler); 
                        console.log(`Listener added for ${id}`);
                   } else {
                        console.warn(`Element with ID '${id}' not found for listener setup.`);
                   }
              };

             // Setup listeners
             setupListener('goto-map-btn', 'click', handleGoToMap);
             setupListener('back-to-admin-btn', 'click', handleBackToAdmin);
             setupListener('goto-summary-btn', 'click', handleGoS summary); 
             setupListener('back-to-map-btn', 'click', handleGoToMap); 
             setupListener('launch-ar-btn', 'click', handleLaunchAR); 
             setupListener('back-to-summary-btn', 'click', handleBackToSummary); 
             setupListener('grant-permissions-btn', 'click', handleGrantPermissions);
             
             console.log("Navigation listeners setup complete.");
         }

         // Navigation handlers
         function handleGoToMap() { console.log("goto-map clicked"); navigateTo('map'); }
         function handleGoToSummary() { console.log("goto-summary clicked"); navigateTo('summary'); } 
         function handleBackToAdmin() { console.log("back-to-admin clicked"); navigateTo('admin'); }
         function handleLaunchAR() { console.log("launch-ar clicked"); navigateTo('ar'); } 
         function handleBackToSummary() { console.log("back-to-summary clicked"); navigateTo('summary'); } 
         function handleGrantPermissions() { 
             console.log("grant-permissions clicked");
             if (permissionModal) permissionModal.style.display = 'none';
             startARFlow(); 
         }


        // --- App Initialization ---
         document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed.");
             
             // --- Get DOM Element References ---
             pages.admin = document.getElementById('admin-page');
             pages.map = document.getElementById('map-page');
             pages.summary = document.getElementById('summary-page');
             pages.ar = document.getElementById('ar-page');
             messageBox = document.getElementById('message-box');
             permissionModal = document.getElementById('permission-modal');
             arLoadingScreen = document.getElementById('ar-loading-screen');
             loadingStatusText = document.getElementById('loading-status-text');
             versionDisplay = document.getElementById('version-display'); 
             listContainer = document.getElementById('poi-list-container');
             loadingPois = document.getElementById('loading-pois');
             ecopiensaSelectionList = document.getElementById('ecopiensa-selection-list');
             loadingModelsPlaceholder = document.getElementById('loading-models-placeholder');
             selectVideoCheckbox = document.getElementById('select-video-cb');
             gotoMapButton = document.getElementById('goto-map-btn'); 
             placementPanel = document.getElementById('placement-panel');
             modelsToPlaceList = document.getElementById('models-to-place-list');
             placementFormContainer = document.getElementById('placement-form-container');
             placingModelName = document.getElementById('placing-model-name');
             cancelPlacementBtn = document.getElementById('cancel-placement-btn');
             savePlacementBtn = document.getElementById('save-placement-btn');
             mapZoomSlider = document.getElementById('map-zoom-slider');
             jumptoBtn = document.getElementById('jumpto-btn');
             placePoiTypeSelect = document.getElementById('place-poi-type');
             modelFieldsDiv = document.getElementById('model-fields');
             videoFieldsDiv = document.getElementById('video-fields');
             placeModelUrlInput = document.getElementById('place-model-url');
             placeVideoUrlInput = document.getElementById('place-video-url');
             placeNameInput = document.getElementById('place-name');
             placedPoisPanel = document.getElementById('placed-pois-panel');
             placedPoisList = document.getElementById('placed-pois-list');
             editLocationPanel = document.getElementById('edit-location-panel');
             editingPoiNameEl = document.getElementById('editing-poi-name');
             saveEditLocationBtn = document.getElementById('save-edit-location-btn');
             cancelEditLocationBtn = document.getElementById('cancel-edit-location-btn');
             summaryPoiList = document.getElementById('summary-poi-list');
             loadingSummaryPois = document.getElementById('loading-summary-pois');
             mapCenterCoordsEl = document.getElementById('map-center-coords'); 
             placementPreviewImageEl = document.getElementById('placement-preview-image'); 

             console.log("DOM element references obtained.");

             // --- Initialize App ---
             // CORRECCIÓN: Ejecutar estas funciones ANTES de Firebase
             // para que la UI se muestre incluso si Firebase falla.
             displayAppVersion(); 
             initializeModelSelection(); 
             setupNavigationListeners(); 

             // Inicializar Firebase al final
             initializeFirebase(); 

             // --- Adjuntar listeners que no son de navegación ---
             // (Se mueven aquí para asegurar que los elementos existen)
            if (cancelPlacementBtn) cancelPlacementBtn.addEventListener('click', cancelPlacement);
            if (savePlacementBtn) savePlacementBtn.addEventListener('click', handleSavePlacement);
            if (saveEditLocationBtn) saveEditLocationBtn.addEventListener('click', handleSaveEditLocation);
            if (cancelEditLocationBtn) cancelEditLocationBtn.addEventListener('click', cancelEditLocation);
            if (listContainer) {
                listContainer.addEventListener('click', async (e) => {
                    if (!firebaseReady || !poiCollectionRef) { 
                        showMessage("Error: La base de datos no está lista para eliminar.", 4000);
                        return; 
                    }
                    if (e.target && e.target.classList.contains('delete-btn')) { 
                        const docId = e.target.getAttribute('data-id');
                        if (confirm("¿Estás seguro de que quieres eliminar este punto de interés?")) {
                            const button = e.target; 
                            try {
                                button.disabled = true;
                                button.textContent = 'Eliminando...';
                                const docRef = doc(db, poiCollectionRef.path, docId);
                                await deleteDoc(docRef);
                                showMessage('Punto de interés eliminado.', 3000);
                            } catch (error) {
                                console.error("Error al eliminar documento: ", error);
                                showMessage("No se pudo eliminar el documento.", 5000);
                                if (button && listContainer.contains(button)) { 
                                   button.disabled = false;
                                   button.textContent = 'Eliminar';
                                }
                            }
                        }
                    }
                });
            }
            console.log("Form and List listeners attached.");
         });

    </script>
</body>
</html>

