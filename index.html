<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"> <!-- CORREGIDO: UTF-8 en lugar de UTF-M -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panel de Administración AR (Geolocalización)</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page {
            display: none; height: 100%; width: 100%;
            position: relative; overflow-y: auto; /* Allow scrolling on pages */
             padding-bottom: 60px; /* Add padding for controls */
        }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; } /* Map page should not scroll */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover:not(:disabled) { background-color: #45a049; } /* Added :not(:disabled) */
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.7; } /* Added opacity */

        /* Specific button styles */
        .delete-btn-map { /* New style for map delete button */
             background-color: #f44336; /* Red */
             color: white;
             font-size: 0.75rem; /* text-xs */
             padding: 0.25rem 0.5rem; /* px-2 py-1 */
             border-radius: 0.25rem; /* rounded */
             margin-left: 0.25rem; /* ml-1 */
             transition: background-color 0.3s;
        }
        .delete-btn-map:hover:not(:disabled) {
             background-color: #d32f2f;
        }
         .delete-btn-map.confirm { /* Style for confirm state */
             background-color: #ff9800; /* Orange */
         }
         .delete-btn-map.confirm:hover:not(:disabled) {
             background-color: #f57c00;
         }

         /* Style for the new back button */
         .secondary-action-btn {
            background-color: #607d8b; /* Blue Grey */
            color: white;
            padding: 8px 16px; /* Slightly smaller */
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 8px; /* Add some space */
         }
         .secondary-action-btn:hover:not(:disabled) {
             background-color: #546e7a;
         }

        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem;
            z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show { opacity: 1; }

        /* Estilos de Mapa y AR (adaptados) */
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-controls { position: fixed; top: 20px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px; }

        #map-crosshair {
            position: absolute !important; 
            top: 50% !important; 
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 30px !important; 
            height: 30px !important; 
            border: 2px solid white !important;
            border-radius: 50% !important; 
            box-shadow: 0 0 10px black, 0 0 0 2px rgba(0, 0, 0, 0.5) !important; 
            pointer-events: none !important; 
            z-index: 1000 !important; 
        }

        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center;
        }
        #map-center-coords {
             position: fixed; 
             top: 75px; 
             left: 20px; 
             z-index: 402; 
             background-color: rgba(0, 0, 0, 0.75); 
             color: white; 
             padding: 8px 12px; 
             border-radius: 8px; 
             font-size: 0.8rem; 
             font-family: monospace; 
             box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #map-center-coords span { display: block; } 

        /* Panels on Map */
        .map-panel {
             position: fixed; 
             top: 80px; 
             left: 10px; 
             z-index: 401; 
             background-color: rgba(255, 255, 255, 0.95); 
             padding: 15px; 
             border-radius: 8px; 
             box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
             max-width: 300px; 
             width: 90%; 
             max-height: calc(100vh - 180px); 
             overflow-y: auto; 
             backdrop-filter: blur(5px);
        } 
        #edit-location-panel {
             border: 2px solid #f59e0b; 
         } 
        #placed-pois-panel {
             left: auto; 
             right: 10px; 
         } 
        #placement-preview-image {
             max-width: 100px; 
             max-height: 100px; 
             margin: 10px auto; 
             border: 1px solid #ccc; 
             border-radius: 4px; 
             display: none; 
             object-fit: contain; 
         }
        .leaflet-popup-content img.popup-image {
             max-width: 100px; 
             max-height: 100px; 
             display: block; 
             margin: 5px auto; 
             border-radius: 4px; 
         }

        a-scene { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; }
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }

        #ar-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; }
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }
        .ar-loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10002; }
        .ar-loading-screen.active { display: flex; }

        /* Video AR styles */
        a-video { border: 2px solid white; background-color: black; }

        /* Correcciones de Video y Canvas AR */
        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; object-fit: cover !important;
            z-index: -1 !important; display: block !important; opacity: 1 !important;
            visibility: visible !important; autoplay: true !important;
            playsinline: true !important; webkit-playsinline: true !important;
            muted: true !important;
        }
        canvas, .a-canvas {
            background: transparent !important; background-color: rgba(0, 0, 0, 0) !important;
            z-index: 1 !important; position: fixed !important; top: 0 !important;
            left: 0 !important; width: 100% !important; height: 100% !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- PÁGINA 0: Login (NUEVA) -->
    <div id="login-page" class="page active flex items-center justify-center bg-gray-200">
        <div class="bg-white p-10 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Admin AR</h1>
            <p class="text-gray-600 mb-8">Por favor, inicia sesión para continuar.</p>
            <button id="google-login-btn" class="control-button bg-blue-500 hover:bg-blue-600 w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.35 12.24c0-.79-.07-1.54-.2-2.28h-9.15v4.3h5.16c-.22 1.4-.87 2.6-1.95 3.4v2.8h3.59c2.1-1.9 3.3-4.5 3.3-7.22z"/><path d="M12 21.8c2.6 0 4.7-.87 6.2-2.3l-3.6-2.8c-.87.6-1.9.9-3.1.9-2.4 0-4.5-1.6-5.2-3.8H3.1v2.9c1.5 3 4.5 5 8.2 5z"/><path d="M6.8 14.3c-.2-.6-.3-1.2-.3-1.8s.1-1.2.3-1.8V7.8H3.1c-.6 1.2-1 2.5-1 4s.4 2.8 1 4l3.7-2.9z"/><path d="M12 6.3c1.4 0 2.6.5 3.6 1.4l3.2-3.2C17.2 2.8 14.8 2 12 2c-3.7 0-6.7 2-8.2 5l3.7 2.9c.7-2.2 2.8-3.8 5.2-3.8z"/></svg>
                <span>Iniciar Sesión con Google</span>
            </button>
        </div>
    </div>

    <!-- PÁGINA 1: Panel de Administración (Selección de Modelos) -->
    <div id="admin-page" class="page"> <!-- 'active' quitado -->
        <div class="container mx-auto p-6 max-w-4xl">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-blue-700">Panel de Administración AR</h1>
                    <div class="text-sm text-gray-500 mt-1">
                        <span id="version-display" class="font-normal align-middle"></span>
                        <span id="user-info" class="hidden ml-4">
                            Logueado como: <strong id="user-email"></strong>
                        </span>
                    </div>
                </div>
                <div>
                    <button id="logout-btn" class="control-button bg-red-500 hover:bg-red-600 hidden">Salir</button>
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600 ml-2" disabled>Ir al Mapa</button> 
                </div>
            </div>

            <!-- Sección de Selección de Modelos -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">1. Seleccionar Contenido para Colocar</h2>
                <p class="text-gray-600 mb-4">Marca los modelos o define el video que quieres posicionar en el mapa.</p>
                <div id="ecopiensa-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                     <p id="loading-models-placeholder" class="text-gray-500 col-span-full">Cargando modelos...</p>
                </div>
                <!-- Sección para Video (opcional) -->
                <div class="mt-4 pt-4 border-t">
                     <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                           <input type="checkbox" id="select-video-cb" class="h-5 w-5 text-blue-600">
                           <span>Añadir un Video Personalizado</span>
                     </label>
                </div>

                <h2 class="text-2xl font-semibold mt-6 mb-4">2. Ir al Mapa para Posicionar</h2>
                <p class="text-gray-600">El contenido que selecciones aquí estará disponible en el panel del mapa.</p>
                 <button id="clear-selection-btn" class="mt-4 text-sm text-red-600 hover:text-red-800 underline">Limpiar selección guardada</button>
            </div>

            <!-- Lista de POIs existentes (para eliminar) -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Contenido Geoposicionado Guardado</h2>
                <div id="poi-list-container" class="space-y-4">
                    <p id="loading-pois" class="text-gray-500 font-semibold">Inicializando Firebase...</p> 
                 </div>
            </div>
        </div>
    </div>
    
    <!-- PÁGINA 2: Vista de Mapa (Posicionar y Editar) -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div> 
         </div>

        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div> 
                 <div id="map-center-coords">
             <span>Lat: --</span>
             <span>Lon: --</span>
         </div>

        <!-- Panel de Colocación (Izquierda) -->
        <div id="placement-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Colocar Nuevo Contenido</h3>
            <!-- Lista de modelos/video seleccionados disponibles para colocar -->
            <div id="models-to-place-list" class="space-y-2 mb-4">
                <p class="text-sm text-gray-500">No hay contenido nuevo seleccionado. Vuelve al Panel.</p>
            </div>
            
            <div class="slider-container mb-4">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="15" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            
            <!-- Formulario para configurar el POI (inicialmente oculto) -->
            <div id="placement-form-container" class="hidden space-y-3">
                <h4 id="placing-model-name" class="font-semibold text-blue-600 text-center text-lg mb-2"></h4>
                                 
                 <img id="placement-preview-image" src="" alt="Vista previa">

                 <div>
                     <label class="block text-sm font-medium text-gray-700">Tipo de POI</label>
                     <select id="place-poi-type" class="mt-1 w-full p-2 border border-gray-300 rounded">
                         <option value="model" selected>Modelo 3D</option>
                         <option value="video">Video (.mp4)</option>
                     </select>
                 </div>

                 <div id="model-fields">
                     <div>
                         <label for="place-model-url" class="block text-sm font-medium text-gray-700">URL Modelo (.glb)</label>
                         <input type="url" id="place-model-url" class="mt-1 w-full p-2 border border-gray-300 rounded bg-gray-100" readonly>
                     </div>
                 </div>
                 <div id="video-fields" class="hidden"> 
                      <div>
                         <label for="place-video-url" class="block text-sm font-medium text-gray-700">URL Video (.mp4)</label>
                         <input type="url" id="place-video-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../video.mp4">
                     </div>
                 </div>

                <div>
                    <label for="place-name" class="block text-sm font-medium text-gray-700">Nombre Descriptivo</label>
                    <input type="text" id="place-name" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-scale" class="block text-sm font-medium text-gray-700">Escala (Video: ancho en metros)</label>
                    <input type="number" id="place-scale" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="1.0">
                </div>
                <div>
                    <label for="place-ground-height" class="block text-sm font-medium text-gray-700">Altura sobre terreno (m)</label>
                    <input type="number" id="place-ground-height" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="0.0">
                </div>
                <div>
                    <label for="place-sound-url" class="block text-sm font-medium text-gray-700">URL Sonido Fondo (Opcional, .mp3)</label>
                    <input type="url" id="place-sound-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../musica.mp3">
                </div>
                <div>
                    <label for="place-start-date" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                    <input type="date" id="place-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-end-date" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                    <input type="date" id="place-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                
                <p class="text-sm text-blue-600 font-semibold pt-2">Mueve el mapa para centrar la cruz en la ubicación deseada.</p>
                <button id="save-placement-btn" class="w-full bg-green-500 hover:bg-green-600 text-white p-2 rounded transition duration-300 font-bold">
                    Guardar Ubicación (en la Cruz)
                </button>
                <button id="back-to-selection-btn" class="w-full secondary-action-btn hover:bg-gray-600">Volver a Seleccionar Modelo</button>
                <button id="cancel-placement-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300 mt-2">Cancelar Colocación Total</button>
             </div>
        </div>
        
         <!-- Panel de POIs Guardados (Derecha) -->
         <div id="placed-pois-panel" class="map-panel right-3">
              <h3 class="text-lg font-semibold mb-2">Contenido en el Mapa</h3>
              <p class="text-xs text-amber-700 mb-2">Datos guardados en Firebase.</p>
             <div id="placed-pois-list" class="space-y-3">
                 <p class="text-sm text-gray-500">Cargando contenido guardado...</p>
                 <!-- Lista de POIs con botón de editar y eliminar se insertará aquí -->
             </div>
         </div>
        
         <!-- Panel de Edición de Ubicación (Aparece al editar) -->
         <div id="edit-location-panel" class="map-panel hidden">
             <h3 class="text-lg font-semibold mb-2">Editando Ubicación</h3>
             <p id="editing-poi-name" class="text-sm font-medium text-gray-700 mb-2"></p>
             <p class="text-sm text-amber-700 font-semibold mb-3">Mueve el mapa para centrar la cruz en la NUEVA ubicación.</p>
             <button id="save-edit-location-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white p-2 rounded transition duration-300 font-bold mb-2">
                 Guardar Nueva Ubicación (en la Cruz)
             </button>
             <button id="cancel-edit-location-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300">
                 Cancelar Edición
             </button>
         </div>

        <div id="map-controls">
            <button id="back-to-admin-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Panel</button>
            <button id="goto-summary-btn" class="control-button bg-purple-500 hover:bg-purple-600">Ver Resumen</button> 
         </div>
    </div>

    <!-- PÁGINA 3: Resumen y Lanzamiento AR (NUEVA) -->
    <div id="summary-page" class="page">
         <div class="container mx-auto p-6 max-w-4xl">
             <div class="flex justify-between items-center mb-8">
                 <h1 class="text-3xl font-bold text-purple-700">Resumen de Configuración AR</h1>
                 <div>
                     <button id="back-to-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Mapa</button>
                     <button id="launch-ar-btn" class="control-button bg-green-500 hover:bg-green-600">¡Probar AR!</button> 
                  </div>
             </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold mb-4">Contenido Configurado</h2>
                  <p class="text-gray-600 mb-4">Este es el contenido que se mostrará en la Realidad Aumentada (si está dentro de las fechas activas).</p>
                 <div id="summary-poi-list" class="space-y-4">
                     <p id="loading-summary-pois" class="text-gray-500">Cargando resumen...</p>
                 </div>
             </div>
         </div>
    </div>

    <!-- PÁGINA 4: Vista de Realidad Aumentada -->
    <div id="ar-page" class="page">
        <div id="ar-loading-screen" class="ar-loading-screen active">
            <div class="loading-content">
                <div class="loader"></div>
                <div id="loading-status-text" class="text-xl">Preparando componentes...</div>
            </div>
        </div>

        <div id="ar-scene-container"></div>

        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy" style="font-weight: bold;">--</span>m</div>
        </div>
        <div id="ar-controls">
            <button id="back-to-summary-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Resumen</button> 
         </div>
    </div>

    <!-- Modal para solicitar permisos -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h2>Permisos necesarios</h2>
            <p>Esta aplicación necesita acceso a tu cámara y ubicación para la experiencia de Realidad Aumentada.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder Permisos</button>
        </div>
    </div>

    <div id="message-box"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            deleteDoc,
            updateDoc, 
            onSnapshot, 
            getDocs,
            query,
            setLogLevel 
         } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Versión de la App ---
        // IMPORTANTE: Incrementar esta versión (ej. 1.31 -> 1.32) con CADA cambio, corrección o ajuste.
        const APP_VERSION = '1.32'; // Corrección de la ruta de Firestore para usar projectId
        // LocalStorage Key
        const LOCALSTORAGE_KEY = 'arAdminModelSelection';

        // --- Modelos de ECOPIENSA (con imageUrl) ---
        const GITHUB_BASE_URL_MODELS = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/';
        const GITHUB_BASE_URL_IMAGES = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/'; 
        const ECOPIENSA_MODELS = [
            { name: 'Botellita Azul', modelUrl: `${GITHUB_BASE_URL_MODELS}botellytaazul.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}botellytaazul.jpg` },
            { name: 'Ecoladrillo', modelUrl: `${GITHUB_BASE_URL_MODELS}ecoladrillo.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}ecoladrillo.jpg` },
            { name: 'Lata Plateada', modelUrl: `${GITHUB_BASE_URL_MODELS}lataplateada.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}lataplateada.jpg` },
            { name: 'Papelito Verde', modelUrl: `${GITHUB_BASE_URL_MODELS}papelitoverde.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}papelitoverde.jpg` },
            { name: 'Señor Contenedor', modelUrl: `${GITHUB_BASE_URL_MODELS}senorcontenedor.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}senorcontenedor.jpg` },
            { name: 'Tapa Roja', modelUrl: `${GITHUB_BASE_URL_MODELS}taparoja.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}taparoja.jpg` }
        ];
        const CUSTOM_VIDEO_PLACEHOLDER = { name: "Video Personalizado", url: "CUSTOM_VIDEO", isCustomVideo: true, imageUrl: "https://placehold.co/100x100/764ba2/white?text=Video" }; 

        // --- Configuración de Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Ya no se usa para Google Auth
        const firebaseConfig = { 
         apiKey: "AIzaSyBkxP7vqrVZMRhl-vUpHMMKjj5aIujDQ3k", 
         authDomain: "centro-comercial-1ea64.firebaseapp.com", 
         projectId: "centro-comercial-1ea64", 
         storageBucket: "centro-comercial-1ea64.appspot.com", 
         messagingSenderId: "667808330264", 
         appId: "1:667808330264:web:9718955b58aba4359b096d", 
         measurementId: "G-3ZPG0Q8FL6"
        };

        let db, auth, userId, poiCollectionRef;
        let map;
        let poiMarkers = {}; 
        let allPoisData = []; 
        let poiDataMap = new Map(); 

        // --- Estado Global ---
        let modelsToPlace = []; // Will be loaded from localStorage
        let isPlacingModel = false;
        let currentPlacingModel = {}; 
        let isEditingLocation = false; 
        let currentEditingPoiId = null; 
        let currentEditingMarker = null; 
        let firebaseReady = false; 

        // Variables AR
        let arScene = null;
        let gpsWatchId = null; 

        // --- Referencias a Elementos DOM (se asignarán en DOMContentLoaded) ---
        let pages = {};
        let messageBox, permissionModal, arLoadingScreen, loadingStatusText, versionDisplay; 
        let listContainer, loadingPois, ecopiensaSelectionList, loadingModelsPlaceholder, selectVideoCheckbox, clearSelectionBtn;
        let placementPanel, modelsToPlaceList, placementFormContainer, placingModelName, cancelPlacementBtn, savePlacementBtn, backToSelectionBtn;
        let mapZoomSlider, jumptoBtn, placePoiTypeSelect, modelFieldsDiv, videoFieldsDiv, placeModelUrlInput, placeVideoUrlInput, placeNameInput;
        let placedPoisPanel, placedPoisList, editLocationPanel, editingPoiNameEl, saveEditLocationBtn, cancelEditLocationBtn;
        let summaryPoiList, loadingSummaryPois;
        let gotoMapButton; 
        let mapCenterCoordsEl; 
        let placementPreviewImageEl; 
        // Nuevos refs de Auth
        let loginPage, googleLoginBtn, logoutBtn, userInfo, userEmail;


        // --- Funciones ---

        function showMessage(msg, duration = 3000) {
            // ... (no changes) ...
            if (!messageBox) { 
                console.warn("Attempted to show message before messageBox was assigned:", msg); 
                return; 
            }
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function navigateTo(pageName) {
            if (Object.keys(pages).length === 0) { 
                console.error("Attempted to navigate before pages object was populated."); 
                return; 
            }
            
            // La página de Login siempre debe ser accesible
            if (pageName !== 'login' && !firebaseReady) {
                 if ((pageName === 'map' || pageName === 'summary' || pageName === 'ar')) {
                    showMessage("Aguarde un momento, conectando con la base de datos...", 3000);
                    console.warn(`Attempt to navigate to ${pageName} before Firebase is ready.`);
                 } else if (pageName === 'admin' && !firebaseReady) {
                     // No mostrar mensaje si se intenta ir a admin sin estar listo (onAuthStateChanged lo hará)
                 } else {
                     console.warn(`Navigation to ${pageName} blocked, Firebase not ready.`);
                 }
                return; 
            }

            console.log(`Navigating to: ${pageName}`);
            Object.values(pages).forEach(p => p.classList.remove('active'));
            if(pages[pageName]) {
                pages[pageName].classList.add('active'); 
                console.log(`Page ${pageName} activated.`);
            } else { 
                console.error(`Page not found: ${pageName}. Falling back to login.`); 
                if (pages.login) pages.login.classList.add('active'); 
                 return;
            }

            // Page specific logic
            if (pageName === 'map') { 
                stopAR(); 
                setTimeout(initMap, 100); 
            } else if (pageName === 'summary') { 
                stopAR(); 
                 stopMap(); 
                 populateSummaryPage(); // Esta función ahora tiene código
            } else if (pageName === 'ar') { 
                stopMap(); 
                startARFlow(); 
            } else if (pageName === 'admin') { 
                stopAR(); 
                stopMap(); 
                initializeModelSelection(); 
            } else if (pageName === 'login') {
                stopAR();
                stopMap();
            }
        }

        function stopMap() {
            // ... (no changes) ...
            if (map) { 
                map.off('move', updateCenterCoordsDisplay); 
                if (placedPoisList) {
                   placedPoisList.removeEventListener('click', handleDeletePoiOnMap);
                } 
                map.remove(); 
                 map = null; 
                Object.values(poiMarkers).forEach(marker => marker.remove()); 
                poiMarkers = {}; 
                 console.log("Map stopped and removed.");
            } 
            isPlacingModel = false; 
            isEditingLocation = false; 
            currentEditingPoiId = null; 
            currentEditingMarker = null;
        }

        // --- Persistence Functions ---
        function saveSelectionToLocalStorage() {
            // ... (no changes) ...
            try {
                localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(modelsToPlace));
                console.log("Selection saved to localStorage:", modelsToPlace);
            } catch (e) {
                console.error("Error saving selection to localStorage:", e);
                showMessage("Error guardando selección localmente.", 4000);
            }
        }

        function loadSelectionFromLocalStorage() {
            // ... (no changes) ...
            const savedSelection = localStorage.getItem(LOCALSTORAGE_KEY);
            if (savedSelection) {
                try {
                    modelsToPlace = JSON.parse(savedSelection);
                    console.log("Loaded model selection from localStorage:", modelsToPlace);
                } catch (e) {
                    console.error("Error parsing saved selection:", e);
                    localStorage.removeItem(LOCALSTORAGE_KEY); // Clear corrupted data
                    modelsToPlace = []; // Reset to empty
                }
            } else {
                modelsToPlace = []; // Initialize empty if nothing saved 
                console.log("No selection found in localStorage, initializing empty.");
            }
        }

        function clearSavedSelection() { 
             // ... (no changes) ... 
             localStorage.removeItem(LOCALSTORAGE_KEY); 
             modelsToPlace = []; 
             initializeModelSelection(); // Update UI immediately 
             showMessage("Selección guardada limpiada.", 2000); 
             console.log("Cleared saved selection.");
        }

        // --- Firebase Logic ---
        async function initializeFirebase() { 
            console.log("Initializing Firebase..."); 
            if (loadingPois) loadingPois.textContent = "Inicializando conexión Firebase...";
            if (gotoMapButton) gotoMapButton.disabled = true; 

            if (!firebaseConfig || !firebaseConfig.projectId) { 
                const errorMsg = "Error fatal: Configuración de Firebase inválida o incompleta."; 
                console.error(errorMsg, firebaseConfig); 
                if(loadingPois) loadingPois.textContent = errorMsg; 
                showMessage(errorMsg, 10000); 
                 return; 
            }
            
            try { 
                console.log("Calling initializeApp...");
                const app = initializeApp(firebaseConfig); 
                 console.log("Firebase App initialized.");
                db = getFirestore(app); 
                auth = getAuth(app); 
                console.log("Firestore and Auth services obtained.");
                setLogLevel('Debug'); 
                
                console.log("Setting up Auth State Listener...");
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed callback triggered.");
                    if (user) {
                        // --- Usuario Logueado ---
                        userId = user.uid;
                        console.log('Firebase User Authenticated. UID:', userId);
                        if (userEmail) userEmail.textContent = user.email || userId;
                        if (userInfo) userInfo.classList.remove('hidden');
                        if (logoutBtn) logoutBtn.classList.remove('hidden');
                        
                        // --- CORRECCIÓN DE RUTA DE COLECCIÓN ---
                        // Si estamos en el entorno Canvas, usamos __app_id. Si no, usamos projectId como el entorno espera.
                        const identifier = (typeof __app_id !== 'undefined' && appId !== 'default-app-id') 
                            ? appId // Usa __app_id del entorno (si está definido y no es el valor por defecto)
                            : firebaseConfig.projectId; // Usa projectId como fallback/local
                            
                        const collectionPath = `/artifacts/${identifier}/users/${userId}/pois`;
                        poiCollectionRef = collection(db, collectionPath);
                        console.log('POI Collection configured to user-specific path:', collectionPath);
                        
                        firebaseReady = true; 
                        console.log('Firebase is Ready. Enabling GoToMap button...');
                        if (gotoMapButton) {
                            gotoMapButton.disabled = false; 
                             console.log("GoToMap button ENABLED.");
                        }
                        if (loadingPois && (loadingPois.textContent.startsWith("Conectando") || loadingPois.textContent.startsWith("Inicializando"))) { 
                             loadingPois.textContent = "Conexión exitosa. Cargando POIs..."; 
                         }
                        showMessage(`Bienvenido, ${user.displayName || user.email}`, 2000);
                        
                        console.log('Calling loadAndListenPois...');
                        loadAndListenPois(); 
                        
                        // Mover a la página de admin si estaba en login
                        if (pages.login?.classList.contains('active')) {
                            navigateTo('admin');
                        }

                     } else {
                        // --- Usuario Deslogueado ---
                        userId = null;
                        poiCollectionRef = null;
                        firebaseReady = false; 
                         console.log('Firebase User signed out.');
                        if (gotoMapButton) {
                           gotoMapButton.disabled = true; 
                            console.log('GoToMap button DISABLED (no user).');
                        }
                        if (userInfo) userInfo.classList.add('hidden');
                        if (logoutBtn) logoutBtn.classList.add('hidden');
                        if (userEmail) userEmail.textContent = "";

                        // Limpiar datos
                        if (listContainer) listContainer.innerHTML = '<p class="text-gray-500 font-semibold">Inicia sesión para ver tus datos.</p>';
                        allPoisData = []; 
                        poiDataMap.clear(); 
                        
                        // Forzar navegación a Login
                        navigateTo('login');
                    }
                });
                console.log("Auth state listener attached.");

            } catch (initError) { 
                console.error("Firebase Initialization Error:", initError);
                firebaseReady = false; 
                 if (gotoMapButton) gotoMapButton.disabled = true; 
                const errorMsg = `Error fatal al inicializar Firebase: ${initError.message}. Verifica la config y la conexión.`;
                if(loadingPois) loadingPois.textContent = errorMsg;
                showMessage(errorMsg, 10000);
            }
        }
        
        // --- Nuevas Funciones de Auth ---
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            if (!auth) {
                 console.error("Auth no inicializado.");
                 showMessage("Error: Servicio de autenticación no listo.", 3000);
                 return;
            }
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged se encargará del resto
            } catch (error) {
                console.error("Error Google Login:", error);
                showMessage("Error al iniciar sesión: " + error.message, 5000);
            }
        }

        async function handleLogout() {
             if (!auth) {
                 console.error("Auth no inicializado.");
                 return;
             }
            try {
                await signOut(auth);
                showMessage("Sesión cerrada.", 2000);
                // onAuthStateChanged se encargará de navegar a login
            } catch (error) {
                console.error("Error Logout:", error);
                showMessage("Error al cerrar sesión.", 3000);
            }
        }


        function displayAppVersion() {
             // ... (no changes) ...
             if (versionDisplay) {
                 versionDisplay.textContent = `v${APP_VERSION}`; 
                 console.log(`App Version ${APP_VERSION} displayed.`);
             } else { 
                 console.warn("Version display element not found.");
             }
        }

        function initializeModelSelection() {
             // ... (no changes) ...
             console.log("Initializing model selection UI based on current modelsToPlace:", modelsToPlace); 
             if (!ecopiensaSelectionList || !loadingModelsPlaceholder || !selectVideoCheckbox) { 
                 console.error("Required elements for model selection not found."); 
                 return; 
             }

            loadingModelsPlaceholder.style.display = 'none'; 
            
            ecopiensaSelectionList.innerHTML = ''; 
            ECOPIENSA_MODELS.forEach(model => {
                // Check if currently selected in modelsToPlace state
                const isSelected = modelsToPlace.some(m => !m.isCustomVideo && m.url === model.modelUrl);
                 createCheckbox(model.name, model.modelUrl, isSelected, false, model.imageUrl); 
            });
             console.log("Model checkboxes created/updated based on modelsToPlace."); 
            
            selectVideoCheckbox.removeEventListener('change', handleVideoCheckboxChange);
            selectVideoCheckbox.addEventListener('change', handleVideoCheckboxChange);
            // Check if custom video is selected in modelsToPlace state
            selectVideoCheckbox.checked = modelsToPlace.some(m => m.isCustomVideo);

             console.log("Model/Video checkbox UI initialized/updated.");
        }
        
        function createCheckbox(name, url, isChecked, isVideoPlaceholder = false, imageUrl = '') {
             // ... (no changes) ...
             if (!ecopiensaSelectionList) return; 

             const label = document.createElement('label');
             label.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer';
             const input = document.createElement('input');
             input.type = 'checkbox';
             input.className = 'model-select-cb h-5 w-5 text-blue-600';
             input.dataset.name = name;
             input.dataset.url = url; 
             input.checked = isChecked; 
             input.dataset.imageUrl = imageUrl; 
             if (isVideoPlaceholder) {
                 input.dataset.isCustomVideo = "true";
             } 
             
             input.removeEventListener('change', handleCheckboxChange); 
             input.addEventListener('change', handleCheckboxChange); 

             const span = document.createElement('span');
             span.textContent = name;
             
             label.appendChild(input);
             label.appendChild(span);
             ecopiensaSelectionList.appendChild(label);
        }

         function handleVideoCheckboxChange(e) {
             // ... (no changes) ...
             const placeholderExists = modelsToPlace.some(m => m.isCustomVideo);
             if (e.target.checked) {
                 if (!placeholderExists) {
                     modelsToPlace.push({...CUSTOM_VIDEO_PLACEHOLDER});
                 }
             } else {
                 if (placeholderExists) {
                     modelsToPlace = modelsToPlace.filter(m => !m.isCustomVideo);
                 }
             }
             saveSelectionToLocalStorage(); // Save after change
             console.log("Models to place (video toggle):", modelsToPlace);
         }

        function handleCheckboxChange(e) {
             // ... (no changes) ...
             const itemData = { 
                 name: e.target.dataset.name, 
                 url: e.target.dataset.url, 
                 isCustomVideo: e.target.dataset.isCustomVideo === "true",
                 imageUrl: e.target.dataset.imageUrl || '' 
             };
             const itemExists = modelsToPlace.some(m => m.url === itemData.url); 
             
             if (e.target.checked) {
                 if (!itemExists) {
                     modelsToPlace.push(itemData);
                 }
             } else {
                 if (itemExists) {
                     modelsToPlace = modelsToPlace.filter(m => m.url !== itemData.url);
                 }
             }
             saveSelectionToLocalStorage(); // Save after change
             console.log("Models to place updated:", modelsToPlace);
         }

        function loadAndListenPois() {
             // ... (no changes) ...
             if (!poiCollectionRef) { 
                 console.warn("loadAndListenPois called before poiCollectionRef is set (user might be logged out)."); 
                 if (loadingPois && !loadingPois.textContent.toLowerCase().includes("error")) loadingPois.textContent = "Esperando inicio de sesión..."; 
                 return; 
             }
             if (!listContainer || !loadingPois) { 
                  console.error("loadAndListenPois called but listContainer or loadingPois element not found."); 
                 return; 
             }
             
             if (loadingPois && !loadingPois.textContent.toLowerCase().includes("error")) {
                 loadingPois.textContent = "Cargando puntos guardados..."; 
                 loadingPois.style.display = 'block'; 
             }
             const q = query(poiCollectionRef);
             
             onSnapshot(q, (querySnapshot) => {
                 console.log("Firestore snapshot received."); 
                 if (!listContainer || !loadingPois) return; 
                 
                 loadingPois.style.display = 'none'; 
                 allPoisData = []; 
                 poiDataMap.clear(); 
                 // Clear only if admin page is active, otherwise let map update handle it
                 if (pages.admin?.classList.contains('active')) {
                     listContainer.innerHTML = ''; 
                 }

                 if (querySnapshot.empty) {
                     console.log("Query snapshot is empty."); 
                     if (pages.admin?.classList.contains('active')) {
                        listContainer.innerHTML = '<p class="text-gray-500">No hay contenido guardado en Firebase.</p>';
                     } 
                     if (map && pages.map?.classList.contains('active')) { 
                          updateMapMarkersAndPlacedList(); 
                      }
                     return;
                 }

                 querySnapshot.forEach((doc) => {
                     const poi = { id: doc.id, ...doc.data() }; 
                     allPoisData.push(poi); 
                     poiDataMap.set(poi.id, poi); 

                     // Populate Admin list (Page 1) ONLY if admin page is active
                     if (pages.admin?.classList.contains('active')) {
                         const poiElement = document.createElement('div');
                         poiElement.className = 'poi-item p-4 border border-gray-200 rounded-lg shadow-sm grid grid-cols-2 md:grid-cols-4 gap-4 items-center';
                         let typeLabel = poi.poiType === 'video' ? 'Video' : 'Modelo 3D';
                         let urlToShow = poi.poiType === 'video' ? (poi.videoUrl || 'N/A') : (poi.modelUrl || 'N/A'); 
                         if (urlToShow.length > 30) urlToShow = urlToShow.substring(0, 27) + '...'; 

                         poiElement.innerHTML = `
                             <div>
                                 <strong class="block text-sm text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                                 <span class="block text-xs ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                                 <span class="block text-xs text-gray-500" title="${poi.poiType === 'video' ? poi.videoUrl : poi.modelUrl}">URL: ${urlToShow}</span>
                             </div>
                             <div class="text-sm">
                                 <span class="block">Lat: ${poi.lat?.toFixed(6) || 'N/A'}</span>
                                 <span class="block">Lon: ${poi.lon?.toFixed(6) || 'N/A'}</span>
                             </div>
                             <div class="text-sm">
                                 <span class="block">Inicia: ${poi.startDate || 'N/A'}</span>
                                 <span class="block">Termina: ${poi.endDate || 'N/A'}</span>
                             </div>
                             <div class="text-right">
                                 <button data-id="${poi.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300">
                                     Eliminar
                                 </button>
                             </div>
                         `;
                         listContainer.appendChild(poiElement);
                     }
                 });
                 
                 console.log(`Local cache 'allPoisData' updated with ${allPoisData.length} POIs.`); 
                 
                 // Update map if it's active
                 if (map && pages.map?.classList.contains('active')) {
                     console.log("Map page is active, calling updateMapMarkersAndPlacedList...");
                     updateMapMarkersAndPlacedList();
                     populatePlacementPanel(); 
                 } else {
                     console.log("Map page is not active, skipping map update.");
                 }
                 
                 // Actualizar resumen si está activo
                 if (pages.summary?.classList.contains('active')) {
                     populateSummaryPage();
                 }

             }, (error) => {
                 console.error("Error listening to POIs (Firestore):", error);
                 if (loadingPois) loadingPois.style.display = 'none'; 
                 if (listContainer) listContainer.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar datos de Firestore: ${error.message}. Verifica las reglas de seguridad y la conexión.</p>`;
                 allPoisData = []; 
                 poiDataMap.clear();
                 showMessage("Error al actualizar la lista de contenido.", 5000);
             });
        }
        
        function initMap() {
             // ... (no changes) ...
             console.log("Initializing Map..."); 
             if (!firebaseReady || !poiCollectionRef) { 
                 showMessage("La base de datos no está lista. Por favor espere...", 3000);
                console.warn("Attempted to initMap before Firebase was ready.");
                navigateTo('login'); // Forzar login si se intenta entrar al mapa sin estar listo
                return; 
             }
             if (map) { 
                 console.log("Map already exists. Invalidating size.");
                setTimeout(() => { if (map) map.invalidateSize(); }, 100); 
                 populatePlacementPanel(); 
                 updateMapMarkersAndPlacedList(); 
                 return; 
             }

            const mapContainer = document.getElementById('map-canvas');
             if (!mapContainer) { console.error("Map container element not found."); return; }
             const defaultCenter = [4.0835, -76.1915]; 
            map = L.map(mapContainer, { zoomControl: false, preferCanvas: true }).setView(defaultCenter, 15);

             L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 22, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: 'Imagery &copy;2025 Google' }).addTo(map);

             updateMapMarkersAndPlacedList(); // Initial population
             populatePlacementPanel(); // Populate available models
             cancelPlacement(); // Ensure placement form is hidden initially
             cancelEditLocation(); // Ensure edit form is hidden initially

             map.off('move', updateCenterCoordsDisplay); 
             map.on('move', updateCenterCoordsDisplay); 
             updateCenterCoordsDisplay(); 
             console.log("Map 'move' listener attached for center coords display."); 

             if (mapZoomSlider) { 
                 mapZoomSlider.value = map.getZoom();
                 mapZoomSlider.removeEventListener('input', handleZoomSlider); 
                 mapZoomSlider.addEventListener('input', handleZoomSlider);
             }
             map.off('zoomend', handleMapZoomEnd); 
             map.on('zoomend', handleMapZoomEnd);
             
             if (jumptoBtn) { 
                 jumptoBtn.removeEventListener('click', jumpToCoords); 
                 jumptoBtn.addEventListener('click', jumpToCoords); 
             }

             if (placePoiTypeSelect) { 
                 placePoiTypeSelect.removeEventListener('change', handlePoiTypeChange);
                 placePoiTypeSelect.addEventListener('change', handlePoiTypeChange);
                 handlePoiTypeChange(); 
              }
             
             if (placedPoisList) {
               placedPoisList.removeEventListener('click', handleDeletePoiOnMap);
                placedPoisList.addEventListener('click', handleDeletePoiOnMap);
               console.log("Delete listener attached to placed POIs list on map.");
            }

             setTimeout(() => { if (map) map.invalidateSize(); }, 200); 
             console.log("Map initialization complete.");
        }
        
         function updateCenterCoordsDisplay() {
             // ... (no changes) ...
             if (map && mapCenterCoordsEl) {
                 const center = map.getCenter();
                 mapCenterCoordsEl.innerHTML = `
                     <span>Lat: ${center.lat.toFixed(6)}</span>
                     <span>Lon: ${center.lng.toFixed(6)}</span>
                 `;
             } else if (!mapCenterCoordsEl) { 
                 if (typeof mapCenterCoordsEl === 'undefined' || mapCenterCoordsEl === null) {
                     if(!window.mapCenterCoordsElWarned) {
                         // console.warn("mapCenterCoordsEl not found during update."); 
                         window.mapCenterCoordsElWarned = true; 
                      } 
                 }
             }
         }

        function updateMapMarkersAndPlacedList() {
             // ... (no changes) ...
             if (!map || !placedPoisList) {
                 console.warn("Cannot update map markers/list: Map or list element not ready.");
                 return;
             }
             console.log("Updating map markers and placed POIs list...");
             
             Object.values(poiMarkers).forEach(marker => { 
                 if (map.hasLayer(marker)) map.removeLayer(marker);
            });
             poiMarkers = {}; 
             placedPoisList.innerHTML = ''; 
             
             let hasPois = false;
             allPoisData.forEach(poi => { 
                 hasPois = true;
                 if (typeof poi.lat === 'number' && typeof poi.lon === 'number') { 
                     let iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png'; 
                      if (poi.poiType === 'video') {
                        iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png'; 
                      } 
                     
                     let popupImageUrl = '';
                     if (poi.poiType === 'model' && poi.modelUrl) {
                         const ecoModel = ECOPIENSA_MODELS.find(m => m.modelUrl === poi.modelUrl);
                         if (ecoModel) popupImageUrl = ecoModel.imageUrl;
                     } else if (poi.poiType === 'video') {
                         popupImageUrl = CUSTOM_VIDEO_PLACEHOLDER.imageUrl; 
                      }

                     let popupContent = `<b>${poi.name || 'No Name'}</b> (${poi.poiType || 'model'})`;
                     if (popupImageUrl) {
                         popupContent += `<br><img src="${popupImageUrl}" alt="Preview" class="popup-image" onerror="this.style.display='none'">`;
                     }

                     const marker = L.marker([poi.lat, poi.lon], { 
                          icon: L.icon({
                              iconUrl: iconUrl,
                              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                              iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                         })
                     })
                         .addTo(map)
                         .bindPopup(popupContent); 
                     poiMarkers[poi.id] = marker; 
                 } else { console.warn("POI for map missing coordinates:", poi.id); } 
                 
                 const listItem = document.createElement('div');
                 listItem.className = 'placed-poi-item p-2 border-b flex justify-between items-center';
                 listItem.innerHTML = `
                     <span class="text-sm font-medium">${poi.name || 'No Name'}</span>
                     <div>
                         <button data-id="${poi.id}" class="edit-location-btn bg-amber-500 hover:bg-amber-600 text-white text-xs px-2 py-1 rounded">
                             Edit Loc.
                         </button>
                         <button data-id="${poi.id}" class="delete-btn-map"> 
                             Del
                         </button>
                     </div>
                 `;
                 const editBtn = listItem.querySelector('.edit-location-btn');
                 editBtn.removeEventListener('click', handleEditLocationClick); 
                 editBtn.addEventListener('click', handleEditLocationClick);
                 placedPoisList.appendChild(listItem);
             });
             
             if (!hasPois) { 
                 placedPoisList.innerHTML = '<p class="text-sm text-gray-500">No content saved on map yet.</p>';
             }
             console.log(`Updated ${Object.keys(poiMarkers).length} markers and placed POIs panel.`);
        }

        function handlePoiTypeChange() {
             // ... (no changes) ...
             if (!placePoiTypeSelect || !modelFieldsDiv || !videoFieldsDiv || !placeModelUrlInput || !placeVideoUrlInput) { console.error("POI type change handler missing required form elements."); return; }
             const selectedType = placePoiTypeSelect.value;
             const isVideo = selectedType === 'video';
             
             modelFieldsDiv.classList.toggle('hidden', isVideo);
             videoFieldsDiv.classList.toggle('hidden', !isVideo);
             
             placeModelUrlInput.disabled = isVideo;
             placeVideoUrlInput.disabled = !isVideo;

             const scaleLabel = document.querySelector('label[for="place-scale"]');
             if (scaleLabel) { scaleLabel.textContent = isVideo ? 'Ancho del Video (metros)' : 'Escala del Modelo'; }
        }

         function handleEditLocationClick(e) {
             // ... (no changes) ...
             const poiId = e.target?.dataset?.id; 
             if (poiId) { startEditLocation(poiId); } 
             else { console.error("Could not get POI ID from edit button."); }
        }

        function startEditLocation(poiId) {
             // ... (no changes) ...
             if (isPlacingModel) cancelPlacement(); 
             const poiData = poiDataMap.get(poiId); 
             const marker = poiMarkers[poiId];
             if (!poiData || !marker) { showMessage("Error: Could not find POI data or marker.", 4000); return; }
             if (!map) { showMessage("Map is not initialized.", 3000); return; }

             isEditingLocation = true;
             currentEditingPoiId = poiId;
             currentEditingMarker = marker; 

             if (editingPoiNameEl) editingPoiNameEl.textContent = `Moviendo: ${poiData.name || 'No Name'}`;
             if (placementPanel) placementPanel.classList.add('hidden'); 
             if (placedPoisPanel) placedPoisPanel.classList.add('hidden'); 
             if (editLocationPanel) editLocationPanel.classList.remove('hidden'); 

             map.setView(marker.getLatLng(), 19); 
             showMessage("Modo Edición: Mueve el mapa y guarda la nueva ubicación.", 4000);
        }

        function cancelEditLocation() {
             // ... (no changes) ...
             isEditingLocation = false;
             currentEditingPoiId = null;
             currentEditingMarker = null;
             if (placementPanel) placementPanel.classList.remove('hidden'); 
             if (placedPoisPanel) placedPoisPanel.classList.remove('hidden'); 
             if (editLocationPanel) editLocationPanel.classList.add('hidden'); 
        }
        
        async function handleSaveEditLocation() {
             // ... (no changes) ...
             if (!isEditingLocation || !map || !poiCollectionRef || !currentEditingPoiId || !saveEditLocationBtn) { return; }

             const newLatLng = map.getCenter(); 
             showMessage('Actualizando ubicación...', 2000);
             saveEditLocationBtn.disabled = true;
             saveEditLocationBtn.textContent = 'Guardando...';

             try {
                 const docRef = doc(db, poiCollectionRef.path, currentEditingPoiId);
                 await updateDoc(docRef, { lat: newLatLng.lat, lon: newLatLng.lng });
                 showMessage('Ubicación actualizada!', 3000);
                 cancelEditLocation(); 
             } catch (error) {
                 console.error("Error updating location:", error);
                 showMessage("Error guardando nueva ubicación.", 5000);
             } finally { 
                 if (saveEditLocationBtn) { 
                     saveEditLocationBtn.disabled = false; 
                     saveEditLocationBtn.textContent = 'Guardar Nueva Ubicación (en la Cruz)'; 
                 }
             }
        }

        function handleZoomSlider(e) { if (map) map.setZoom(parseFloat(e.target.value)); }
        function handleMapZoomEnd() { if (map && mapZoomSlider) mapZoomSlider.value = map.getZoom(); }
        function jumpToCoords() { 
             // ... (no changes) ...
             const latInput = document.getElementById('jumpto-lat');
             const lonInput = document.getElementById('jumpto-lon');
             if (!latInput || !lonInput) return; 
             const lat = parseFloat(latInput.value);
             const lon = parseFloat(lonInput.value);
             if (isNaN(lat) || isNaN(lon) || !map) { showMessage("Ingresa latitud y longitud válidas.", 3000); return; }
             map.setView([lat, lon], 18); 
         }

        function populatePlacementPanel() {
             // ... (no changes, still shows all selected models) ...
             if (!firebaseReady || !poiCollectionRef || !modelsToPlaceList) { 
                 console.warn("Cannot populate placement panel: Firebase not ready or DOM elements missing.");
                 if (modelsToPlaceList) modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">Esperando conexión a base de datos...</p>';
                 return; 
             }
             
             console.log("Populating placement panel. Current modelsToPlace:", modelsToPlace);

             modelsToPlaceList.innerHTML = ''; // Clear previous buttons 
             
             // Display buttons for ALL currently selected models (from localStorage state)
             if (modelsToPlace.length === 0) { 
                 modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">No hay contenido seleccionado. Vuelve al Panel.</p>';
                 return; 
             }

             modelsToPlace.forEach((item) => {
                 const button = document.createElement('button'); 
                 button.className = 'place-btn control-button bg-blue-500 hover:bg-blue-600 w-full text-left'; 
                 button.textContent = `Posicionar ${item.name}`; 
                 button.dataset.name = item.name; 
                 button.dataset.url = item.url; 
                 button.dataset.imageUrl = item.imageUrl || ''; 
                 if (item.isCustomVideo) { button.dataset.isCustomVideo = "true"; }
                 
                 button.removeEventListener('click', handlePlaceButtonClick); 
                 button.addEventListener('click', handlePlaceButtonClick); 
                 
                 modelsToPlaceList.appendChild(button); 
             });
             console.log(`Populated placement panel with ${modelsToPlace.length} items.`);
        }
        
        function handlePlaceButtonClick(e) {
             // ... (no changes) ...
            const targetUrl = e.target.dataset.url;
            // Find data directly from the button's dataset or the original arrays if needed
            const itemData = {
                name: e.target.dataset.name,
                url: targetUrl,
                imageUrl: e.target.dataset.imageUrl,
                isCustomVideo: e.target.dataset.isCustomVideo === "true"
            };
            // Check if this item still exists in the global modelsToPlace state
            const itemExistsInState = modelsToPlace.some(m => m.url === targetUrl);
            if (itemExistsInState) {
                startPlacement(itemData); 
            } else { 
                console.error("Attempted to place item no longer in modelsToPlace state:", itemData);
                showMessage("Error: Este item ya no está seleccionado.", 4000);
                populatePlacementPanel(); // Refresh list
            }
        }

        function startPlacement(itemData) { 
             // ... (no changes) ...
             console.log("Starting placement for:", itemData); 
             const isCustomVideo = itemData.isCustomVideo === true;

            isPlacingModel = true;
            currentPlacingModel = { ...itemData }; // Store the data passed in
            if (placingModelName) placingModelName.textContent = `Posicionando: ${currentPlacingModel.name}`;
            
            if (placementPreviewImageEl && itemData.imageUrl) {
                console.log("Setting preview image:", itemData.imageUrl);
                placementPreviewImageEl.src = itemData.imageUrl;
                placementPreviewImageEl.style.display = 'block';
                placementPreviewImageEl.onerror = () => { 
                      console.warn("Could not load preview image:", itemData.imageUrl); 
                     placementPreviewImageEl.style.display = 'none'; 
                      placementPreviewImageEl.onerror = null; 
                 };
            } else if(placementPreviewImageEl) { 
                 console.log("No preview image URL found for this item.");
                 placementPreviewImageEl.style.display = 'none'; 
             } else { 
                 console.warn("placementPreviewImageEl not found.");
            }

             if (placePoiTypeSelect) { 
                 placePoiTypeSelect.value = isCustomVideo ? 'video' : 'model';
                 handlePoiTypeChange(); 
             }
             if (placeNameInput) placeNameInput.value = currentPlacingModel.name; 
             if (placeModelUrlInput) placeModelUrlInput.value = isCustomVideo ? '' : currentPlacingModel.url;
             if (placeVideoUrlInput) placeVideoUrlInput.value = isCustomVideo ? '' : '';
             
             const soundUrlInput = document.getElementById('place-sound-url');
             if (soundUrlInput) soundUrlInput.value = '';
             const scaleInput = document.getElementById('place-scale');
             if (scaleInput) scaleInput.value = '1.0';
             const heightInput = document.getElementById('place-ground-height');
             if (heightInput) heightInput.value = '0.0';
             
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0];
             const startDateInput = document.getElementById('place-start-date');
             if (startDateInput) startDateInput.value = today;
             const endDateInput = document.getElementById('place-end-date');
             if (endDateInput) endDateInput.value = nextMonth;

             if (modelsToPlaceList) modelsToPlaceList.classList.add('hidden'); 
             if (placementFormContainer) placementFormContainer.classList.remove('hidden'); 
             
             showMessage(`Mueve el mapa y presiona 'Guardar Ubicación'`);
        }

        function cancelPlacement() { 
             // ... (no changes needed here, still resets button and calls populatePlacementPanel) ...
             isPlacingModel = false;
             currentPlacingModel = {};
             if (placementFormContainer) placementFormContainer.classList.add('hidden'); 
             if (modelsToPlaceList) modelsToPlaceList.classList.remove('hidden'); 
             if (placementPreviewImageEl) placementPreviewImageEl.style.display = 'none'; 
             
             if (savePlacementBtn) {
                 savePlacementBtn.disabled = false;
                 savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)';
             }

             // Refresh list immediately when cancelling/going back
             populatePlacementPanel(); 
             
             console.log("Placement cancelled/returned to selection.");
        }
        
        async function handleSavePlacement() { 
             // MODIFIED: Does NOT remove item from modelsToPlace or saveSelectionToLocalStorage
             if (!isPlacingModel || !map || !poiCollectionRef || !savePlacementBtn || !currentPlacingModel.url) { 
                 console.error("Save placement called in invalid state:", {isPlacingModel, map, poiCollectionRef, savePlacementBtn, currentPlacingModel});
                 if (savePlacementBtn) {
                     savePlacementBtn.disabled = false;
                     savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)';
                 }
                 return; 
             }

             const latlng = map.getCenter(); 
             showMessage('Guardando...', 2000); 
             savePlacementBtn.disabled = true; 
             savePlacementBtn.textContent = 'Guardando...'; 

             let newPoi = null; 
             try {
                 const poiType = placePoiTypeSelect.value;
                 let modelUrl = '';
                 let videoUrl = '';
                 let name = placeNameInput.value.trim(); 

                 if (!name) throw new Error("El nombre descriptivo es obligatorio.");

                 if (poiType === 'video') { 
                     if (!currentPlacingModel.isCustomVideo) {
                         throw new Error("Error interno: Intentando guardar video sin seleccionar placeholder.");
                     }
                     videoUrl = placeVideoUrlInput.value.trim();
                     if (!videoUrl) throw new Error("La URL del video es obligatoria para el tipo Video.");
                     if (!videoUrl.startsWith('http') || !videoUrl.toLowerCase().endsWith('.mp4')) {
                         console.warn("El formato de la URL del video podría ser inválido:", videoUrl);
                     } 
                     modelUrl = ''; 
                 } else { 
                     if (currentPlacingModel.isCustomVideo) { 
                         throw new Error("Error interno: Intentando guardar modelo usando placeholder de video.");
                     }
                     modelUrl = currentPlacingModel.url; 
                     if (!modelUrl) throw new Error("La URL del modelo es obligatoria para el tipo Modelo 3D."); 
                     videoUrl = ''; 
                 }

                newPoi = { 
                     name: name, 
                     poiType: poiType, 
                     modelUrl: modelUrl, 
                     videoUrl: videoUrl, 
                     soundUrl: document.getElementById('place-sound-url')?.value.trim() || "", 
                     lat: latlng.lat,
                     lon: latlng.lng,
                     scale: parseFloat(document.getElementById('place-scale')?.value || "1.0"), 
                     groundHeight: parseFloat(document.getElementById('place-ground-height')?.value || "0.0"), 
                     startDate: document.getElementById('place-start-date')?.value || "", 
                     endDate: document.getElementById('place-end-date')?.value || "" 
                 };

                 // Validations... 
                 if (isNaN(newPoi.scale) || isNaN(newPoi.groundHeight)) throw new Error("La Escala y Altura deben ser números válidos.");
                 if (newPoi.scale <= 0) throw new Error("La Escala debe ser positiva.");
                 if (!newPoi.startDate || !newPoi.endDate) throw new Error("Las fechas de Inicio y Fin son obligatorias.");
                 const startDate = new Date(newPoi.startDate);
                 const endDate = new Date(newPoi.endDate);
                 if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) throw new Error("Formato de fecha inválido.");
                 if (endDate < startDate) throw new Error("La fecha de Fin no puede ser anterior a la de Inicio.");

                 // Save to Firestore
                 const docRef = await addDoc(poiCollectionRef, newPoi); 
                 console.log("POI saved with ID:", docRef.id);
                 
                 showMessage(`'${newPoi.name}' guardado exitosamente!`, 3000); 

                 // --- DO NOT Remove from 'modelsToPlace' state or localStorage here ---
                 
                 // --- DO NOT Uncheck checkbox ---
                 
                 // Reset placement state and show the list again
                 cancelPlacement(); 

             } catch (error) { 
                 console.error("Error saving POI: ", error);
                 showMessage("Error al guardar: " + error.message, 5000);
                 // Explicitly re-enable button on error 
                 if (savePlacementBtn) { 
                     savePlacementBtn.disabled = false; 
                     savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)'; 
                 }
             } 
         }

        // --- Delete POI from Map Page ---
        async function handleDeletePoiOnMap(e) {
             // ... (no changes) ...
             if (e.target && e.target.classList.contains('delete-btn-map')) { 
                 const docId = e.target.getAttribute('data-id');
                 const button = e.target; 
                 if (!docId || button.disabled) return;

                 if (!button.classList.contains('confirm')) {
                     button.textContent = 'Sure?';
                     button.classList.add('confirm');
                     setTimeout(() => {
                         const currentButton = placedPoisList?.querySelector(`.delete-btn-map[data-id="${docId}"]`);
                         if (currentButton && currentButton.classList.contains('confirm')) { 
                             currentButton.textContent = 'Del';
                             currentButton.classList.remove('confirm');
                         }
                     }, 3000);
                     return; 
                 }

                 if (!firebaseReady || !poiCollectionRef) { 
                     showMessage("Error: La base de datos no está lista para eliminar.", 4000);
                     button.textContent = 'Del'; 
                     button.classList.remove('confirm');
                     return; 
                 }
                 
                 try {
                     button.disabled = true;
                     button.textContent = '...'; 
                     const docRef = doc(db, poiCollectionRef.path, docId);
                     await deleteDoc(docRef);
                     showMessage('Punto de interés eliminado.', 3000);
                 } catch (error) {
                     console.error("Error deleting document from map page: ", error);
                     showMessage("No se pudo eliminar el documento.", 5000);
                     const currentButton = placedPoisList?.querySelector(`.delete-btn-map[data-id="${docId}"]`);
                     if (currentButton) { 
                         currentButton.disabled = false;
                         currentButton.textContent = 'Del';
                         currentButton.classList.remove('confirm');
                     }
                 }
             }
         }
        
         // --- FUNCIÓN DE RESUMEN IMPLEMENTADA ---
         function populateSummaryPage() {
             if (!summaryPoiList || !loadingSummaryPois) {
                  console.error("Summary page elements not found.");
                  return;
             }
             
             console.log("Populating summary page with allPoisData:", allPoisData);
             loadingSummaryPois.style.display = 'none';
             summaryPoiList.innerHTML = ''; // Clear list

             if (allPoisData.length === 0) {
                 summaryPoiList.innerHTML = '<p class="text-gray-500">No hay contenido configurado para mostrar.</p>';
                 return;
             }

             allPoisData.forEach(poi => {
                 const poiElement = document.createElement('div');
                 poiElement.className = 'poi-item p-4 border border-gray-200 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4 items-center';
                 
                 let typeLabel = poi.poiType === 'video' ? 'Video' : 'Modelo 3D';
                 let urlToShow = poi.poiType === 'video' ? (poi.videoUrl || 'N/A') : (poi.modelUrl || 'N/A');
                 if (urlToShow.length > 30) urlToShow = urlToShow.substring(0, 27) + '...';

                 let imageUrl = '';
                 if (poi.poiType === 'model' && poi.modelUrl) {
                     const ecoModel = ECOPIENSA_MODELS.find(m => m.modelUrl === poi.modelUrl);
                     if (ecoModel) imageUrl = ecoModel.imageUrl;
                 } else if (poi.poiType === 'video') {
                     imageUrl = CUSTOM_VIDEO_PLACEHOLDER.imageUrl;
                 }

                 poiElement.innerHTML = `
                     <div class="flex items-center gap-4">
                         ${imageUrl ? `<img src="${imageUrl}" alt="Preview" class="w-16 h-16 rounded-md object-cover border" onerror="this.style.display='none'">` : '<div class="w-16 h-16 rounded-md bg-gray-100 border"></div>'}
                         <div>
                             <strong class="block text-lg text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                             <span class="block text-sm ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                         </div>
                     </div>
                     <div class="text-sm">
                         <span class="block"><strong>Ubicación:</strong></span>
                         <span class="block">Lat: ${poi.lat?.toFixed(6) || 'N/A'}</span>
                         <span class="block">Lon: ${poi.lon?.toFixed(6) || 'N/A'}</span>
                     </div>
                     <div class="text-sm">
                         <span class="block"><strong>Vigencia:</strong></span>
                         <span class="block">Inicia: ${poi.startDate || 'N/A'}</span>
                         <span class="block">Termina: ${poi.endDate || 'N/A'}</span>
                     </div>
                 `;
                 summaryPoiList.appendChild(poiElement);
             });
         }

         async function startARFlow() { 
             // ... (no changes) ...
         }
        async function initializeARScene() { 
             // ... (no changes) ...
        }
        function stopAR() { 
             // ... (no changes) ...
        }

        function onGPSUpdate(event) { 
             // ... (no changes) ...
        }
        function onGPSError(event) { 
             // ... (no changes) ...
        }
        function startGPSWatch() { 
             // ... (no changes) ...
        }


        // =================================================================
        // --- SECCIÓN CORREGIDA (Listeners de Navegación) ---
        // =================================================================

         function setupNavigationListeners() {
            console.log("Setting up navigation listeners...");

            // --- Página 1: Admin ---
            const gotoMapBtn = document.getElementById('goto-map-btn');
            if (gotoMapBtn) {
                gotoMapBtn.addEventListener('click', handleGoToMap);
                console.log("Listener added for: goto-map-btn");
            } else {
                console.warn("Button not found: goto-map-btn");
            }

            // --- Página 2: Mapa ---
            const backToAdminBtn = document.getElementById('back-to-admin-btn');
            if (backToAdminBtn) {
                backToAdminBtn.addEventListener('click', handleBackToAdmin);
                console.log("Listener added for: back-to-admin-btn");
            } else {
                console.warn("Button not found: back-to-admin-btn");
            }

            const gotoSummaryBtn = document.getElementById('goto-summary-btn');
            if (gotoSummaryBtn) {
                gotoSummaryBtn.addEventListener('click', handleGoToSummary);
                console.log("Listener added for: goto-summary-btn");
            } else {
                console.warn("Button not found: goto-summary-btn");
            }

            // --- Página 3: Resumen ---
            const backToMapBtn = document.getElementById('back-to-map-btn');
            if (backToMapBtn) {
                backToMapBtn.addEventListener('click', handleGoToMap); // Reutiliza handleGoToMap
                console.log("Listener added for: back-to-map-btn");
            } else {
                console.warn("Button not found: back-to-map-btn");
            }

            const launchArBtn = document.getElementById('launch-ar-btn');
            if (launchArBtn) {
                launchArBtn.addEventListener('click', handleLaunchAR);
                console.log("Listener added for: launch-ar-btn");
            } else {
                console.warn("Button not found: launch-ar-btn");
            }

            // --- Página 4: AR ---
            const backToSummaryBtn = document.getElementById('back-to-summary-btn');
            if (backToSummaryBtn) {
                backToSummaryBtn.addEventListener('click', handleBackToSummary);
                console.log("Listener added for: back-to-summary-btn");
            } else {
                console.warn("Button not found: back-to-summary-btn");
            }

            // --- Modal de Permisos ---
            const grantPermissionsBtn = document.getElementById('grant-permissions-btn');
            if (grantPermissionsBtn) {
                grantPermissionsBtn.addEventListener('click', handleGrantPermissions);
                console.log("Listener added for: grant-permissions-btn");
            } else {
                console.warn("Button not found: grant-permissions-btn");
            }
         }

         function handleGoToMap() { console.log("goto-map clicked"); navigateTo('map'); } 
         function handleGoToSummary() { console.log("goto-summary clicked"); navigateTo('summary'); } 
         function handleBackToAdmin() { console.log("back-to-admin clicked"); navigateTo('admin'); } 
         function handleLaunchAR() { console.log("launch-ar clicked"); navigateTo('ar'); } 
         function handleBackToSummary() { console.log("back-to-summary clicked"); navigateTo('summary'); } 
         function handleGrantPermissions() { 
             console.log("grant-permissions clicked");
             if (permissionModal) permissionModal.style.display = 'none';
             startARFlow(); 
         }

        // =================================================================
        // --- FIN DE SECCIÓN CORREGIDA ---
        // =================================================================


        // --- App Initialization (DOMContentLoaded) --- 
         document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed.");
             
             // Asignar referencias a elementos DOM aquí
             pages.login = document.getElementById('login-page');
             pages.admin = document.getElementById('admin-page');
             pages.map = document.getElementById('map-page');
             pages.summary = document.getElementById('summary-page');
             pages.ar = document.getElementById('ar-page');
             
             messageBox = document.getElementById('message-box');
             permissionModal = document.getElementById('permission-modal');
             arLoadingScreen = document.getElementById('ar-loading-screen');
             loadingStatusText = document.getElementById('loading-status-text');
             versionDisplay = document.getElementById('version-display'); 
             
             // Refs de Auth
             loginPage = document.getElementById('login-page');
             googleLoginBtn = document.getElementById('google-login-btn');
             logoutBtn = document.getElementById('logout-btn');
             userInfo = document.getElementById('user-info');
             userEmail = document.getElementById('user-email');

             // Refs Página Admin
             listContainer = document.getElementById('poi-list-container');
             loadingPois = document.getElementById('loading-pois');
             ecopiensaSelectionList = document.getElementById('ecopiensa-selection-list');
             loadingModelsPlaceholder = document.getElementById('loading-models-placeholder');
             selectVideoCheckbox = document.getElementById('select-video-cb');
             gotoMapButton = document.getElementById('goto-map-btn'); 
             clearSelectionBtn = document.getElementById('clear-selection-btn'); 

             // Refs Página Mapa
             placementPanel = document.getElementById('placement-panel');
             modelsToPlaceList = document.getElementById('models-to-place-list');
             placementFormContainer = document.getElementById('placement-form-container');
             placingModelName = document.getElementById('placing-model-name');
             cancelPlacementBtn = document.getElementById('cancel-placement-btn');
             savePlacementBtn = document.getElementById('save-placement-btn');
             backToSelectionBtn = document.getElementById('back-to-selection-btn'); 
             mapZoomSlider = document.getElementById('map-zoom-slider');
             jumptoBtn = document.getElementById('jumpto-btn');
             placePoiTypeSelect = document.getElementById('place-poi-type');
             modelFieldsDiv = document.getElementById('model-fields');
             videoFieldsDiv = document.getElementById('video-fields');
             placeModelUrlInput = document.getElementById('place-model-url');
             placeVideoUrlInput = document.getElementById('place-video-url');
             placeNameInput = document.getElementById('place-name');
             placedPoisPanel = document.getElementById('placed-pois-panel');
             placedPoisList = document.getElementById('placed-pois-list');
             editLocationPanel = document.getElementById('edit-location-panel');
             editingPoiNameEl = document.getElementById('editing-poi-name');
             saveEditLocationBtn = document.getElementById('save-edit-location-btn');
             cancelEditLocationBtn = document.getElementById('cancel-edit-location-btn');
             mapCenterCoordsEl = document.getElementById('map-center-coords'); 
             placementPreviewImageEl = document.getElementById('placement-preview-image'); 

             // Refs Página Resumen
             summaryPoiList = document.getElementById('summary-poi-list');
             loadingSummaryPois = document.getElementById('loading-summary-pois');

             console.log("DOM element references obtained.");

             loadSelectionFromLocalStorage();
             displayAppVersion(); 
             initializeModelSelection(); 
             
             // Adjuntar listeners de Navegación
             setupNavigationListeners(); 

             // Adjuntar listeners de Auth
             if (googleLoginBtn) googleLoginBtn.addEventListener('click', handleGoogleLogin);
             if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

             // Adjuntar listeners de formularios y listas
             if (cancelPlacementBtn) cancelPlacementBtn.addEventListener('click', handleBackToAdmin); 
             if (backToSelectionBtn) backToSelectionBtn.addEventListener('click', cancelPlacement); 
             if (savePlacementBtn) savePlacementBtn.addEventListener('click', handleSavePlacement);
             if (saveEditLocationBtn) saveEditLocationBtn.addEventListener('click', handleSaveEditLocation);
             if (cancelEditLocationBtn) cancelEditLocationBtn.addEventListener('click', cancelEditLocation);
             if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSavedSelection); 
             
             if (listContainer) { // Listener for ADMIN page delete
                 listContainer.addEventListener('click', async (e) => {
                    // ... (sin cambios en la lógica de borrado de admin) ...
                     if (e.target && e.target.classList.contains('delete-btn')) { 
                         const docId = e.target.getAttribute('data-id');
                         const button = e.target; 
                         if (button.disabled) return;
                         
                         if (button.textContent.includes('Eliminar')) {
                             button.textContent = '¿Seguro? Clic otra vez';
                             button.classList.remove('bg-red-500', 'hover:bg-red-600');
                             button.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                             setTimeout(() => {
                                 const currentButton = listContainer?.querySelector(`.delete-btn[data-id="${docId}"]`);
                                 if (currentButton && currentButton.textContent.includes('Clic otra vez')) { 
                                     currentButton.textContent = 'Eliminar';
                                     currentButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                     currentButton.classList.add('bg-red-500', 'hover:bg-red-600');
                                 }
                             }, 3000);
                             return; 
                         }

                         // Second click
                         if (!firebaseReady || !poiCollectionRef) { 
                             showMessage("Error: La base de datos no está lista para eliminar.", 4000);
                             button.textContent = 'Eliminar';
                             button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                             button.classList.add('bg-red-500', 'hover:bg-red-600');
                             return; 
                         }
                         try {
                             button.disabled = true;
                             button.textContent = 'Eliminando...';
                             const docRef = doc(db, poiCollectionRef.path, docId);
                             await deleteDoc(docRef);
                             showMessage('Punto de interés eliminado.', 3000);
                         } catch (error) {
                             console.error("Error al eliminar documento: ", error);
                             showMessage("No se pudo eliminar el documento.", 5000); 
                             const currentButton = listContainer?.querySelector(`.delete-btn[data-id="${docId}"]`); 
                             if (currentButton) { 
                                 currentButton.disabled = false;
                                 currentButton.textContent = 'Eliminar';
                                 currentButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                 currentButton.classList.add('bg-red-500', 'hover:bg-red-600');
                             }
                         }
                     }
                 });
             }
             console.log("Form and List listeners attached.");
             
             // --- Llamar a initializeFirebase DESPUÉS de que el DOM esté listo ---
             initializeFirebase(); 
         });
    </script>
</body>
</html>

