<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panel de Administración AR (Geolocalización)</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page {
            display: none; height: 100%; width: 100%;
            position: relative; overflow-y: auto; /* Allow scrolling on pages */
             padding-bottom: 60px; /* Add padding for controls */
        }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; } /* Map page should not scroll */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover { background-color: #45a049; }
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; }

        
        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem;
            z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show { opacity: 1; }
        
        /* Estilos de Mapa y AR (adaptados) */
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-controls { position: fixed; top: 20px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px; }
        
        #map-crosshair {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 30px; height: 30px; border: 2px solid white;
            border-radius: 50%; box-shadow: 0 0 10px black;
            pointer-events: none; z-index: 402;
        }
        
        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center;
        }
        /* Panels on Map */
        .map-panel {
             position: fixed;
             top: 80px; /* Adjust as needed */
             left: 10px;
             z-index: 402;
             background-color: rgba(255, 255, 255, 0.95);
             padding: 15px;
             border-radius: 8px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.2);
             max-width: 300px;
             width: 90%;
             max-height: calc(100vh - 180px); /* Adjust based on top/bottom spacing */
             overflow-y: auto;
             backdrop-filter: blur(5px);
        }
         #edit-location-panel {
             border: 2px solid #f59e0b; /* Orange border for editing */
         }


        a-scene { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; }
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }
        
        #ar-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; }
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }
        .ar-loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10002; }
        .ar-loading-screen.active { display: flex; }
        
        /* Video AR styles */
        a-video { border: 2px solid white; background-color: black; }

        /* Correcciones de Video y Canvas AR */
        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; object-fit: cover !important;
            z-index: -1 !important; display: block !important; opacity: 1 !important;
            visibility: visible !important; autoplay: true !important;
            playsinline: true !important; webkit-playsinline: true !important;
            muted: true !important;
        }
        canvas, .a-canvas {
            background: transparent !important; background-color: rgba(0, 0, 0, 0) !important;
            z-index: 1 !important; position: fixed !important; top: 0 !important;
            left: 0 !important; width: 100% !important; height: 100% !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- PÁGINA 1: Panel de Administración (Selección de Modelos) -->
    <div id="admin-page" class="page active">
        <div class="container mx-auto p-6 max-w-4xl">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-blue-700">
                    Panel de Administración AR
                    <span id="version-display" class="text-sm align-middle font-normal text-gray-400 ml-2"></span>
                </h1>
                <div>
                    <!-- Botón Probar AR eliminado de aquí -->
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600">Ir al Mapa</button> 
                </div>
            </div>

            <!-- Sección de Selección de Modelos -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">1. Seleccionar Contenido para Colocar</h2>
                <p class="text-gray-600 mb-4">Marca los modelos o define el video que quieres posicionar en el mapa.</p>
                <div id="ecopiensa-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                     <p id="loading-models-placeholder" class="text-gray-500 col-span-full">Cargando modelos...</p>
                </div>
                <!-- Sección para Video (opcional) -->
                <div class="mt-4 pt-4 border-t">
                     <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                           <input type="checkbox" id="select-video-cb" class="h-5 w-5 text-blue-600">
                           <span>Añadir un Video Personalizado</span>
                     </label>
                </div>

                <h2 class="text-2xl font-semibold mt-6 mb-4">2. Ir al Mapa para Posicionar</h2>
                <p class="text-gray-600">El contenido que selecciones aquí estará disponible en el panel del mapa.</p>
            </div>

            <!-- Lista de POIs existentes (para eliminar) -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Contenido Geoposicionado Guardado</h2>
                <div id="poi-list-container" class="space-y-4">
                    <p id="loading-pois" class="text-gray-500">Cargando puntos...</p>
                    <!-- Los POIs se insertarán aquí dinámicamente -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- PÁGINA 2: Vista de Mapa (Posicionar y Editar) -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
        </div>

        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>

        <!-- Panel de Colocación (Izquierda) -->
        <div id="placement-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Colocar Nuevo Contenido</h3>
            <div id="models-to-place-list" class="space-y-2 mb-4">
                <p class="text-sm text-gray-500">No hay contenido nuevo seleccionado. Vuelve al Panel.</p>
                <!-- Botones para colocar modelos/video se insertarán aquí -->
            </div>
            
            <div class="slider-container mb-4">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="15" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            
            <div id="placement-form-container" class="hidden space-y-3">
                <h4 id="placing-model-name" class="font-semibold text-blue-600 text-center text-lg mb-2"></h4>
                
                <!-- Selector de Tipo -->
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Tipo de POI</label>
                     <select id="place-poi-type" class="mt-1 w-full p-2 border border-gray-300 rounded">
                         <option value="model" selected>Modelo 3D</option>
                         <option value="video">Video (.mp4)</option>
                     </select>
                 </div>

                <!-- Campos específicos por tipo -->
                 <div id="model-fields">
                     <div>
                         <label for="place-model-url" class="block text-sm font-medium text-gray-700">URL Modelo (.glb)</label>
                         <input type="url" id="place-model-url" class="mt-1 w-full p-2 border border-gray-300 rounded bg-gray-100" readonly>
                     </div>
                 </div>
                 <div id="video-fields" class="hidden">
                      <div>
                          <label for="place-video-url" class="block text-sm font-medium text-gray-700">URL Video (.mp4)</label>
                          <input type="url" id="place-video-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../video.mp4">
                      </div>
                 </div>

                 <!-- Campos Comunes -->
                <div>
                    <label for="place-name" class="block text-sm font-medium text-gray-700">Nombre Descriptivo</label>
                    <input type="text" id="place-name" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-scale" class="block text-sm font-medium text-gray-700">Escala (Video: ancho en metros)</label>
                    <input type="number" id="place-scale" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="1.0">
                </div>
                <div>
                    <label for="place-ground-height" class="block text-sm font-medium text-gray-700">Altura sobre terreno (m)</label>
                    <input type="number" id="place-ground-height" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="0.0">
                </div>
                <div>
                    <label for="place-sound-url" class="block text-sm font-medium text-gray-700">URL Sonido Fondo (Opcional, .mp3)</label>
                    <input type="url" id="place-sound-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../musica.mp3">
                </div>
                <div>
                    <label for="place-start-date" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                    <input type="date" id="place-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-end-date" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                    <input type="date" id="place-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                
                <p class="text-sm text-blue-600 font-semibold pt-2">Mueve el mapa para centrar la cruz en la ubicación deseada.</p>
                <button id="save-placement-btn" class="w-full bg-green-500 hover:bg-green-600 text-white p-2 rounded transition duration-300 font-bold">
                    Guardar Ubicación (en la Cruz)
                </button>
                <button id="cancel-placement-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300">Cancelar Colocación</button>
            </div>
        </div>
        
        <!-- Panel de POIs Guardados (Derecha) -->
         <div id="placed-pois-panel" class="map-panel right-3">
             <h3 class="text-lg font-semibold mb-2">Contenido en el Mapa</h3>
             <div id="placed-pois-list" class="space-y-3">
                 <p class="text-sm text-gray-500">Cargando contenido guardado...</p>
                 <!-- Lista de POIs con botón de editar se insertará aquí -->
             </div>
         </div>
        
        <!-- Panel de Edición de Ubicación (Aparece al editar) -->
         <div id="edit-location-panel" class="map-panel hidden">
             <h3 class="text-lg font-semibold mb-2">Editando Ubicación</h3>
             <p id="editing-poi-name" class="text-sm font-medium text-gray-700 mb-2"></p>
             <p class="text-sm text-amber-700 font-semibold mb-3">Mueve el mapa para centrar la cruz en la NUEVA ubicación.</p>
             <button id="save-edit-location-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white p-2 rounded transition duration-300 font-bold mb-2">
                 Guardar Nueva Ubicación (en la Cruz)
             </button>
             <button id="cancel-edit-location-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300">
                 Cancelar Edición
             </button>
         </div>


        <div id="map-controls">
            <button id="back-to-admin-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Panel</button>
            <!-- Botón Probar AR eliminado de aquí -->
            <button id="goto-summary-btn" class="control-button bg-purple-500 hover:bg-purple-600">Ver Resumen</button> 
        </div>
    </div>

    <!-- PÁGINA 3: Resumen y Lanzamiento AR (NUEVA) -->
    <div id="summary-page" class="page">
         <div class="container mx-auto p-6 max-w-4xl">
             <div class="flex justify-between items-center mb-8">
                 <h1 class="text-3xl font-bold text-purple-700">Resumen de Configuración AR</h1>
                 <div>
                     <button id="back-to-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Mapa</button>
                     <button id="launch-ar-btn" class="control-button bg-green-500 hover:bg-green-600">¡Probar AR!</button> 
                 </div>
             </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold mb-4">Contenido Configurado</h2>
                 <p class="text-gray-600 mb-4">Este es el contenido que se mostrará en la Realidad Aumentada (si está dentro de las fechas activas).</p>
                 <div id="summary-poi-list" class="space-y-4">
                     <p id="loading-summary-pois" class="text-gray-500">Cargando resumen...</p>
                     <!-- Resumen de POIs se insertará aquí -->
                 </div>
             </div>
         </div>
    </div>


    <!-- PÁGINA 4: Vista de Realidad Aumentada -->
    <div id="ar-page" class="page">
        <!-- Pantalla de carga interactiva para AR -->
        <div id="ar-loading-screen" class="ar-loading-screen active">
            <div class="loading-content">
                <div class="loader"></div>
                <div id="loading-status-text" class="text-xl">Preparando componentes...</div>
            </div>
        </div>

        <div id="ar-scene-container"></div>
        
        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy" style="font-weight: bold;">--</span>m</div>
        </div>
        <div id="ar-controls">
            <button id="back-to-summary-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Resumen</button> 
        </div>
    </div>

    <!-- Modal para solicitar permisos -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h2>Permisos necesarios</h2>
            <p>Esta aplicación necesita acceso a tu cámara y ubicación para la experiencia de Realidad Aumentada.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder Permisos</button>
        </div>
    </div>

    <div id="message-box"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            deleteDoc,
            updateDoc, // Needed for editing location
            onSnapshot, 
            getDocs,
            query,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- Versión de la App ---
        const APP_VERSION = '1.05'; // Incrementada por flujo de Resumen, Videos y Edición

        // --- Modelos de ECOPIENSA ---
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/';
        const ECOPIENSA_MODELS = [
            { name: 'Botellita Azul', url: `${GITHUB_BASE_URL}botellytaazul.glb` },
            { name: 'Ecoladrillo', url: `${GITHUB_BASE_URL}ecoladrillo.glb` },
            { name: 'Lata Plateada', url: `${GITHUB_BASE_URL}lataplateada.glb` },
            { name: 'Papelito Verde', url: `${GITHUB_BASE_URL}papelitoverde.glb` },
            { name: 'Señor Contenedor', url: `${GITHUB_BASE_URL}senorcontenedor.glb` },
            { name: 'Tapa Roja', url: `${GITHUB_BASE_URL}taparoja.glb` }
        ];
        // Placeholder for custom video selection
        const CUSTOM_VIDEO_PLACEHOLDER = { name: "Video Personalizado", url: "CUSTOM_VIDEO", isCustomVideo: true };

        // --- Configuración de Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, poiCollectionRef;
        let map;
        let poiMarkers = {}; // Usar objeto para mapear docId a marcador
        let allPoisData = []; // Cache local de los POIs para el resumen

        // --- Estado Global ---
        let modelsToPlace = []; // Array de {name, url, isCustomVideo?} seleccionados en Pag 1
        let isPlacingModel = false;
        let currentPlacingModel = {}; // {name, url, originalIndex, isCustomVideo?}
        let isEditingLocation = false; // Flag for location edit mode
        let currentEditingPoiId = null; // ID del POI cuya ubicación se está editando
        let currentEditingMarker = null; // Marcador Leaflet del POI que se está editando

        // Variables AR
        let arScene = null;
        let gpsWatchId = null; // Para el watchPosition del navegador

        const pages = {
            admin: document.getElementById('admin-page'),
            map: document.getElementById('map-page'),
            summary: document.getElementById('summary-page'), // Nueva página
            ar: document.getElementById('ar-page')
        };
        const messageBox = document.getElementById('message-box');
        const permissionModal = document.getElementById('permission-modal');
        const arLoadingScreen = document.getElementById('ar-loading-screen');
        const loadingStatusText = document.getElementById('loading-status-text');
        
        // Elementos DOM Admin
        const listContainer = document.getElementById('poi-list-container');
        const loadingPois = document.getElementById('loading-pois');
        const ecopiensaSelectionList = document.getElementById('ecopiensa-selection-list');
        const loadingModelsPlaceholder = document.getElementById('loading-models-placeholder');
        const selectVideoCheckbox = document.getElementById('select-video-cb'); // Checkbox video

        // Elementos DOM Mapa
        const placementPanel = document.getElementById('placement-panel');
        const modelsToPlaceList = document.getElementById('models-to-place-list');
        const placementFormContainer = document.getElementById('placement-form-container');
        const placingModelName = document.getElementById('placing-model-name');
        const cancelPlacementBtn = document.getElementById('cancel-placement-btn');
        const savePlacementBtn = document.getElementById('save-placement-btn'); 
        const mapZoomSlider = document.getElementById('map-zoom-slider'); 
        const jumptoBtn = document.getElementById('jumpto-btn');
        // Nuevos elementos formulario
        const placePoiTypeSelect = document.getElementById('place-poi-type');
        const modelFieldsDiv = document.getElementById('model-fields');
        const videoFieldsDiv = document.getElementById('video-fields');
        const placeModelUrlInput = document.getElementById('place-model-url');
        const placeVideoUrlInput = document.getElementById('place-video-url');
        const placeNameInput = document.getElementById('place-name'); // Input para nombre
        // Paneles Edición
        const placedPoisPanel = document.getElementById('placed-pois-panel');
        const placedPoisList = document.getElementById('placed-pois-list');
        const editLocationPanel = document.getElementById('edit-location-panel');
        const editingPoiNameEl = document.getElementById('editing-poi-name');
        const saveEditLocationBtn = document.getElementById('save-edit-location-btn');
        const cancelEditLocationBtn = document.getElementById('cancel-edit-location-btn');

        // Elementos DOM Resumen
        const summaryPoiList = document.getElementById('summary-poi-list');
        const loadingSummaryPois = document.getElementById('loading-summary-pois');


        function showMessage(msg, duration = 3000) {
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function navigateTo(pageName) {
            console.log(`Navegando a: ${pageName}`);
            Object.values(pages).forEach(p => p.classList.remove('active'));
            if(pages[pageName]) {
                pages[pageName].classList.add('active');
            } else {
                 console.error(`Página no encontrada: ${pageName}`);
                 pages.admin.classList.add('active'); // Fallback a admin
                 return;
            }

            // Lógica específica de cada página
            if (pageName === 'map') {
                 stopAR(); // Detener AR si venimos de ahí
                setTimeout(initMap, 100); 
            } else if (pageName === 'summary') {
                 stopAR(); // Detener AR
                 stopMap(); // Detener Mapa
                 populateSummaryPage(); // Cargar datos en la página de resumen
            } else if (pageName === 'ar') {
                 stopMap(); // Detener Mapa antes de ir a AR
                startARFlow(); 
            } else if (pageName === 'admin') {
                // Si volvemos al admin, detenemos AR y mapa
                stopAR();
                stopMap();
                 // Actualizar checkboxes por si acaso
                 initializeModelSelection(); 
            }
        }

        // Función para detener el mapa y liberar recursos
        function stopMap() {
            if (map) {
                map.remove(); // Elimina el mapa y sus listeners internos
                map = null;
                 // Limpiar también los marcadores visualmente, aunque onSnapshot los recreará
                 Object.values(poiMarkers).forEach(marker => marker.remove());
                 poiMarkers = {}; 
                console.log("Mapa detenido y removido.");
            }
             // Resetear flags de estado del mapa si es necesario
             isPlacingModel = false;
             isEditingLocation = false;
             currentEditingPoiId = null;
             currentEditingMarker = null;
        }


        // --- Lógica de Firebase (Panel Admin) ---
        async function initializeApp() {
            const versionDisplay = document.getElementById('version-display');
            if (versionDisplay) versionDisplay.textContent = `v${APP_VERSION}`;

            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                initializeModelSelection(); // Llama AHORA para que se vean los checkboxes

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('Usuario autenticado:', userId);
                        const collectionPath = `/artifacts/${appId}/public/data/pois`;
                        poiCollectionRef = collection(db, collectionPath);
                        console.log('Colección POI configurada:', collectionPath);
                        loadAndListenPois(); // Carga la lista en Admin y actualiza el cache local allPoisData
                    } else {
                        userId = null;
                        poiCollectionRef = null;
                        listContainer.innerHTML = '<p class="text-gray-500">Esperando autenticación...</p>';
                        allPoisData = []; // Limpiar cache local
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loadingPois.textContent = "Error al conectar con Firebase.";
                if (!ecopiensaSelectionList.querySelector('.model-select-cb')) {
                     initializeModelSelection(); // Reintentar mostrar checkboxes
                }
            }
        }

        // Llena la lista de checkboxes en la Página 1
        function initializeModelSelection() {
            if (loadingModelsPlaceholder) loadingModelsPlaceholder.style.display = 'none';
            if (ecopiensaSelectionList.children.length > 1 && !ecopiensaSelectionList.contains(loadingModelsPlaceholder)) return; 
            
            ecopiensaSelectionList.innerHTML = ''; 
            ECOPIENSA_MODELS.forEach(model => {
                const isSelected = modelsToPlace.some(m => m.url === model.url);
                createCheckbox(model.name, model.url, isSelected, false);
            });
            // Listener para el checkbox de video personalizado
            selectVideoCheckbox.removeEventListener('change', handleVideoCheckboxChange);
            selectVideoCheckbox.addEventListener('change', handleVideoCheckboxChange);
            // Sincronizar estado inicial del checkbox de video
            selectVideoCheckbox.checked = modelsToPlace.some(m => m.isCustomVideo);

             console.log("Checkboxes de modelos/video inicializados.");
        }
        
        // Función helper para crear checkboxes
        function createCheckbox(name, url, isChecked, isVideoPlaceholder = false) {
             const label = document.createElement('label');
             label.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer';
             const input = document.createElement('input');
             input.type = 'checkbox';
             input.className = 'model-select-cb h-5 w-5 text-blue-600';
             input.dataset.name = name;
             input.dataset.url = url;
             input.checked = isChecked;
             if (isVideoPlaceholder) {
                 input.dataset.isCustomVideo = "true";
             }
             
             input.removeEventListener('change', handleCheckboxChange); 
             input.addEventListener('change', handleCheckboxChange); 

             const span = document.createElement('span');
             span.textContent = name;
             
             label.appendChild(input);
             label.appendChild(span);
             ecopiensaSelectionList.appendChild(label);
        }

        // Manejador para el checkbox de video personalizado
         function handleVideoCheckboxChange(e) {
             if (e.target.checked) {
                 // Añadir placeholder si no está ya
                 if (!modelsToPlace.some(m => m.isCustomVideo)) {
                     modelsToPlace.push({...CUSTOM_VIDEO_PLACEHOLDER});
                 }
             } else {
                 // Quitar placeholder
                 modelsToPlace = modelsToPlace.filter(m => !m.isCustomVideo);
             }
             console.log("Modelos para colocar (video toggle):", modelsToPlace);
         }

        // Manejador unificado para checkboxes (modelos y video placeholder)
        function handleCheckboxChange(e) {
             const modelData = { 
                 name: e.target.dataset.name, 
                 url: e.target.dataset.url,
                 isCustomVideo: e.target.dataset.isCustomVideo === "true"
             };
             
             if (e.target.checked) {
                 // Añadir solo si no existe ya (por URL o por ser video placeholder)
                 if (!modelsToPlace.some(m => m.url === modelData.url || (m.isCustomVideo && modelData.isCustomVideo))) {
                     modelsToPlace.push(modelData);
                 }
             } else {
                 // Quitar por URL o por ser video placeholder
                 modelsToPlace = modelsToPlace.filter(m => 
                     !(m.url === modelData.url || (m.isCustomVideo && modelData.isCustomVideo))
                 );
             }
             console.log("Modelos para colocar actualizados:", modelsToPlace);
         }


        // Carga y escucha POIs para la lista Admin y actualiza cache local
        function loadAndListenPois() {
             if (!poiCollectionRef) {
                 loadingPois.textContent = "Esperando conexión...";
                 loadingPois.style.display = 'block'; 
                 return;
             }
            
            loadingPois.textContent = "Cargando puntos..."; 
             loadingPois.style.display = 'block'; 
            const q = query(poiCollectionRef);
            
            onSnapshot(q, (querySnapshot) => {
                loadingPois.style.display = 'none'; 
                allPoisData = []; // Limpiar cache local antes de repoblar
                listContainer.innerHTML = ''; // Limpiar lista visual

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">No hay contenido guardado.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const poi = { id: doc.id, ...doc.data() }; // Incluir ID en el cache
                    allPoisData.push(poi); // Añadir al cache local

                    const poiElement = document.createElement('div');
                    poiElement.className = 'poi-item p-4 border border-gray-200 rounded-lg shadow-sm grid grid-cols-2 md:grid-cols-4 gap-4 items-center';
                    // Mostrar tipo y URL relevante
                    let typeLabel = poi.poiType === 'video' ? 'Video' : 'Modelo 3D';
                    let urlToShow = poi.poiType === 'video' ? (poi.videoUrl || 'N/A') : (poi.modelUrl || 'N/A');
                     if (urlToShow.length > 30) urlToShow = urlToShow.substring(0, 27) + '...'; // Acortar URL larga

                    poiElement.innerHTML = `
                        <div>
                            <strong class="block text-sm text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                            <span class="block text-xs ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                            <span class="block text-xs text-gray-500" title="${poi.poiType === 'video' ? poi.videoUrl : poi.modelUrl}">URL: ${urlToShow}</span>
                        </div>
                        <div class="text-sm">
                            <span class="block">Lat: ${poi.lat?.toFixed(6) || 'N/A'}</span>
                            <span class="block">Lon: ${poi.lon?.toFixed(6) || 'N/A'}</span>
                        </div>
                        <div class="text-sm">
                            <span class="block">Inicia: ${poi.startDate || 'N/A'}</span>
                            <span class="block">Termina: ${poi.endDate || 'N/A'}</span>
                        </div>
                        <div class="text-right">
                            <button data-id="${poi.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300">
                                Eliminar
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(poiElement);
                });
                 console.log(`Cache local 'allPoisData' actualizado con ${allPoisData.length} POIs.`);

            }, (error) => {
                console.error("Error al escuchar POIs:", error);
                loadingPois.style.display = 'none'; 
                listContainer.innerHTML = '<p class="text-red-500">Error al cargar el contenido guardado.</p>';
                allPoisData = []; // Limpiar cache en caso de error
            });
        }

        // Listener para eliminar POIs (sin cambios, ya usa delegación)
        listContainer.addEventListener('click', async (e) => {
             if (!poiCollectionRef) { /* ... */ return; }
            if (e.target && e.target.classList.contains('delete-btn')) { /* ... */ }
             // Código de eliminación (sin cambios)
             if (!poiCollectionRef) {
                 showMessage("Error: No se pudo conectar a la base de datos para eliminar.", 4000);
                 return;
             }
            if (e.target && e.target.classList.contains('delete-btn')) {
                const docId = e.target.getAttribute('data-id');
                
                if (confirm("¿Estás seguro de que quieres eliminar este punto de interés?")) {
                    const button = e.target; 
                    try {
                        button.disabled = true;
                        button.textContent = 'Eliminando...';
                        const docRef = doc(db, poiCollectionRef.path, docId);
                        await deleteDoc(docRef);
                        showMessage('Punto de interés eliminado.', 3000);
                        // onSnapshot se encargará de actualizar la UI y allPoisData
                    } catch (error) {
                        console.error("Error al eliminar documento: ", error);
                        showMessage("No se pudo eliminar el documento.", 5000);
                        if (button && listContainer.contains(button)) { 
                           button.disabled = false;
                           button.textContent = 'Eliminar';
                        }
                    }
                }
            }
        });
        
        // --- Lógica del Mapa (Página 2) ---
        
        function initMap() {
            if (!poiCollectionRef) { /* ... */ return; }
             if (map) { /* ... */ return; } // Código sin cambios

            console.log("Inicializando mapa...");
            const mapContainer = document.getElementById('map-canvas');
            const defaultCenter = [4.0835, -76.1915]; // Tuluá
            map = L.map(mapContainer, { /* ... */ }).setView(defaultCenter, 15); // Código sin cambios

            L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { /* ... */ }).addTo(map); // Código sin cambios

            // Listener para actualizar marcadores y panel de edición en el mapa
            onSnapshot(query(poiCollectionRef), (querySnapshot) => {
                 if (!map) return; // No hacer nada si el mapa no está inicializado
                
                 // 1. Limpiar marcadores ANTES de repoblar
                 Object.values(poiMarkers).forEach(marker => {
                      if (map.hasLayer(marker)) map.removeLayer(marker);
                 });
                 poiMarkers = {}; // Resetear objeto

                 // 2. Limpiar panel de POIs guardados (el de editar)
                 placedPoisList.innerHTML = ''; 
                 
                 let hasPois = false;
                 querySnapshot.forEach((doc) => {
                     hasPois = true;
                     const poi = { id: doc.id, ...doc.data() };
                      
                     // 3. Crear Marcador en el Mapa
                     if (typeof poi.lat === 'number' && typeof poi.lon === 'number') {
                          // Determinar color del marcador basado en tipo
                          let iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png'; // Default: Modelo
                          if (poi.poiType === 'video') {
                               iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png'; // Violeta para Video
                          }

                         const marker = L.marker([poi.lat, poi.lon], {
                              icon: L.icon({
                                   iconUrl: iconUrl,
                                   shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                   iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                              })
                         })
                             .addTo(map)
                             .bindPopup(`<b>${poi.name || 'Sin Nombre'}</b> (${poi.poiType || 'modelo'})`);
                         poiMarkers[poi.id] = marker; // Guardar marcador por ID
                     } else {
                          console.warn("POI para mapa sin coordenadas:", poi.id);
                     }
                     
                     // 4. Crear Elemento en la Lista de Edición (Panel Derecho)
                     const listItem = document.createElement('div');
                     listItem.className = 'placed-poi-item p-2 border-b flex justify-between items-center';
                     listItem.innerHTML = `
                         <span class="text-sm font-medium">${poi.name || 'Sin Nombre'}</span>
                         <button data-id="${poi.id}" class="edit-location-btn bg-amber-500 hover:bg-amber-600 text-white text-xs px-2 py-1 rounded">
                             Editar Ubic.
                         </button>
                     `;
                     // Añadir listener al botón de editar
                      listItem.querySelector('.edit-location-btn').addEventListener('click', handleEditLocationClick);
                     placedPoisList.appendChild(listItem);
                 });
                 
                 if (!hasPois) {
                      placedPoisList.innerHTML = '<p class="text-sm text-gray-500">No hay contenido guardado en el mapa.</p>';
                 }

                 console.log(`Actualizados ${Object.keys(poiMarkers).length} marcadores y panel de edición.`);
                 // Actualizar panel de colocación por si se eliminó/agregó un POI
                 populatePlacementPanel(); 
            });

            populatePlacementPanel(); // Llenar panel izquierdo
            cancelPlacement(); // Resetear formulario izquierdo
            cancelEditLocation(); // Asegurarse que el panel de edición esté oculto

            // Sincronizar slider zoom (sin cambios)
            mapZoomSlider.value = map.getZoom();
            mapZoomSlider.removeEventListener('input', handleZoomSlider); 
            mapZoomSlider.addEventListener('input', handleZoomSlider);
            map.off('zoomend', handleMapZoomEnd); 
            map.on('zoomend', handleMapZoomEnd);
            
            // Conectar botón "Ir" (sin cambios)
            jumptoBtn.removeEventListener('click', jumpToCoords); 
            jumptoBtn.addEventListener('click', jumpToCoords);

            // Listener para selector de tipo POI en formulario de colocación
            placePoiTypeSelect.removeEventListener('change', handlePoiTypeChange);
            placePoiTypeSelect.addEventListener('change', handlePoiTypeChange);
            handlePoiTypeChange(); // Llamar una vez para estado inicial

            setTimeout(() => map.invalidateSize(), 200); 
        }

        // Mostrar/ocultar campos según el tipo de POI seleccionado
        function handlePoiTypeChange() {
             const selectedType = placePoiTypeSelect.value;
             const isVideo = selectedType === 'video';
             
             modelFieldsDiv.classList.toggle('hidden', isVideo);
             videoFieldsDiv.classList.toggle('hidden', !isVideo);
             
             // Deshabilitar/Habilitar inputs
             placeModelUrlInput.disabled = isVideo;
             placeVideoUrlInput.disabled = !isVideo;

             // Ajustar label de escala
             const scaleLabel = document.querySelector('label[for="place-scale"]');
             if (scaleLabel) {
                 scaleLabel.textContent = isVideo ? 'Ancho del Video (metros)' : 'Escala del Modelo';
             }
        }

        // --- Funciones para Edición de Ubicación ---
        function handleEditLocationClick(e) {
             const poiId = e.target.dataset.id;
             startEditLocation(poiId);
        }

        function startEditLocation(poiId) {
             if (isPlacingModel) cancelPlacement(); // Salir del modo colocación si estaba activo
             
             const poiData = allPoisData.find(p => p.id === poiId);
             const marker = poiMarkers[poiId];

             if (!poiData || !marker) {
                 showMessage("Error: No se encontró el POI o su marcador.", 4000);
                 return;
             }

             isEditingLocation = true;
             currentEditingPoiId = poiId;
             currentEditingMarker = marker; // Guardar referencia al marcador

             editingPoiNameEl.textContent = `Moviendo: ${poiData.name || 'Sin Nombre'}`;
             
             // Ocultar paneles normales, mostrar panel de edición
             placementPanel.classList.add('hidden');
             placedPoisPanel.classList.add('hidden');
             editLocationPanel.classList.remove('hidden');

             // Centrar mapa en el marcador actual y hacer zoom
             map.setView(marker.getLatLng(), 19); 

              // Opcional: Hacer 'rebotar' el marcador
              marker.getElement()?.classList.add('leaflet-marker-icon-pulse'); 

             showMessage("Modo Edición: Mueve el mapa y guarda la nueva ubicación.", 4000);
        }

        function cancelEditLocation() {
             isEditingLocation = false;
             currentEditingPoiId = null;
             // Quitar efecto visual del marcador si se añadió
             if (currentEditingMarker && currentEditingMarker.getElement()) {
                 currentEditingMarker.getElement().classList.remove('leaflet-marker-icon-pulse');
             }
             currentEditingMarker = null;

             // Mostrar paneles normales, ocultar panel de edición
             placementPanel.classList.remove('hidden');
             placedPoisPanel.classList.remove('hidden');
             editLocationPanel.classList.add('hidden');
             console.log("Edición de ubicación cancelada.");
        }
        cancelEditLocationBtn.removeEventListener('click', cancelEditLocation);
        cancelEditLocationBtn.addEventListener('click', cancelEditLocation);

        async function handleSaveEditLocation() {
             if (!isEditingLocation || !map || !poiCollectionRef || !currentEditingPoiId) {
                 console.warn("Intento de guardar edición inválido.");
                 return;
             }

             const newLatLng = map.getCenter(); // Nueva ubicación desde la cruz
             showMessage('Actualizando ubicación...', 2000);
             saveEditLocationBtn.disabled = true;
             saveEditLocationBtn.textContent = 'Guardando...';

             try {
                 const docRef = doc(db, poiCollectionRef.path, currentEditingPoiId);
                 await updateDoc(docRef, {
                     lat: newLatLng.lat,
                     lon: newLatLng.lng
                 });
                 showMessage('¡Ubicación actualizada!', 3000);
                 cancelEditLocation(); // Salir del modo edición
                 // onSnapshot se encargará de mover el marcador visualmente

             } catch (error) {
                 console.error("Error al actualizar ubicación:", error);
                 showMessage("Error al guardar la nueva ubicación.", 5000);
             } finally {
                 saveEditLocationBtn.disabled = false;
                 saveEditLocationBtn.textContent = 'Guardar Nueva Ubicación (en la Cruz)';
             }
        }
        saveEditLocationBtn.removeEventListener('click', handleSaveEditLocation);
        saveEditLocationBtn.addEventListener('click', handleSaveEditLocation);

        // --- Fin Funciones Edición ---


        // Funciones separadas para los listeners del mapa (zoom, ir a) - sin cambios
        function handleZoomSlider(e) { if (map) map.setZoom(parseFloat(e.target.value)); }
        function handleMapZoomEnd() { if (map) mapZoomSlider.value = map.getZoom(); }
        function jumpToCoords() { /* ... código sin cambios ... */ 
            const latInput = document.getElementById('jumpto-lat');
            const lonInput = document.getElementById('jumpto-lon');
             if (!latInput || !lonInput) return; 

            const lat = parseFloat(latInput.value);
            const lon = parseFloat(lonInput.value);
            if (isNaN(lat) || isNaN(lon) || !map) {
                 showMessage("Por favor, introduce latitud y longitud válidas.", 3000);
                 return;
            }
            map.setView([lat, lon], 18); 
         }

        // Llena el panel de colocación (izquierda)
        async function populatePlacementPanel() {
             if (!poiCollectionRef) { /* ... */ return; } // Sin cambios
            modelsToPlaceList.innerHTML = ''; // Sin cambios
            try {
                const querySnapshot = await getDocs(query(poiCollectionRef)); // Sin cambios
                const placedContentIdentifiers = new Set(); // Usar URL o 'CUSTOM_VIDEO'
                 querySnapshot.forEach(doc => {
                     const data = doc.data();
                     if (data.poiType === 'video') {
                         placedContentIdentifiers.add('CUSTOM_VIDEO'); // Identificador único para video
                     } else if (data.modelUrl) {
                         placedContentIdentifiers.add(data.modelUrl);
                     }
                 });


                // Filtrar array global 'modelsToPlace'
                const unplacedContent = modelsToPlace.filter(item => 
                     item.isCustomVideo 
                     ? !placedContentIdentifiers.has('CUSTOM_VIDEO') // Solo un video personalizado a la vez
                     : !placedContentIdentifiers.has(item.url)
                );


                if (unplacedContent.length === 0) {
                    modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">Todo el contenido seleccionado ya está en el mapa o no hay contenido seleccionado. Vuelve al Panel.</p>';
                    return;
                }

                unplacedContent.forEach((item) => {
                    const originalIndex = modelsToPlace.findIndex(m => m.url === item.url);
                    if (originalIndex === -1) { /* ... */ return; } // Sin cambios

                    const button = document.createElement('button'); // Sin cambios
                    button.className = 'place-btn control-button bg-blue-500 hover:bg-blue-600 w-full text-left'; // Sin cambios
                    button.textContent = `Colocar ${item.name}`; // Sin cambios
                    button.dataset.name = item.name; // Sin cambios
                    button.dataset.url = item.url; // Sin cambios
                    button.dataset.index = originalIndex; // Sin cambios
                    if (item.isCustomVideo) {
                         button.dataset.isCustomVideo = "true";
                    }
                    
                    button.removeEventListener('click', handlePlaceButtonClick); // Sin cambios
                    button.addEventListener('click', handlePlaceButtonClick); // Sin cambios
                    
                    modelsToPlaceList.appendChild(button); // Sin cambios
                });
            } catch (error) { /* ... */ } // Sin cambios
        }
        
        // Manejador botón colocar (sin cambios)
        function handlePlaceButtonClick(e) { startPlacement(e.target.dataset); }


        // Inicia el modo de colocación
        function startPlacement(itemData) {
             const index = parseInt(itemData.index);
             const isCustomVideo = itemData.isCustomVideo === "true";
             // Validar índice
             if (isNaN(index) || index < 0 || index >= modelsToPlace.length) { /* ... */ return; }
             // Verificar consistencia del tipo
             if (modelsToPlace[index].isCustomVideo !== isCustomVideo) {
                  console.error("Discrepancia de tipo al iniciar colocación.");
                  return;
             }

            isPlacingModel = true;
            currentPlacingModel = { ...modelsToPlace[index], originalIndex: index }; 

            placingModelName.textContent = `Colocando: ${currentPlacingModel.name}`;
            
            // Establecer tipo y mostrar/ocultar campos
             placePoiTypeSelect.value = isCustomVideo ? 'video' : 'model';
             handlePoiTypeChange(); // Actualizar visibilidad de campos

            // Llenar campos
             placeNameInput.value = currentPlacingModel.name; // Usar nombre como default
             placeModelUrlInput.value = isCustomVideo ? '' : currentPlacingModel.url;
             placeVideoUrlInput.value = isCustomVideo ? '' : ''; // Limpiar campo de video
            document.getElementById('place-sound-url').value = '';
            document.getElementById('place-scale').value = '1.0';
            document.getElementById('place-ground-height').value = '0.0';
            
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0];
            document.getElementById('place-start-date').value = today;
            document.getElementById('place-end-date').value = nextMonth;

            modelsToPlaceList.classList.add('hidden'); 
            placementFormContainer.classList.remove('hidden'); 
            
            showMessage(`Mueve el mapa y presiona 'Guardar Ubicación'`);
        }

        // Cancela el modo de colocación (sin cambios)
        function cancelPlacement() { /* ... código sin cambios ... */ 
            isPlacingModel = false;
            currentPlacingModel = {};
            modelsToPlaceList.classList.remove('hidden'); 
            placementFormContainer.classList.add('hidden'); 
             console.log("Colocación cancelada.");
        }
        cancelPlacementBtn.removeEventListener('click', cancelPlacement); 
        cancelPlacementBtn.addEventListener('click', cancelPlacement); 


        // Manejador del botón de guardar ubicación
        async function handleSavePlacement() { 
            if (!isPlacingModel || !map || !poiCollectionRef) { /* ... */ return; } // Sin cambios

            const latlng = map.getCenter(); // Sin cambios
            showMessage('Guardando...', 2000); // Sin cambios
            savePlacementBtn.disabled = true; // Sin cambios
            savePlacementBtn.textContent = 'Guardando...'; // Sin cambios

            try {
                // Determinar tipo y URLs basado en el formulario y currentPlacingModel
                 const poiType = placePoiTypeSelect.value;
                 let modelUrl = '';
                 let videoUrl = '';
                 let name = placeNameInput.value.trim(); // Obtener nombre del input

                 if (!name) {
                      throw new Error("El nombre descriptivo es obligatorio.");
                 }

                 if (poiType === 'video') {
                     videoUrl = placeVideoUrlInput.value.trim();
                     if (!videoUrl) throw new Error("La URL del video es obligatoria para el tipo Video.");
                     // Validar URL de video (simple)
                     if (!videoUrl.startsWith('http') || !videoUrl.toLowerCase().endsWith('.mp4')) {
                          console.warn("URL de video no parece válida:", videoUrl);
                          // Permitir continuar pero advertir, o lanzar error:
                          // throw new Error("La URL del video debe ser un enlace .mp4 válido.");
                     }
                 } else { // 'model'
                     modelUrl = placeModelUrlInput.value.trim(); // Ya debería estar lleno
                     if (!modelUrl) throw new Error("La URL del modelo es obligatoria para el tipo Modelo 3D.");
                 }


                const newPoi = {
                    name: name, // Usar nombre del input
                    poiType: poiType, // Guardar el tipo
                    modelUrl: modelUrl, // Será vacío si es video
                    videoUrl: videoUrl, // Será vacío si es modelo
                    soundUrl: document.getElementById('place-sound-url').value.trim() || "", 
                    lat: latlng.lat,
                    lon: latlng.lng,
                    scale: parseFloat(document.getElementById('place-scale').value),
                    groundHeight: parseFloat(document.getElementById('place-ground-height').value),
                    startDate: document.getElementById('place-start-date').value,
                    endDate: document.getElementById('place-end-date').value
                };

                // --- Validación (sin cambios) ---
                if (isNaN(newPoi.scale) || isNaN(newPoi.groundHeight)) throw new Error("Escala/Altura deben ser números.");
                if (newPoi.scale <= 0) throw new Error("La escala debe ser positiva.");
                if (!newPoi.startDate || !newPoi.endDate) throw new Error("Las fechas son obligatorias.");
                // ... resto de validaciones ...


                await addDoc(poiCollectionRef, newPoi); // Guardar en Firebase
                
                showMessage(`¡'${newPoi.name}' guardado!`, 3000); // Mensaje con nombre

                // --- Lógica para quitar de 'modelsToPlace' y desmarcar checkbox ---
                 let identifierToRemove = newPoi.poiType === 'video' ? 'CUSTOM_VIDEO' : newPoi.modelUrl;
                 let originalIndex = -1;
                 
                 if (newPoi.poiType === 'video') {
                      originalIndex = modelsToPlace.findIndex(m => m.isCustomVideo);
                 } else {
                      originalIndex = modelsToPlace.findIndex(m => m.url === newPoi.modelUrl);
                 }

                 if (originalIndex !== -1) {
                      const removedItem = modelsToPlace.splice(originalIndex, 1)[0];
                      // Desmarcar checkbox correspondiente
                      let checkboxSelector;
                      if (removedItem.isCustomVideo) {
                           checkboxSelector = '#select-video-cb';
                      } else {
                           checkboxSelector = `.model-select-cb[data-url="${removedItem.url}"]`;
                      }
                      const checkbox = document.querySelector(checkboxSelector);
                      if (checkbox) checkbox.checked = false;
                      console.log("Item quitado de modelsToPlace:", removedItem.name);
                 } else {
                      console.error("No se pudo encontrar el índice para quitar el item de modelsToPlace:", identifierToRemove);
                 }

                populatePlacementPanel(); // Actualizar panel izquierdo
                cancelPlacement(); // Resetear formulario

            } catch (error) { /* ... */ } // Manejo de error sin cambios
            finally { /* ... */ } // Reactivar botón sin cambios
        }
        savePlacementBtn.removeEventListener('click', handleSavePlacement); // Sin cambios
        savePlacementBtn.addEventListener('click', handleSavePlacement); // Sin cambios

        // --- Lógica Página 3: Resumen ---
        function populateSummaryPage() {
             if (!poiCollectionRef) {
                 loadingSummaryPois.textContent = "Esperando conexión a base de datos...";
                 loadingSummaryPois.style.display = 'block';
                 summaryPoiList.innerHTML = ''; // Limpiar lista
                 return;
             }
            
            loadingSummaryPois.textContent = "Cargando resumen...";
             loadingSummaryPois.style.display = 'block';
             summaryPoiList.innerHTML = ''; // Limpiar lista

             // Usar el cache local 'allPoisData' que se actualiza con onSnapshot
             if (allPoisData.length === 0) {
                 loadingSummaryPois.style.display = 'none';
                 summaryPoiList.innerHTML = '<p class="text-gray-500">No hay contenido configurado para mostrar.</p>';
                 return;
             }

             loadingSummaryPois.style.display = 'none';
             allPoisData.forEach(poi => {
                 const summaryElement = document.createElement('div');
                 summaryElement.className = 'p-4 border rounded-lg grid grid-cols-3 gap-3';
                 let typeLabel = poi.poiType === 'video' ? 'Video' : 'Modelo 3D';
                 summaryElement.innerHTML = `
                     <div>
                         <strong class="block text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                         <span class="text-sm ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                     </div>
                     <div class="text-sm text-gray-600">
                         <span class="block">Lat: ${poi.lat?.toFixed(5)}</span>
                         <span class="block">Lon: ${poi.lon?.toFixed(5)}</span>
                         <span class="block">Escala: ${poi.scale || 1}</span>
                         <span class="block">Altura: ${poi.groundHeight || 0}m</span>
                     </div>
                     <div class="text-sm text-gray-600">
                          <span class="block">Inicio: ${poi.startDate || 'N/A'}</span>
                          <span class="block">Fin: ${poi.endDate || 'N/A'}</span>
                          ${poi.soundUrl ? '<span class="block text-green-600">♪ Con Sonido</span>' : ''}
                     </div>
                 `;
                 summaryPoiList.appendChild(summaryElement);
             });
        }


        // --- Lógica de AR (Página 4) ---
        
        async function startARFlow() { /* ... Código sin cambios ... */ 
             if (!pages.ar.classList.contains('active')) return; 
             arLoadingScreen.classList.add('active');
             loadingStatusText.textContent = 'Solicitando permisos...';
             
             try {
                  await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                  await new Promise((resolve, reject) => { /* ... GPS Promise ... */ 
                      let watchId;
                      const timeoutId = setTimeout(() => {
                          navigator.geolocation.clearWatch(watchId);
                          reject(new Error("Timeout obteniendo GPS inicial."));
                      }, 15000); 

                      watchId = navigator.geolocation.watchPosition(
                          (position) => {
                              if (position.coords.accuracy < 50) {
                                  clearTimeout(timeoutId);
                                  navigator.geolocation.clearWatch(watchId);
                                  resolve(position);
                              } else {
                                   loadingStatusText.textContent = `Obteniendo GPS (${position.coords.accuracy.toFixed(0)}m)...`;
                              }
                          },
                          (error) => {
                              clearTimeout(timeoutId);
                              navigator.geolocation.clearWatch(watchId);
                              reject(error);
                          },
                          { enableHighAccuracy: true, maximumAge: 0 } 
                      );
                   });


                 loadingStatusText.textContent = 'Cargando escena AR...';
                 await initializeARScene();

             } catch (error) { /* ... Error Handling ... */ 
                 console.error('Error al iniciar AR:', error);
                 arLoadingScreen.classList.remove('active');
                 navigateTo('summary'); // Volver al RESUMEN si falla AR
                 let userMsg = "Error al iniciar AR: " + error.message;
                 if (error.name === "NotAllowedError" || error.name === "PermissionDeniedError") {
                     userMsg = "Se necesita acceso a cámara y GPS para la AR.";
                 } else if (error.code === error.TIMEOUT || error.message.includes("Timeout")) {
                      userMsg = "No se pudo obtener señal GPS precisa. Intenta en un lugar abierto.";
                 }
                 showMessage(userMsg, 6000);
             }
        }

        async function initializeARScene() {
             if (!poiCollectionRef) { /* ... */ navigateTo('summary'); return; } // Volver a resumen

            const arSceneContainer = document.getElementById('ar-scene-container');
            arSceneContainer.innerHTML = ''; 
            
            arScene = document.createElement('a-scene'); /* ... Atributos sin cambios ... */
            arScene.id = 'ar-scene';
            arScene.setAttribute('embedded', '');
            arScene.setAttribute('vr-mode-ui', 'enabled: false');
            arScene.setAttribute('renderer', 'logarithmicDepthBuffer: true; antialias: true; precision: high; alpha: true;physicallyCorrectLights: true;'); 
            arScene.setAttribute('arjs', 'sourceType: webcam; videoTexture: true; debugUIEnabled: false;'); 


            const arCamera = document.createElement('a-camera'); /* ... Atributos sin cambios ... */
            arCamera.id = 'ar-camera';
            arCamera.setAttribute('gps-camera', 'gpsMinDistance: 5; gpsTimeInterval: 1000;'); 
            arCamera.setAttribute('rotation-reader', ''); 


            const poiContainer = document.createElement('a-entity'); /* ... */ // Sin cambios
            poiContainer.id = 'poi-container';


            loadingStatusText.textContent = 'Descargando Puntos de Interés...'; // Sin cambios
            let loadedCount = 0; // Sin cambios
            let querySnapshot; // Sin cambios

            try {
                const q = query(poiCollectionRef); // Sin cambios
                querySnapshot = await getDocs(q); // Sin cambios
                const now = new Date(); // Sin cambios

                if (querySnapshot.empty) { /* ... */ } // Sin cambios

                querySnapshot.forEach((doc) => {
                    const poi = doc.data();
                    // Validación básica (sin cambios)
                     if (typeof poi.lat !== 'number' || typeof poi.lon !== 'number' || (!poi.modelUrl && !poi.videoUrl) || !poi.startDate || !poi.endDate) {
                         console.warn("POI AR con datos inválidos, omitiendo:", doc.id);
                         return; 
                     }

                    const startDate = new Date(poi.startDate); // Sin cambios
                    const endDate = new Date(poi.endDate); // Sin cambios
                    endDate.setHours(23, 59, 59, 999); // Sin cambios

                    if (now >= startDate && now <= endDate) { // Si está activo hoy
                         const entity = document.createElement('a-entity');
                         // Posición y GPS siempre se aplican
                         entity.setAttribute('gps-entity-place', `latitude: ${poi.lat}; longitude: ${poi.lon};`);
                         const groundHeight = (typeof poi.groundHeight === 'number') ? poi.groundHeight : 0.0;
                         entity.setAttribute('position', `0 ${groundHeight} 0`);
                         const scale = (typeof poi.scale === 'number' && poi.scale > 0) ? poi.scale : 1.0;

                         // Crear Modelo 3D o Video
                         if (poi.poiType === 'video' && poi.videoUrl) {
                              entity.setAttribute('geometry', `primitive: plane; width: ${scale}; height: ${scale * (9/16)};`); // Asumir aspect ratio 16:9, usar scale como ancho
                              entity.setAttribute('material', `shader: flat; src: ${poi.videoUrl};`);
                              // A-Frame >= 1.3.0 maneja videos como texturas. No se necesita a-video separado.
                              // Asegúrate que el video tenga autoplay y loop si es necesario (generalmente en el servidor o <video> tag si se usa asset management)
                              // Para control manual, necesitarías JS y asset management de A-Frame (<a-assets>)
                               // Aquí asumimos reproducción automática si el formato lo permite
                               console.log(`Creando video plane para ${poi.name}`);

                         } else if (poi.modelUrl) { // Default a modelo si no es video o falta url de video
                              entity.setAttribute('gltf-model', `url(${poi.modelUrl}); crossorigin: anonymous;`);
                              entity.setAttribute('scale', `${scale} ${scale} ${scale}`);
                              entity.setAttribute('animation-mixer', ''); // Asumir animaciones
                         } else {
                              console.warn(`POI ${poi.name} activo pero sin URL válida (modelo o video).`);
                              return; // No añadir entidad si no hay qué mostrar
                         }

                        // Sonido de fondo (opcional, igual para ambos tipos)
                        if (poi.soundUrl) { /* ... Atributos de sonido sin cambios ... */ 
                            entity.setAttribute('sound', `
                                src: url(${poi.soundUrl}); 
                                autoplay: true; loop: true; volume: 0.8; 
                                poolSize: 3; positional: true; refDistance: 5; rolloffFactor: 2;
                            `);
                        }
                         entity.id = `poi-${doc.id.substring(0,8)}`; 
                        poiContainer.appendChild(entity);
                        loadedCount++;
                    } 
                });
                
            } catch (error) { /* ... Error handling sin cambios ... */ } 
            finally { /* ... Mensajes de log sin cambios ... */ }

            arScene.appendChild(arCamera); // Sin cambios
            arScene.appendChild(poiContainer); // Sin cambios
            
            // Añadir luces (sin cambios)
             let ambientLight = arScene.querySelector('a-light[type="ambient"]'); /* ... */
             if (!ambientLight) { /* ... crear ambient ... */ 
                 ambientLight = document.createElement('a-light');
                 ambientLight.setAttribute('type', 'ambient');
                 ambientLight.setAttribute('color', '#BBB'); 
                 ambientLight.setAttribute('intensity', '0.7'); 
                 arScene.appendChild(ambientLight);
             }
             let directionalLight = arScene.querySelector('a-light[type="directional"]'); /* ... */
             if (!directionalLight) { /* ... crear directional ... */ 
                 directionalLight = document.createElement('a-light');
                 directionalLight.setAttribute('type', 'directional');
                 directionalLight.setAttribute('color', '#FFF');
                 directionalLight.setAttribute('intensity', '0.8'); 
                 directionalLight.setAttribute('position', '-1 2 1.5'); 
                 directionalLight.setAttribute('castShadow', 'true'); 
                 arScene.appendChild(directionalLight);
             }


            arSceneContainer.appendChild(arScene); // Sin cambios
            
            // Listeners loaded/error (sin cambios)
            arScene.addEventListener('loaded', () => { /* ... */ }); // Sin cambios
            arScene.addEventListener('error', (err) => { /* ... */ }); // Sin cambios
        }


        function stopAR() { /* ... Código sin cambios ... */ } // Sin cambios


        function onGPSUpdate(event) { /* ... Código sin cambios ... */ } // Sin cambios
        function onGPSError(event) { /* ... Código sin cambios ... */ } // Sin cambios
        function startGPSWatch() { /* ... Código sin cambios ... */ } // Sin cambios

        // --- Event Listeners de Navegación ---
         function setupNavigationListeners() {
             // Limpiar listeners viejos antes de añadir nuevos
             document.getElementById('goto-map-btn')?.removeEventListener('click', handleGoToMap);
             document.getElementById('goto-ar-btn')?.removeEventListener('click', handleGoToSummary); // CAMBIO: Va a Resumen
             document.getElementById('back-to-admin-btn')?.removeEventListener('click', handleBackToAdmin);
             document.getElementById('goto-summary-btn')?.removeEventListener('click', handleGoToSummary); // NUEVO BOTÓN
             document.getElementById('back-to-map-btn')?.removeEventListener('click', handleGoToMap); // NUEVO BOTÓN (Resumen -> Mapa)
             document.getElementById('launch-ar-btn')?.removeEventListener('click', handleLaunchAR); // NUEVO BOTÓN (Resumen -> AR)
             document.getElementById('back-to-summary-btn')?.removeEventListener('click', handleBackToSummary); // NUEVO BOTÓN (AR -> Resumen)
             document.getElementById('grant-permissions-btn')?.removeEventListener('click', handleGrantPermissions);

             // Añadir listeners actualizados
             document.getElementById('goto-map-btn')?.addEventListener('click', handleGoToMap);
             document.getElementById('goto-ar-btn')?.addEventListener('click', handleGoToSummary); // CAMBIO
             document.getElementById('back-to-admin-btn')?.addEventListener('click', handleBackToAdmin);
             document.getElementById('goto-summary-btn')?.addEventListener('click', handleGoToSummary); // NUEVO
             document.getElementById('back-to-map-btn')?.addEventListener('click', handleGoToMap); // NUEVO
             document.getElementById('launch-ar-btn')?.addEventListener('click', handleLaunchAR); // NUEVO
             document.getElementById('back-to-summary-btn')?.addEventListener('click', handleBackToSummary); // NUEVO
             document.getElementById('grant-permissions-btn')?.addEventListener('click', handleGrantPermissions);
             
             console.log("Listeners de navegación reconfigurados.");
         }

         // Funciones manejadoras actualizadas
         function handleGoToMap() { navigateTo('map'); }
         function handleGoToSummary() { navigateTo('summary'); } // Nueva función de destino
         function handleBackToAdmin() { navigateTo('admin'); }
         function handleLaunchAR() { navigateTo('ar'); } // Lanzar AR desde resumen
         function handleBackToSummary() { navigateTo('summary'); } // Volver a resumen desde AR
         function handleGrantPermissions() { /* ... sin cambios ... */ 
             permissionModal.style.display = 'none';
             startARFlow(); 
         }


        // Iniciar la aplicación
         document.addEventListener('DOMContentLoaded', () => {
             initializeApp();
             setupNavigationListeners(); 
         });

    </script>
</body>
</html>



