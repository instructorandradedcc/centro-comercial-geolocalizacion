<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor AR Arquitectura con Administración</title>
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page { display: none; height: 100%; width: 100%; position: relative; overflow-y: auto; padding-bottom: 60px; }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .control-button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .control-button:hover:not(:disabled) { background-color: #45a049; }
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.7; }
        #message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 8px; font-size: 1rem; z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        #message-box.show { opacity: 1; }
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 10px black; pointer-events: none; z-index: 1000; }
        #coords-jumpto { position: fixed; top: 20px; left: 20px; z-index: 402; background-color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center; }
        #map-center-coords { position: fixed; top: 75px; left: 20px; z-index: 402; background-color: rgba(0, 0, 0, 0.75); color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; font-family: monospace; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        #map-center-coords span { display: block; }
        .map-panel { position: fixed; top: 80px; left: 10px; z-index: 401; background-color: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px; width: 90%; max-height: calc(100vh - 180px); overflow-y: auto; backdrop-filter: blur(5px); }
        #edit-location-panel { border: 2px solid #f59e0b; }
        #placed-pois-panel { left: auto; right: 10px; }
        #placement-preview-image { max-width: 100px; max-height: 100px; margin: 10px auto; border: 1px solid #ccc; border-radius: 4px; display: none; object-fit: contain; }
        a-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: transparent; }
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }
        #ar-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; }
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }
        .ar-loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10002; }
        .ar-loading-screen.active { display: flex; }
        video, .arjs-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; display: block; opacity: 1; visibility: visible; autoplay: true; playsinline: true; webkit-playsinline: true; muted: true; }
        canvas, .a-canvas { background: transparent; z-index: 1; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        @media (max-width: 768px) { #map-controls { top: 120px; right: 10px; } .map-ui-container { width: 280px; bottom: 10px; } #coords-jumpto { top: 70px; left: 10px; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- PÁGINA 1: Panel de Administración -->
    <div id="admin-page" class="page active">
        <div class="container mx-auto p-6 max-w-4xl">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-blue-700">Panel de Administración AR <span id="version-display" class="text-sm font-normal text-gray-400 ml-2"></span></h1>
                <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600" disabled>Ir al Mapa</button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">1. Seleccionar Contenido</h2>
                <p class="text-gray-600 mb-4">Marca los modelos o define el video a posicionar.</p>
                <div id="ecopiensa-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-4"><p id="loading-models-placeholder" class="text-gray-500 col-span-full">Cargando modelos...</p></div>
                <div class="mt-4 pt-4 border-t"><label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer"><input type="checkbox" id="select-video-cb" class="h-5 w-5 text-blue-600"><span>Añadir Video Personalizado</span></label></div>
                <h2 class="text-2xl font-semibold mt-6 mb-4">2. Ir al Mapa</h2>
                <p class="text-gray-600">El contenido seleccionado estará disponible en el mapa.</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Contenido Guardado</h2>
                <div id="poi-list-container" class="space-y-4"><p id="loading-pois" class="text-gray-500 font-semibold">Inicializando Firebase...</p></div>
            </div>
        </div>
    </div>

    <!-- PÁGINA 2: Vista de Mapa -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div>
        </div>
        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div>
        <div id="map-center-coords"><span>Lat: --</span><span>Lon: --</span></div>
        <div id="placement-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Colocar Nuevo Contenido</h3>
            <div id="models-to-place-list" class="space-y-2 mb-4"><p class="text-sm text-gray-500">No hay contenido seleccionado.</p></div>
            <div class="slider-container mb-4"><label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom</label><input id="map-zoom-slider" type="range" min="1" max="22" value="15" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>
            <div id="placement-form-container" class="hidden space-y-3">
                <h4 id="placing-model-name" class="font-semibold text-blue-600 text-center text-lg mb-2"></h4>
                <img id="placement-preview-image" src="" alt="Vista previa">
                <div><label class="block text-sm font-medium text-gray-700">Tipo</label><select id="place-poi-type" class="mt-1 w-full p-2 border border-gray-300 rounded"><option value="model">Modelo 3D</option><option value="video">Video</option></select></div>
                <div id="model-fields"><label for="place-model-url" class="block text-sm font-medium text-gray-700">URL Modelo (.glb)</label><input type="url" id="place-model-url" class="mt-1 w-full p-2 border border-gray-300 rounded bg-gray-100" readonly></div>
                <div id="video-fields" class="hidden"><label for="place-video-url" class="block text-sm font-medium text-gray-700">URL Video (.mp4)</label><input type="url" id="place-video-url" class="mt-1 w-full p-2 border border-gray-300 rounded"></div>
                <div><label for="place-name" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="place-name" class="mt-1 w-full p-2 border border-gray-300 rounded"></div>
                <div><label for="place-scale" class="block text-sm font-medium text-gray-700">Escala</label><input type="number" id="place-scale" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="1.0"></div>
                <div><label for="place-ground-height" class="block text-sm font-medium text-gray-700">Altura (m)</label><input type="number" id="place-ground-height" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="0.0"></div>
                <div><label for="place-start-date" class="block text-sm font-medium text-gray-700">Inicio</label><input type="date" id="place-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded"></div>
                <div><label for="place-end-date" class="block text-sm font-medium text-gray-700">Fin</label><input type="date" id="place-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded"></div>
                <button id="save-placement-btn" class="w-full bg-green-500 hover:bg-green-600 text-white p-2 rounded">Guardar Ubicación</button>
                <button id="cancel-placement-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded">Cancelar</button>
            </div>
        </div>
        <div id="placed-pois-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Contenido en Mapa</h3>
            <p class="text-xs text-amber-700 mb-2">Datos en Firebase.</p>
            <div id="placed-pois-list" class="space-y-3"><p class="text-sm text-gray-500">Cargando...</p></div>
        </div>
        <div id="edit-location-panel" class="map-panel hidden">
            <h3 class="text-lg font-semibold mb-2">Editando Ubicación</h3>
            <p id="editing-poi-name" class="text-sm font-medium text-gray-700 mb-2"></p>
            <button id="save-edit-location-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white p-2 rounded mb-2">Guardar Nueva Ubicación</button>
            <button id="cancel-edit-location-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded">Cancelar</button>
        </div>
        <div id="map-controls">
            <button id="back-to-admin-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver</button>
            <button id="goto-ar-btn" class="control-button bg-purple-500 hover:bg-purple-600">Iniciar AR</button>
        </div>
    </div>

    <!-- PÁGINA 3: Vista AR -->
    <div id="ar-page" class="page">
        <div id="ar-loading-screen" class="ar-loading-screen active">
            <div class="loading-content"><div class="loader"></div><div id="loading-status-text" class="text-xl">Preparando...</div></div>
        </div>
        <div id="ar-scene-container"></div>
        <div class="ar-info-panel"><div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div><div><strong>Precisión:</strong> <span id="gps-accuracy">--</span>m</div></div>
        <div id="ar-controls"><button id="back-to-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Mapa</button></div>
    </div>

    <!-- Modal de Permisos -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content"><h2>Permisos</h2><p>Necesitamos acceso a cámara y ubicación.</p><button id="grant-permissions-btn" class="permission-button">Conceder</button></div>
    </div>

    <div id="message-box"></div>

    <script>
        let arLibrariesLoaded = false;
        function loadARLibraries() {
            if (arLibrariesLoaded) return Promise.resolve();
            return new Promise((resolve) => {
                const aframeScript = document.createElement('script');
                aframeScript.src = 'https://aframe.io/releases/1.3.0/aframe.min.js';
                document.head.appendChild(aframeScript);
                aframeScript.onload = () => {
                    const arjsScript = document.createElement('script');
                    arjsScript.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js';
                    document.head.appendChild(arjsScript);
                    arjsScript.onload = () => { arLibrariesLoaded = true; resolve(); };
                };
            });
        }

        const APP_VERSION = '1.22';
        const firebaseConfig = {
            apiKey: "AIzaSyBkxP7vqrVZMRhl-vUpHMMKjj5aIujDQ3k",
            authDomain: "centro-comercial-1ea64.firebaseapp.com",
            projectId: "centro-comercial-1ea64",
            storageBucket: "centro-comercial-1ea64.appspot.com",
            messagingSenderId: "667808330264",
            appId: "1:667808330264:web:9718955b58aba4359b096d"
        };
        let db, auth, userId, poiCollectionRef, map, poiMarkers = {}, allPoisData = [], modelsToPlace = [];
        let pages = {}, messageBox, permissionModal, arLoadingScreen, loadingStatusText, versionDisplay;
        let listContainer, loadingPois, ecopiensaSelectionList, loadingModelsPlaceholder, selectVideoCheckbox;
        let placementPanel, modelsToPlaceList, placementFormContainer, placingModelName, cancelPlacementBtn, savePlacementBtn;
        let mapZoomSlider, jumptoBtn, placePoiTypeSelect, modelFieldsDiv, videoFieldsDiv, placeModelUrlInput, placeVideoUrlInput, placeNameInput;
        let placedPoisPanel, placedPoisList, editLocationPanel, editingPoiNameEl, saveEditLocationBtn, cancelEditLocationBtn;
        let gotoMapButton, placementPreviewImageEl, arScene, gpsWatchId;

        const ECOPIENZA_MODELS = [
            { name: 'Botellita Azul', modelUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/botellytaazul.glb', imageUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/botellytaazul.jpg' },
            { name: 'Ecoladrillo', modelUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/ecoladrillo.glb', imageUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/ecoladrillo.jpg' },
            { name: 'Lata Plateada', modelUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/lataplateada.glb', imageUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/lataplateada.jpg' },
            { name: 'Papelito Verde', modelUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/papelitoverde.glb', imageUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/papelitoverde.jpg' },
            { name: 'Señor Contenedor', modelUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/senorcontenedor.glb', imageUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/senorcontenedor.jpg' },
            { name: 'Tapa Roja', modelUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/taparoja.glb', imageUrl: 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/taparoja.jpg' }
        ];
        const CUSTOM_VIDEO_PLACEHOLDER = { name: "Video Personalizado", url: "CUSTOM_VIDEO", isCustomVideo: true, imageUrl: "https://placehold.co/100x100/764ba2/white?text=Video" };

        function showMessage(msg, duration = 3000) {
            messageBox.textContent = msg; messageBox.classList.add('show'); setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function navigateTo(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active')); pages[pageName].classList.add('active');
            if (pageName === 'map') { stopAR(); setTimeout(initMap, 100); }
            else if (pageName === 'ar') { stopMap(); startARFlow(); }
            else if (pageName === 'admin') { stopAR(); stopMap(); initializeModelSelection(); loadAndListenPois(); }
        }

        function stopMap() { if (map) { map.remove(); map = null; Object.values(poiMarkers).forEach(m => m.remove()); poiMarkers = {}; } }
        function stopAR() { if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; } if (arScene) { arScene.parentNode.removeChild(arScene); arScene = null; } }

        async function initializeFirebase() {
            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) { showMessage("Error: Configuración de Firebase inválida.", 10000); return; }
            try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => { if (user) { userId = user.uid; poiCollectionRef = collection(db, `/artifacts/default-app-id/public/data/pois`); gotoMapButton.disabled = false; loadAndListenPois(); } });
            } catch (e) { showMessage(`Error al inicializar Firebase: ${e.message}`, 8000); }
        }

        function displayAppVersion() { versionDisplay.textContent = `v${APP_VERSION}`; }
        function initializeModelSelection() { loadingModelsPlaceholder.style.display = 'none'; ECOPIENZA_MODELS.forEach(m => createCheckbox(m.name, m.modelUrl, false, false, m.imageUrl)); selectVideoCheckbox.addEventListener('change', handleVideoCheckboxChange); }
        function createCheckbox(name, url, checked, isVideo, imageUrl) { const label = document.createElement('label'); label.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer'; label.innerHTML = `<input type="checkbox" class="model-select-cb h-5 w-5 text-blue-600" data-name="${name}" data-url="${url}" data-image-url="${imageUrl}">${name}`; label.querySelector('input').addEventListener('change', handleCheckboxChange); ecopiensaSelectionList.appendChild(label); }
        function handleVideoCheckboxChange(e) { if (e.target.checked) modelsToPlace.push(CUSTOM_VIDEO_PLACEHOLDER); else modelsToPlace = modelsToPlace.filter(m => !m.isCustomVideo); }
        function handleCheckboxChange(e) { const item = { name: e.target.dataset.name, url: e.target.dataset.url, imageUrl: e.target.dataset.imageUrl }; if (e.target.checked) modelsToPlace.push(item); else modelsToPlace = modelsToPlace.filter(m => m.url !== item.url); }

        function loadAndListenPois() { onSnapshot(query(poiCollectionRef), (snapshot) => { allPoisData = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); listContainer.innerHTML = allPoisData.map(p => `<div class="poi-item p-4 border rounded-lg flex justify-between"><span>${p.name}</span><button data-id="${p.id}" class="delete-btn bg-red-500 text-white p-2 rounded">Eliminar</button></div>`).join(''); listContainer.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', async (e) => { if (confirm("¿Eliminar?")) { await deleteDoc(doc(db, poiCollectionRef.path, e.target.dataset.id)); showMessage("Eliminado.", 2000); } })); }, (e) => showMessage(`Error: ${e.message}`, 5000)); }

        function initMap() {
            if (!map) { map = L.map('map-canvas', { zoomControl: false }).setView([4.0835, -76.1915], 15); L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 22 }).addTo(map); }
            map.on('move', updateCenterCoordsDisplay); updateCenterCoordsDisplay(); mapZoomSlider.value = map.getZoom(); mapZoomSlider.addEventListener('input', () => map.setZoom(mapZoomSlider.value)); map.on('zoomend', () => mapZoomSlider.value = map.getZoom());
            jumptoBtn.addEventListener('click', () => { const lat = parseFloat(jumptoLat.value), lon = parseFloat(jumptoLon.value); if (!isNaN(lat) && !isNaN(lon)) map.setView([lat, lon], 18); });
            placePoiTypeSelect.addEventListener('change', handlePoiTypeChange); handlePoiTypeChange(); populatePlacementPanel();
        }

        function updateCenterCoordsDisplay() { if (map) { const c = map.getCenter(); mapCenterCoordsEl.innerHTML = `<span>Lat: ${c.lat.toFixed(6)}</span><span>Lon: ${c.lng.toFixed(6)}</span>`; } }
        function handlePoiTypeChange() { const isVideo = placePoiTypeSelect.value === 'video'; modelFieldsDiv.classList.toggle('hidden', isVideo); videoFieldsDiv.classList.toggle('hidden', !isVideo); placeModelUrlInput.disabled = isVideo; placeVideoUrlInput.disabled = !isVideo; document.querySelector('label[for="place-scale"]').textContent = isVideo ? 'Ancho (m)' : 'Escala'; }
        function populatePlacementPanel() { modelsToPlaceList.innerHTML = modelsToPlace.map(m => `<button class="place-btn control-button bg-blue-500 hover:bg-blue-600 w-full text-left" data-name="${m.name}" data-url="${m.url}" data-image-url="${m.imageUrl}">${m.name}</button>`).join(''); modelsToPlaceList.querySelectorAll('.place-btn').forEach(b => b.addEventListener('click', (e) => startPlacement({ name: e.target.dataset.name, url: e.target.dataset.url, imageUrl: e.target.dataset.imageUrl }))); }
        function startPlacement(data) { isPlacingModel = true; placingModelName.textContent = `Colocando: ${data.name}`; placementPreviewImageEl.src = data.imageUrl; placementPreviewImageEl.style.display = 'block'; placePoiTypeSelect.value = data.url === CUSTOM_VIDEO_PLACEHOLDER.url ? 'video' : 'model'; handlePoiTypeChange(); placeNameInput.value = data.name; placeModelUrlInput.value = data.url !== CUSTOM_VIDEO_PLACEHOLDER.url ? data.url : ''; placeVideoUrlInput.value = data.url === CUSTOM_VIDEO_PLACEHOLDER.url ? '' : ''; modelsToPlaceList.classList.add('hidden'); placementFormContainer.classList.remove('hidden'); }
        function cancelPlacement() { isPlacingModel = false; modelsToPlaceList.classList.remove('hidden'); placementFormContainer.classList.add('hidden'); placementPreviewImageEl.style.display = 'none'; }
        async function handleSavePlacement() { if (isPlacingModel) { const latlng = map.getCenter(); const poi = { name: placeNameInput.value, poiType: placePoiTypeSelect.value, modelUrl: placeModelUrlInput.value, videoUrl: placeVideoUrlInput.value, lat: latlng.lat, lon: latlng.lng, scale: parseFloat(placeScale.value), groundHeight: parseFloat(placeGroundHeight.value), startDate: placeStartDate.value, endDate: placeEndDate.value }; await addDoc(poiCollectionRef, poi); showMessage("Guardado.", 2000); modelsToPlace = modelsToPlace.filter(m => m.url !== poi.modelUrl && m.url !== poi.videoUrl); cancelPlacement(); populatePlacementPanel(); } }

        async function startARFlow() {
            arLoadingScreen.classList.add('active'); loadingStatusText.textContent = 'Solicitando permisos...';
            try { await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); await new Promise((r) => navigator.geolocation.getCurrentPosition(r, r, { enableHighAccuracy: true, timeout: 15000 })); await loadARLibraries(); await initializeARScene(); } catch (e) { showMessage(`Error en AR: ${e.message}`, 6000); navigateTo('map'); }
        }

        async function initializeARScene() {
            const container = document.getElementById('ar-scene-container'); container.innerHTML = '';
            arScene = document.createElement('a-scene'); arScene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false'); arScene.setAttribute('vr-mode-ui', 'enabled: false');
            const camera = document.createElement('a-camera'); camera.setAttribute('gps-camera', 'gpsMinDistance: 5'); arScene.appendChild(camera);
            const poiContainer = document.createElement('a-entity'); arScene.appendChild(poiContainer);
            allPoisData.forEach(poi => { if (new Date() >= new Date(poi.startDate) && new Date() <= new Date(poi.endDate)) { const e = document.createElement('a-entity'); e.setAttribute('gps-entity-place', `latitude: ${poi.lat}; longitude: ${poi.lon}`); e.setAttribute('position', `0 ${poi.groundHeight} 0`); if (poi.poiType === 'video') e.setAttribute('geometry', `primitive: plane; width: ${poi.scale}; height: ${poi.scale * 0.5625}`); else e.setAttribute('gltf-model', poi.modelUrl); poiContainer.appendChild(e); } });
            container.appendChild(arScene); arScene.addEventListener('loaded', () => { arLoadingScreen.classList.remove('active'); showMessage("AR listo.", 3000); }); arScene.addEventListener('error', (e) => showMessage("Error en escena AR.", 5000));
        }

        document.addEventListener('DOMContentLoaded', () => {
            pages.admin = document.getElementById('admin-page'); pages.map = document.getElementById('map-page'); pages.ar = document.getElementById('ar-page');
            messageBox = document.getElementById('message-box'); permissionModal = document.getElementById('permission-modal'); arLoadingScreen = document.getElementById('ar-loading-screen');
            loadingStatusText = document.getElementById('loading-status-text'); versionDisplay = document.getElementById('version-display'); listContainer = document.getElementById('poi-list-container');
            loadingPois = document.getElementById('loading-pois'); ecopiensaSelectionList = document.getElementById('ecopiensa-selection-list'); loadingModelsPlaceholder = document.getElementById('loading-models-placeholder');
            selectVideoCheckbox = document.getElementById('select-video-cb'); gotoMapButton = document.getElementById('goto-map-btn'); placementPanel = document.getElementById('placement-panel');
            modelsToPlaceList = document.getElementById('models-to-place-list'); placementFormContainer = document.getElementById('placement-form-container'); placingModelName = document.getElementById('placing-model-name');
            cancelPlacementBtn = document.getElementById('cancel-placement-btn'); savePlacementBtn = document.getElementById('save-placement-btn'); mapZoomSlider = document.getElementById('map-zoom-slider');
            jumptoBtn = document.getElementById('jumpto-btn'); placePoiTypeSelect = document.getElementById('place-poi-type'); modelFieldsDiv = document.getElementById('model-fields');
            videoFieldsDiv = document.getElementById('video-fields'); placeModelUrlInput = document.getElementById('place-model-url'); placeVideoUrlInput = document.getElementById('place-video-url');
            placeNameInput = document.getElementById('place-name'); placedPoisPanel = document.getElementById('placed-pois-panel'); placedPoisList = document.getElementById('placed-pois-list');
            editLocationPanel = document.getElementById('edit-location-panel'); editingPoiNameEl = document.getElementById('editing-poi-name'); saveEditLocationBtn = document.getElementById('save-edit-location-btn');
            cancelEditLocationBtn = document.getElementById('cancel-edit-location-btn'); placementPreviewImageEl = document.getElementById('placement-preview-image');
            displayAppVersion(); initializeFirebase(); initializeModelSelection();
            document.getElementById('goto-map-btn').addEventListener('click', () => navigateTo('map')); document.getElementById('back-to-admin-btn').addEventListener('click', () => navigateTo('admin'));
            document.getElementById('goto-ar-btn').addEventListener('click', () => navigateTo('ar')); document.getElementById('back-to-map-btn').addEventListener('click', () => navigateTo('map'));
            document.getElementById('grant-permissions-btn').addEventListener('click', startARFlow); cancelPlacementBtn.addEventListener('click', cancelPlacement);
            savePlacementBtn.addEventListener('click', handleSavePlacement); saveEditLocationBtn.addEventListener('click', handleSaveEditLocation); cancelEditLocationBtn.addEventListener('click', cancelEditLocation);
        });
    </script>
</body>
</html>
