<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panel de Administración AR (Geolocalización)</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame y AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Inter', sans-serif;
        }
        .page {
            display: none; height: 100%; width: 100%;
            position: relative; overflow-y: auto; /* Allow scrolling on pages */
             padding-bottom: 60px; /* Add padding for controls */
        }
        .page.active { display: block; }
        .page#map-page { overflow: hidden; } /* Map page should not scroll */
        
        .page#login-page {
            display: none; /* Forced hidden when not active */
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* bg-gray-200 */
        }
        .page#login-page.active {
            display: flex; /* Forced visible/flex when active */
        }


        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .control-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .control-button:hover:not(:disabled) { background-color: #45a049; }
        .control-button:disabled { background-color: #a0a0a0; cursor: not-allowed; opacity: 0.7; }

        .delete-btn-map {
             background-color: #f44336; /* Red */
             color: white;
             font-size: 0.75rem; /* text-xs */
             padding: 0.25rem 0.5rem; /* px-2 py-1 */
             border-radius: 0.25rem; /* rounded */
             margin-left: 0.25rem; /* ml-1 */
             transition: background-color 0.3s;
        }
        .delete-btn-map:hover:not(:disabled) {
             background-color: #d32f2f;
        }
         .delete-btn-map.confirm {
             background-color: #ff9800; /* Orange */
         }
         .delete-btn-map.confirm:hover:not(:disabled) {
             background-color: #f57c00;
         }

         .secondary-action-btn {
            background-color: #607d8b; /* Blue Grey */
            color: white;
            padding: 8px 16px; /* Slightly smaller */
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 8px; /* Add some space */
         }
         .secondary-action-btn:hover:not(:disabled) {
             background-color: #546e7a;
         }

        #message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 1rem;
            z-index: 10001; opacity: 0; transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show { opacity: 1; }

        /* Estilos de Mapa y AR (adaptados) */
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #map-canvas { width: 100%; height: 100%; z-index: 1; cursor: grab; }
        #map-controls { position: fixed; top: 20px; right: 20px; z-index: 402; display: flex; flex-direction: column; gap: 10px; }

        #map-crosshair {
            position: absolute !important; 
            top: 50% !important; 
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 30px !important; 
            height: 30px !important; 
            border: 2px solid white !important;
            border-radius: 50% !important; 
            box-shadow: 0 0 10px black, 0 0 0 2px rgba(0, 0, 0, 0.5) !important; 
            pointer-events: none !important; 
            z-index: 1000 !important; 
        }

        #coords-jumpto {
            position: fixed; top: 20px; left: 20px; z-index: 402;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px; border-radius: 8-px; display: flex; gap: 5px; align-items: center;
        }
        #map-center-coords {
             position: fixed; 
             top: 75px; 
             left: 20px; 
             z-index: 402; 
             background-color: rgba(0, 0, 0, 0.75); 
             color: white; 
             padding: 8px 12px; 
             border-radius: 8px; 
             font-size: 0.8rem; 
             font-family: monospace; 
             box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #map-center-coords span { display: block; } 

        /* Panels on Map */
        .map-panel {
             position: fixed; 
             top: 80px; 
             left: 10px; 
             z-index: 401; 
             background-color: rgba(255, 255, 255, 0.95); 
             padding: 15px; 
             border-radius: 8px; 
             box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
             max-width: 300px; 
             width: 90%; 
             max-height: calc(100vh - 180px); 
             overflow-y: auto; 
             backdrop-filter: blur(5px);
        } 
        #edit-location-panel {
             border: 2px solid #f59e0b; 
         } 
        #placed-pois-panel {
             left: auto; 
             right: 10px; 
             max-width: 250px;
             transition: transform 0.3s ease-out;
        }
        #placed-pois-panel.minimized {
             transform: translateX(calc(100% - 40px)); 
             overflow-y: hidden;
             box-shadow: none;
             padding: 5px;
        }
        #placed-pois-panel.minimized h3, 
        #placed-pois-panel.minimized .text-xs,
        #placed-pois-panel.minimized #placed-pois-list {
            display: none;
        }
        #toggle-pois-btn {
            background-color: #607d8b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }


        #placement-preview-image {
             max-width: 100px; 
             max-height: 100px; 
             margin: 10px auto; 
             border: 1px solid #ccc; 
             border-radius: 4px; 
             display: none; 
             object-fit: contain; 
         }
        .leaflet-popup-content img.popup-image {
             max-width: 100px; 
             max-height: 100px; 
             display: block; 
             margin: 5px auto; 
             border-radius: 4px; 
         }

        a-scene { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 1 !important; }
        .arjs-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 10000; text-align: center; }
        .permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10001; }
        .permission-content { background-color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
        .permission-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }

        #ar-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; }
        .ar-info-panel { position: fixed; top: 20px; left: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-size: 14px; z-index: 9998; }
        
        /* Carga AR */
        .ar-loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #1a2a6c, #2a5298); color: white; 
            display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 10002; 
        }
        .ar-loading-screen.active { display: flex; }
        /* Barra de Progreso */
        #progress-bar-container { 
            width: 80%; max-width: 400px; background: rgba(255, 255, 255, 0.2); 
            border-radius: 5px; margin-top: 20px; height: 10px; 
            overflow: hidden; 
        }
        #progress-bar { 
            width: 0%; height: 100%; background: #4CAF50; 
            border-radius: 5px; transition: width 0.3s ease; 
        }
        #loading-asset-status {
             margin-top: 10px;
             font-size: 0.9rem;
             color: #ccc;
             min-height: 20px;
        }

        /* Guía AR */
        #ar-guide {
             position: fixed;
             top: 100px;
             left: 50%;
             transform: translateX(-50%);
             background-color: rgba(0, 0, 0, 0.7);
             color: white;
             padding: 10px 15px;
             border-radius: 8px;
             font-size: 1.1rem;
             font-weight: bold;
             z-index: 9999;
             text-align: center;
             display: none;
             border: 2px solid #FFC107;
        }
        
        /* Control de Escala en AR */
        #ar-scale-controls {
            position: fixed;
            bottom: 80px; /* Sobre ar-controls */
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 80%;
            max-width: 400px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .scale-label-ar {
             font-size: 0.8rem;
             font-weight: normal;
        }
        .scale-value-ar {
             font-weight: bold;
             color: #4CAF50;
        }


        /* Video AR styles */
        a-video { border: 2px solid white; background-color: black; }

        /* Correcciones de Video y Canvas AR */
        video, .arjs-video {
            position: fixed !important; top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important; object-fit: cover !important;
            z-index: -1 !important; display: block !important; opacity: 1 !important;
            visibility: visible !important; autoplay: true !important;
            playsinline: true !important; webkit-playsinline: true !important;
            muted: true !important;
        }
        canvas, .a-canvas {
            background: transparent !important; background-color: rgba(0, 0, 0, 0) !important;
            z-index: 1 !important; position: fixed !important; top: 0 !important;
            left: 0 !important; width: 100% !important; height: 100% !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- PÁGINA 0: Login -->
    <div id="login-page" class="page active flex items-center justify-center bg-gray-200">
        <div class="bg-white p-10 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h1 class="text-3xl font-bold text-blue-700 mb-6">Admin AR</h1>
            <p class="text-gray-600 mb-8">Por favor, inicia sesión para continuar.</p>
            <button id="google-login-btn" class="control-button bg-blue-500 hover:bg-blue-600 w-full flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.35 12.24c0-.79-.07-1.54-.2-2.28h-9.15v4.3h5.16c-.22 1.4-.87 2.6-1.95 3.4v2.8h3.59c2.1-1.9 3.3-4.5 3.3-7.22z"/><path d="M12 21.8c2.6 0 4.7-.87 6.2-2.3l-3.6-2.8c-.87.6-1.9.9-3.1.9-2.4 0-4.5-1.6-5.2-3.8H3.1v2.9c1.5 3 4.5 5 8.2 5z"/><path d="M6.8 14.3c-.2-.6-.3-1.2-.3-1.8s.1-1.2.3-1.8V7.8H3.1c-.6 1.2-1 2.5-1 4s.4 2.8 1 4l3.7-2.9z"/><path d="M12 6.3c1.4 0 2.6.5 3.6 1.4l3.2-3.2C17.2 2.8 14.8 2 12 2c-3.7 0-6.7 2-8.2 5l3.7 2.9c.7-2.2 2.8-3.8 5.2-3.8z"/></svg>
                <span>Iniciar Sesión con Google</span>
            </button>
        </div>
    </div>

    <!-- PÁGINA 1: Panel de Administración -->
    <div id="admin-page" class="page">
        <div class="container mx-auto p-6 max-w-4xl">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-blue-700">Panel de Administración AR</h1>
                    <div class="text-sm text-gray-500 mt-1">
                        <span id="version-display" class="font-normal align-middle"></span>
                        <span id="user-info" class="hidden ml-4">
                            Logueado como: <strong id="user-email"></strong>
                        </span>
                    </div>
                </div>
                <div>
                    <button id="logout-btn" class="control-button bg-red-500 hover:bg-red-600 hidden">Salir</button>
                    <button id="goto-map-btn" class="control-button bg-indigo-500 hover:bg-indigo-600 ml-2" disabled>Ir al Mapa</button> 
                </div>
            </div>

            <!-- Sección de Selección de Modelos -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">1. Seleccionar Contenido para Colocar</h2>
                <p class="text-gray-600 mb-4">Marca los modelos o define el video que quieres posicionar en el mapa.</p>
                <div id="ecopiensa-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                     <p id="loading-models-placeholder" class="text-gray-500 col-span-full">Cargando modelos...</p>
                </div>
                <!-- Sección para Video (opcional) -->
                <div class="mt-4 pt-4 border-t">
                     <label class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                           <input type="checkbox" id="select-video-cb" class="h-5 w-5 text-blue-600">
                           <span>Añadir un Video Personalizado</span>
                     </label>
                </div>

                <h2 class="text-2xl font-semibold mt-6 mb-4">2. Ir al Mapa para Posicionar</h2>
                <p class="text-gray-600">El contenido que selecciones aquí estará disponible en el panel del mapa.</p>
                 <button id="clear-selection-btn" class="mt-4 text-sm text-red-600 hover:text-red-800 underline">Limpiar selección guardada</button>
            </div>

            <!-- Lista de POIs existentes (para eliminar) -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Contenido Geoposicionado Guardado</h2>
                <div id="poi-list-container" class="space-y-4">
                    <p id="loading-pois" class="text-gray-500 font-semibold">Inicializando Firebase...</p> 
                 </div>
            </div>
        </div>
    </div>
    
    <!-- PÁGINA 2: Vista de Mapa -->
    <div id="map-page" class="page">
        <div id="map-container">
            <div id="map-canvas"></div>
            <div id="map-crosshair"></div> 
         </div>

        <div id="coords-jumpto">
            <input type="number" id="jumpto-lat" placeholder="Latitud" class="w-24 p-1 border rounded text-sm">
            <input type="number" id="jumpto-lon" placeholder="Longitud" class="w-24 p-1 border rounded text-sm">
            <button id="jumpto-btn" class="control-button bg-blue-500 hover:bg-blue-600 p-2 text-sm">Ir</button>
        </div> 
                 <div id="map-center-coords">
             <span>Lat: --</span>
             <span>Lon: --</span>
         </div>

        <!-- Panel de Colocación (Izquierda) -->
        <div id="placement-panel" class="map-panel">
            <h3 class="text-lg font-semibold mb-2">Colocar Nuevo Contenido</h3>
            <div id="models-to-place-list" class="space-y-2 mb-4">
                <p class="text-sm text-gray-500">No hay contenido nuevo seleccionado. Vuelve al Panel.</p>
            </div>
            
            <div class="slider-container mb-4">
                <label for="map-zoom-slider" class="block text-sm font-medium text-gray-700">Zoom del Mapa</label>
                <input id="map-zoom-slider" type="range" min="1" max="22" value="15" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            
            <div id="placement-form-container" class="hidden space-y-3">
                <h4 id="placing-model-name" class="font-semibold text-blue-600 text-center text-lg mb-2"></h4>
                                 
                 <img id="placement-preview-image" src="" alt="Vista previa">

                 <div>
                     <label class="block text-sm font-medium text-gray-700">Tipo de POI</label>
                     <select id="place-poi-type" class="mt-1 w-full p-2 border border-gray-300 rounded">
                         <option value="model" selected>Modelo 3D</option>
                         <option value="video">Video (.mp4)</option>
                     </select>
                 </div>

                 <div id="model-fields">
                     <div>
                         <label for="place-model-url" class="block text-sm font-medium text-gray-700">URL Modelo (.glb)</label>
                         <input type="url" id="place-model-url" class="mt-1 w-full p-2 border border-gray-300 rounded bg-gray-100" readonly>
                     </div>
                 </div>
                 <div id="video-fields" class="hidden"> 
                      <div>
                         <label for="place-video-url" class="block text-sm font-medium text-gray-700">URL Video (.mp4)</label>
                         <input type="url" id="place-video-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../video.mp4">
                     </div>
                 </div>

                <div>
                    <label for="place-name" class="block text-sm font-medium text-gray-700">Nombre Descriptivo</label>
                    <input type="text" id="place-name" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-scale" class="block text-sm font-medium text-gray-700">Escala (Video: ancho en metros)</label>
                    <input type="number" id="place-scale" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="1.0">
                </div>
                <div>
                    <label for="place-ground-height" class="block text-sm font-medium text-gray-700">Altura sobre terreno (m)</label>
                    <input type="number" id="place-ground-height" class="mt-1 w-full p-2 border border-gray-300 rounded" step="0.1" value="0.0">
                </div>
                <div>
                    <label for="place-sound-url" class="block text-sm font-medium text-gray-700">URL Sonido Fondo (Opcional, .mp3)</label>
                    <input type="url" id="place-sound-url" class="mt-1 w-full p-2 border border-gray-300 rounded" placeholder="https://.../musica.mp3">
                </div>
                <div>
                    <label for="place-start-date" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                    <input type="date" id="place-start-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label for="place-end-date" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                    <input type="date" id="place-end-date" class="mt-1 w-full p-2 border border-gray-300 rounded">
                </div>
                
                <p class="text-sm text-blue-600 font-semibold pt-2">Mueve el mapa para centrar la cruz en la ubicación deseada.</p>
                <button id="save-placement-btn" class="w-full bg-green-500 hover:bg-green-600 text-white p-2 rounded transition duration-300 font-bold">
                    Guardar Ubicación (en la Cruz)
                </button>
                <button id="back-to-selection-btn" class="w-full secondary-action-btn hover:bg-gray-600">Volver a Seleccionar Modelo</button>
                <button id="cancel-placement-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300 mt-2">Cancelar Colocación Total</button>
             </div>
        </div>
        
         <!-- Panel de POIs Guardados (Derecha) -->
         <div id="placed-pois-panel" class="map-panel right-3">
              <h3 class="text-lg font-semibold mb-2">Contenido en el Mapa</h3>
              <p class="text-xs text-amber-700 mb-2">Datos guardados en Firebase.</p>
             <div id="placed-pois-list" class="space-y-3">
                 <p class="text-sm text-gray-500">Cargando contenido guardado...</p>
             </div>
         </div>
        
         <!-- Panel de Edición de Ubicación -->
         <div id="edit-location-panel" class="map-panel hidden">
             <h3 class="text-lg font-semibold mb-2">Editando Ubicación</h3>
             <p id="editing-poi-name" class="text-sm font-medium text-gray-700 mb-2"></p>
             <p class="text-sm text-amber-700 font-semibold mb-3">Mueve el mapa para centrar la cruz en la NUEVA ubicación.</p>
             <button id="save-edit-location-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white p-2 rounded transition duration-300 font-bold mb-2">
                 Guardar Nueva Ubicación (en la Cruz)
             </button>
             <button id="cancel-edit-location-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white p-2 rounded transition duration-300">
                 Cancelar Edición
             </button>
         </div>

        <div id="map-controls">
            <button id="toggle-pois-btn" class="control-button bg-gray-700 hover:bg-gray-800">Ocultar POIs</button>
            <button id="back-to-admin-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Panel</button>
            <button id="goto-summary-btn" class="control-button bg-purple-500 hover:bg-purple-600">Ver Resumen</button> 
         </div>
    </div>

    <!-- PÁGINA 3: Resumen y Lanzamiento AR -->
    <div id="summary-page" class="page">
         <div class="container mx-auto p-6 max-w-4xl">
             <div class="flex justify-between items-center mb-8">
                 <h1 class="text-3xl font-bold text-purple-700">Resumen de Configuración AR</h1>
                 <div>
                     <button id="back-to-map-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Mapa</button>
                     <button id="launch-ar-btn" class="control-button bg-green-500 hover:bg-green-600">¡Probar AR!</button> 
                  </div>
             </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold mb-4">Contenido Configurado</h2>
                  <p class="text-gray-600 mb-4">Este es el contenido que se mostrará en la Realidad Aumentada (si está dentro de las fechas activas).</p>
                 <div id="summary-poi-list" class="space-y-4">
                     <p id="loading-summary-pois" class="text-gray-500">Cargando resumen...</p>
                 </div>
             </div>
         </div>
    </div>

    <!-- PÁGINA 4: Vista de Realidad Aumentada -->
    <div id="ar-page" class="page">
        <div id="ar-loading-screen" class="ar-loading-screen active">
            <div class="loading-content flex flex-col items-center">
                <div class="loader"></div>
                <div id="loading-status-text" class="text-xl">Preparando componentes...</div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="loading-asset-status" class="text-center"></div>
            </div>
        </div>

        <div id="ar-scene-container"></div>
        
        <div id="ar-guide" style="display:none;">
            Modelo más cercano: <span id="guide-name"></span><br>
            Distancia: <span id="guide-distance">--m</span> - Dirección: <span id="guide-bearing">--</span>
        </div>
        
        <div id="ar-scale-controls">
             <label for="ar-scale-slider" class="scale-label-ar">Ajuste Fino de Escala: <span id="ar-scale-value-display" class="scale-value-ar">1.0x</span></label>
             <input id="ar-scale-slider" type="range" min="0.1" max="5.0" value="1.0" step="0.05" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>

        <div class="ar-info-panel">
            <div><strong>GPS:</strong> <span id="gps-status">Buscando...</span></div>
            <div><strong>Precisión:</strong> <span id="gps-accuracy" style="font-weight: bold;">--</span>m</div>
        </div>
        <div id="ar-controls">
            <button id="back-to-summary-btn" class="control-button bg-gray-500 hover:bg-gray-600">Volver al Resumen</button> 
         </div>
    </div>

    <!-- Modal para solicitar permisos -->
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h2>Permisos necesarios</h2>
            <p>Esta aplicación necesita acceso a tu cámara y ubicación para la experiencia de Realidad Aumentada.</p>
            <button id="grant-permissions-btn" class="permission-button">Conceder Permisos</button>
        </div>
    </div>

    <div id="message-box"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            deleteDoc,
            updateDoc, 
            onSnapshot, 
            getDocs,
            query,
            setLogLevel 
         } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Versión de la App ---
        const APP_VERSION = '1.43'; // CORREGIDO: Pide permiso de GPS (Alta Precisión) explícitamente al inicio (timeout 60s).
        // LocalStorage Key
        const LOCALSTORAGE_KEY = 'arAdminModelSelection';

        // --- Modelos de ECOPIENSA (con imageUrl) ---
        const GITHUB_BASE_URL_MODELS = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/modelss/';
        const GITHUB_BASE_URL_IMAGES = 'https://raw.githubusercontent.com/instructorandradedcc/7777ar/main/asetss/imagenes/'; 
        const ECOPIENSA_MODELS = [
            { name: 'Botellita Azul', modelUrl: `${GITHUB_BASE_URL_MODELS}botellytaazul.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}botellytaazul.jpg` },
            { name: 'Ecoladrillo', modelUrl: `${GITHUB_BASE_URL_MODELS}ecoladrillo.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}ecoladrillo.jpg` },
            { name: 'Lata Plateada', modelUrl: `${GITHUB_BASE_URL_MODELS}lataplateada.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}lataplateada.jpg` },
            { name: 'Papelito Verde', modelUrl: `${GITHUB_BASE_URL_MODELS}papelitoverde.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}papelitoverde.jpg` },
            { name: 'Señor Contenedor', modelUrl: `${GITHUB_BASE_URL_MODELS}senorcontenedor.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}senorcontenedor.jpg` },
            { name: 'Tapa Roja', modelUrl: `${GITHUB_BASE_URL_MODELS}taparoja.glb`, imageUrl: `${GITHUB_BASE_URL_IMAGES}taparoja.jpg` }
        ];
        const CUSTOM_VIDEO_PLACEHOLDER = { name: "Video Personalizado", url: "CUSTOM_VIDEO", isCustomVideo: true, imageUrl: "https://placehold.co/100x100/764ba2/white?text=Video" }; 

        // --- Configuración de Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        const firebaseConfig = { 
         apiKey: "AIzaSyBkxP7vqrVZMRhl-vUpHMMKjj5aIujDQ3k", 
         authDomain: "centro-comercial-1ea64.firebaseapp.com", 
         projectId: "centro-comercial-1ea64", 
         storageBucket: "centro-comercial-1ea64.appspot.com", 
         messagingSenderId: "667808330264", 
         appId: "1:667808330264:web:9718955b58aba4359b096d", 
         measurementId: "G-3ZPG0Q8FL6"
        };

        let db, auth, userId, poiCollectionRef;
        let map;
        let poiMarkers = {}; 
        let allPoisData = []; 
        let poiDataMap = new Map(); 

        // --- Estado Global ---
        let modelsToPlace = [];
        let isPlacingModel = false;
        let currentPlacingModel = {}; 
        let isEditingLocation = false; 
        let currentEditingPoiId = null; 
        let currentEditingMarker = null; 
        let firebaseReady = false; 

        // Variables AR
        let arScene = null;
        let lastKnownGps = { latitude: 0, longitude: 0, accuracy: 9999, heading: 0 };
        let arFineScaleMultiplier = 1.0;
        let progressBar, progressBarContainer, loadingAssetStatus;
        let totalARAssetsToLoad = 0; 
        let loadedARAssetsCount = 0; 
        const ASSETS_LOAD_STEP = 50; 
        let arGuide, guideName, guideDistance, guideBearing;
        let arScaleSlider, arScaleValueDisplay;


        // --- Referencias a Elementos DOM ---
        let pages = {};
        let messageBox, permissionModal, arLoadingScreen, loadingStatusText, versionDisplay; 
        let listContainer, loadingPois, ecopiensaSelectionList, loadingModelsPlaceholder, selectVideoCheckbox, clearSelectionBtn;
        let placementPanel, modelsToPlaceList, placementFormContainer, placingModelName, cancelPlacementBtn, savePlacementBtn, backToSelectionBtn;
        let mapZoomSlider, jumptoBtn, placePoiTypeSelect, modelFieldsDiv, videoFieldsDiv, placeModelUrlInput, placeVideoUrlInput, placeNameInput;
        let placedPoisPanel, placedPoisList, editLocationPanel, editingPoiNameEl, saveEditLocationBtn, cancelEditLocationBtn;
        let summaryPoiList, loadingSummaryPois;
        let gotoMapButton; 
        let mapCenterCoordsEl; 
        let placementPreviewImageEl; 
        let loginPage, googleLoginBtn, logoutBtn, userInfo, userEmail;
        let togglePoisBtn;


        // --- Funciones Matemáticas ---
        function toRad(degrees) { return degrees * (Math.PI / 180); }
        function toDeg(radians) { return radians * (180 / Math.PI); }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distancia en metros
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const λ1 = toRad(lon1);
            const λ2 = toRad(lon2);
            
            const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) -
                    Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);

            let bearing = toDeg(Math.atan2(y, x));
            return (bearing + 360) % 360; // De 0 a 360 grados
        }
        
        function getDirectionArrow(bearingDiff) {
            if (bearingDiff >= -20 && bearingDiff <= 20) return "↑ (Recto)";
            if (bearingDiff > 20 && bearingDiff <= 70) return "↗ (Semi-derecha)";
            if (bearingDiff > 70 && bearingDiff <= 110) return "→ (Derecha)";
            if (bearingDiff > 110 && bearingDiff <= 160) return "↘ (Atrás-derecha)";
            if (bearingDiff > 160 || bearingDiff < -160) return "↓ (Atrás)";
            if (bearingDiff < -110 && bearingDiff >= -160) return "↙ (Atrás-izquierda)";
            if (bearingDiff < -70 && bearingDiff >= -110) return "← (Izquierda)";
            if (bearingDiff < -20 && bearingDiff >= -70) return "↖ (Semi-izquierda)";
            return "--";
        }
        
        function showMessage(msg, duration = 3000) {
            if (!messageBox) { 
                console.warn("Attempted to show message before messageBox was assigned:", msg); 
                return; 
            }
            messageBox.textContent = msg;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        // --- Carga dinámica de la barra de progreso ---
        function updateARProgressBar(step, assetName = '') {
            let progress;
            let statusText = '';
            
            if (step === 'start') {
                progress = 5;
                statusText = 'Iniciando verificación de permisos...';
                loadedARAssetsCount = 0;
            } else if (step === 'permissions') {
                progress = 20;
                statusText = 'Permisos de cámara y ubicación concedidos.';
            } else if (step === 'load_assets_start') {
                progress = 25;
                statusText = `Cargando ${totalARAssetsToLoad} recursos AR...`;
            } else if (step === 'asset_loaded') {
                loadedARAssetsCount++;
                const assetProgress = (loadedARAssetsCount / totalARAssetsToLoad) * ASSETS_LOAD_STEP;
                progress = 25 + assetProgress;
                statusText = `Cargando recursos AR (${loadedARAssetsCount}/${totalARAssetsToLoad})...`;
                loadingAssetStatus.textContent = `Descargando: ${assetName}`;
            } else if (step === 'scene_setup') {
                progress = 80;
                statusText = 'Configurando escena de Realidad Aumentada...';
                loadingAssetStatus.textContent = 'Enlazando recursos...';
            } else if (step === 'gps_active') {
                progress = 95;
                statusText = 'Esperando precisión de ubicación...';
                loadingAssetStatus.textContent = 'GPS Activo';
            } else if (step === 'complete') {
                progress = 100;
                statusText = '¡Realidad Aumentada lista!';
                loadingAssetStatus.textContent = '¡Listo!';
            }

            progressBar.style.width = `${progress}%`;
            loadingStatusText.textContent = statusText;
            console.log(`AR Load: Step ${step}, Progress ${progress.toFixed(2)}%, Assets ${loadedARAssetsCount}/${totalARAssetsToLoad}`);
        }
        
        function navigateTo(pageName) {
            if (Object.keys(pages).length === 0) { 
                console.error("Attempted to navigate before pages object was populated."); 
                return; 
            }
            
            if (pageName !== 'login' && !firebaseReady) {
                 if ((pageName === 'map' || pageName === 'summary' || pageName === 'ar')) {
                    showMessage("Aguarde un momento, conectando con la base de datos...", 3000);
                    console.warn(`Attempt to navigate to ${pageName} before Firebase is ready.`);
                 }
                return; 
            }

            console.log(`Navigating to: ${pageName}`);
            Object.values(pages).forEach(p => p.classList.remove('active'));
            
            if(pages[pageName]) {
                pages[pageName].classList.add('active'); 
            } else { 
                console.error(`Page not found: ${pageName}. Falling back to login.`); 
                if (pages.login) pages.login.classList.add('active'); 
                 return;
            }

            // Lógica específica de la página
            if (pageName === 'map') { 
                stopAR(); 
                setTimeout(initMap, 100); 
            } else if (pageName === 'summary') { 
                stopAR(); 
                 stopMap(); 
                 populateSummaryPage();
            } else if (pageName === 'ar') { 
                stopMap(); 
                startARFlow(); 
            } else if (pageName === 'admin') { 
                stopAR(); 
                stopMap(); 
                initializeModelSelection(); 
            } else if (pageName === 'login') {
                stopAR();
                stopMap();
            }
        }

        function stopMap() {
            if (map) { 
                map.off('move', updateCenterCoordsDisplay); 
                if (placedPoisList) {
                   placedPoisList.removeEventListener('click', handleDeletePoiOnMap);
                } 
                map.remove(); 
                 map = null; 
                Object.values(poiMarkers).forEach(marker => marker.remove()); 
                poiMarkers = {}; 
                 console.log("Map stopped and removed.");
            } 
            isPlacingModel = false; 
            isEditingLocation = false; 
            currentEditingPoiId = null; 
            currentEditingMarker = null;
            if (placedPoisPanel) placedPoisPanel.classList.remove('minimized');
            if (togglePoisBtn) togglePoisBtn.textContent = 'Ocultar POIs';
        }

        // --- Funciones de Persistencia ---
        function saveSelectionToLocalStorage() {
            try {
                localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(modelsToPlace));
                console.log("Selection saved to localStorage:", modelsToPlace);
            } catch (e) {
                console.error("Error saving selection to localStorage:", e);
                showMessage("Error guardando selección localmente.", 4000);
            }
        }

        function loadSelectionFromLocalStorage() {
            const savedSelection = localStorage.getItem(LOCALSTORAGE_KEY);
            if (savedSelection) {
                try {
                    modelsToPlace = JSON.parse(savedSelection);
                    console.log("Loaded model selection from localStorage:", modelsToPlace);
                } catch (e) {
                    console.error("Error parsing saved selection:", e);
                    localStorage.removeItem(LOCALSTORAGE_KEY);
                    modelsToPlace = [];
                }
            } else {
                modelsToPlace = [];
                console.log("No selection found in localStorage, initializing empty.");
            }
        }

        function clearSavedSelection() { 
             localStorage.removeItem(LOCALSTORAGE_KEY); 
             modelsToPlace = []; 
             initializeModelSelection();
             showMessage("Selección guardada limpiada.", 2000); 
             console.log("Cleared saved selection.");
        }

        // --- Lógica de Firebase ---
        async function initializeFirebase() { 
            console.log("Initializing Firebase..."); 
            if (loadingPois) loadingPois.textContent = "Inicializando conexión Firebase...";
            if (gotoMapButton) gotoMapButton.disabled = true; 

            if (!firebaseConfig || !firebaseConfig.projectId) { 
                const errorMsg = "Error fatal: Configuración de Firebase inválida o incompleta."; 
                console.error(errorMsg, firebaseConfig); 
                if(loadingPois) loadingPois.textContent = errorMsg; 
                showMessage(errorMsg, 10000); 
                 return; 
            }
            
            try { 
                const app = initializeApp(firebaseConfig); 
                db = getFirestore(app); 
                auth = getAuth(app); 
                console.log("Firestore and Auth services obtained.");
                setLogLevel('Debug'); 
                
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed callback triggered.");
                    if (user) {
                        userId = user.uid;
                        console.log('Firebase User Authenticated. UID:', userId);
                        if (userEmail) userEmail.textContent = user.email || userId;
                        if (userInfo) userInfo.classList.remove('hidden');
                        if (logoutBtn) logoutBtn.classList.remove('hidden');
                        
                        const identifier = (typeof __app_id !== 'undefined' && appId !== 'default-app-id') 
                            ? appId
                            : firebaseConfig.projectId;
                            
                        const collectionPath = `/artifacts/${identifier}/users/${userId}/pois`;
                        poiCollectionRef = collection(db, collectionPath);
                        console.log('POI Collection configured to user-specific path:', collectionPath);
                        
                        firebaseReady = true; 
                        if (gotoMapButton) {
                            gotoMapButton.disabled = false; 
                        }
                        if (loadingPois && (loadingPois.textContent.startsWith("Conectando") || loadingPois.textContent.startsWith("Inicializando"))) { 
                             loadingPois.textContent = "Conexión exitosa. Cargando POIs..."; 
                         }
                        showMessage(`Bienvenido, ${user.displayName || user.email}`, 2000);
                        
                        loadAndListenPois(); 
                        
                        if (pages.login?.classList.contains('active')) {
                            navigateTo('admin');
                        }

                     } else {
                        userId = null;
                        poiCollectionRef = null;
                        firebaseReady = false; 
                         console.log('Firebase User signed out.');
                        if (gotoMapButton) {
                           gotoMapButton.disabled = true; 
                        }
                        if (userInfo) userInfo.classList.add('hidden');
                        if (logoutBtn) logoutBtn.classList.add('hidden');
                        if (userEmail) userEmail.textContent = "";

                        if (listContainer) listContainer.innerHTML = '<p class="text-gray-500 font-semibold">Inicia sesión para ver tus datos.</p>';
                        allPoisData = []; 
                        poiDataMap.clear(); 
                        
                        navigateTo('login');
                    }
                });

            } catch (initError) { 
                console.error("Firebase Initialization Error:", initError);
                firebaseReady = false; 
                 if (gotoMapButton) gotoMapButton.disabled = true; 
                const errorMsg = `Error fatal al inicializar Firebase: ${initError.message}.`;
                if(loadingPois) loadingPois.textContent = errorMsg;
                showMessage(errorMsg, 10000);
            }
        }
        
        async function handleGoogleLogin() {
             const provider = new GoogleAuthProvider();
            if (!auth) {
                 console.error("Auth no inicializado.");
                 showMessage("Error: Servicio de autenticación no listo.", 3000);
                 return;
            }
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error Google Login:", error);
                showMessage("Error al iniciar sesión: " + error.message, 5000);
            }
        }

        async function handleLogout() {
             if (!auth) {
                 console.error("Auth no inicializado.");
                 return;
             }
            try {
                await signOut(auth);
                showMessage("Sesión cerrada.", 2000);
            } catch (error) {
                console.error("Error Logout:", error);
                showMessage("Error al cerrar sesión.", 3000);
            }
        }


        function displayAppVersion() {
             if (versionDisplay) {
                 versionDisplay.textContent = `v${APP_VERSION}`; 
             }
        }

        function initializeModelSelection() {
             if (!ecopiensaSelectionList || !loadingModelsPlaceholder || !selectVideoCheckbox) { 
                 console.error("Required elements for model selection not found."); 
                 return; 
             }

            loadingModelsPlaceholder.style.display = 'none'; 
            
            ecopiensaSelectionList.innerHTML = ''; 
            ECOPIENSA_MODELS.forEach(model => {
                const isSelected = modelsToPlace.some(m => !m.isCustomVideo && m.url === model.modelUrl);
                 createCheckbox(model.name, model.modelUrl, isSelected, false, model.imageUrl); 
            });
            
            selectVideoCheckbox.removeEventListener('change', handleVideoCheckboxChange);
            selectVideoCheckbox.addEventListener('change', handleVideoCheckboxChange);
            selectVideoCheckbox.checked = modelsToPlace.some(m => m.isCustomVideo);
        }
        
        function createCheckbox(name, url, isChecked, isVideoPlaceholder = false, imageUrl = '') {
             if (!ecopiensaSelectionList) return; 

             const label = document.createElement('label');
             label.className = 'flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer';
             const input = document.createElement('input');
             input.type = 'checkbox';
             input.className = 'model-select-cb h-5 w-5 text-blue-600';
             input.dataset.name = name;
             input.dataset.url = url; 
             input.checked = isChecked; 
             input.dataset.imageUrl = imageUrl; 
             if (isVideoPlaceholder) {
                 input.dataset.isCustomVideo = "true";
             } 
             
             input.removeEventListener('change', handleCheckboxChange); 
             input.addEventListener('change', handleCheckboxChange); 

             const span = document.createElement('span');
             span.textContent = name;
             
             label.appendChild(input);
             label.appendChild(span);
             ecopiensaSelectionList.appendChild(label);
        }

         function handleVideoCheckboxChange(e) {
             const placeholderExists = modelsToPlace.some(m => m.isCustomVideo);
             if (e.target.checked) {
                 if (!placeholderExists) {
                     modelsToPlace.push({...CUSTOM_VIDEO_PLACEHOLDER});
                 }
             } else {
                 if (placeholderExists) {
                     modelsToPlace = modelsToPlace.filter(m => !m.isCustomVideo);
                 }
             }
             saveSelectionToLocalStorage();
         }

        function handleCheckboxChange(e) {
             const itemData = { 
                 name: e.target.dataset.name, 
                 url: e.target.dataset.url, 
                 isCustomVideo: e.target.dataset.isCustomVideo === "true",
                 imageUrl: e.target.dataset.imageUrl || '' 
             };
             const itemExists = modelsToPlace.some(m => m.url === itemData.url); 
             
             if (e.target.checked) {
                 if (!itemExists) {
                     modelsToPlace.push(itemData);
                 }
             } else {
                 if (itemExists) {
                     modelsToPlace = modelsToPlace.filter(m => m.url !== itemData.url);
                 }
             }
             saveSelectionToLocalStorage();
         }

        function loadAndListenPois() {
             if (!poiCollectionRef) { 
                 if (loadingPois) loadingPois.textContent = "Esperando inicio de sesión..."; 
                 return; 
             }
             if (!listContainer || !loadingPois) { 
                  console.error("loadAndListenPois called but listContainer or loadingPois element not found."); 
                 return; 
             }
             
             if (loadingPois) {
                 loadingPois.textContent = "Cargando puntos guardados..."; 
                 loadingPois.style.display = 'block'; 
             }
             const q = query(poiCollectionRef);
             
             onSnapshot(q, (querySnapshot) => {
                 console.log("Firestore snapshot received."); 
                 if (!listContainer || !loadingPois) return; 
                 
                 loadingPois.style.display = 'none'; 
                 allPoisData = []; 
                 poiDataMap.clear(); 
                 if (pages.admin?.classList.contains('active')) {
                     listContainer.innerHTML = ''; 
                 }

                 if (querySnapshot.empty) {
                     if (pages.admin?.classList.contains('active')) {
                        listContainer.innerHTML = '<p class="text-gray-500">No hay contenido guardado en Firebase.</p>';
                     } 
                     if (map && pages.map?.classList.contains('active')) { 
                          updateMapMarkersAndPlacedList(); 
                      }
                     return;
                 }

                 querySnapshot.forEach((doc) => {
                     const poi = { id: doc.id, ...doc.data() }; 
                     allPoisData.push(poi); 
                     poiDataMap.set(poi.id, poi); 

                     if (pages.admin?.classList.contains('active')) {
                         const poiElement = document.createElement('div');
                         poiElement.className = 'poi-item p-4 border border-gray-200 rounded-lg shadow-sm grid grid-cols-2 md:grid-cols-4 gap-4 items-center';
                         let typeLabel = poi.poiType === 'video' ? 'Video' : 'Modelo 3D';
                         let urlToShow = poi.poiType === 'video' ? (poi.videoUrl || 'N/A') : (poi.modelUrl || 'N/A'); 
                         if (urlToShow.length > 30) urlToShow = urlToShow.substring(0, 27) + '...'; 

                         poiElement.innerHTML = `
                             <div>
                                 <strong class="block text-sm text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                                 <span class="block text-xs ${poi.poiType === 'video' ? 'text-purple-600' : 'text-blue-600'}">${typeLabel}</span>
                                 <span class="block text-xs text-gray-500" title="${poi.poiType === 'video' ? poi.videoUrl : poi.modelUrl}">URL: ${urlToShow}</span>
                             </div>
                             <div class="text-sm">
                                 <span class="block">Lat: ${poi.lat?.toFixed(6) || 'N/A'}</span>
                                 <span class="block">Lon: ${poi.lon?.toFixed(6) || 'N/A'}</span>
                             </div>
                             <div class="text-sm">
                                 <span class="block">Inicia: ${poi.startDate || 'N/A'}</span>
                                 <span class="block">Termina: ${poi.endDate || 'N/A'}</span>
                             </div>
                             <div class="text-right">
                                 <button data-id="${poi.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300">
                                     Eliminar
                                 </button>
                             </div>
                         `;
                         listContainer.appendChild(poiElement);
                     }
                 });
                 
                 console.log(`Local cache 'allPoisData' updated with ${allPoisData.length} POIs.`); 
                 
                 if (map && pages.map?.classList.contains('active')) {
                     updateMapMarkersAndPlacedList();
                     populatePlacementPanel(); 
                     if (togglePoisBtn) togglePoisBtn.style.display = 'block';
                 }
                 
                 if (pages.summary?.classList.contains('active')) {
                     populateSummaryPage();
                 }

             }, (error) => {
                 console.error("Error listening to POIs (Firestore):", error);
                 if (loadingPois) loadingPois.style.display = 'none'; 
                 if (listContainer) listContainer.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar datos de Firestore: ${error.message}.</p>`;
                 allPoisData = []; 
                 poiDataMap.clear();
                 showMessage("Error al actualizar la lista de contenido.", 5000);
             });
        }
        
        function initMap() {
             console.log("Initializing Map..."); 
             if (!firebaseReady || !poiCollectionRef) { 
                 showMessage("La base de datos no está lista. Por favor espere...", 3000);
                navigateTo('login');
                return; 
             }
             if (map) { 
                setTimeout(() => { if (map) map.invalidateSize(); }, 100); 
                 populatePlacementPanel(); 
                 updateMapMarkersAndPlacedList(); 
                 return; 
             }

            const mapContainer = document.getElementById('map-canvas');
             if (!mapContainer) { console.error("Map container element not found."); return; }
             const defaultCenter = [4.0835, -76.1915]; 
            map = L.map(mapContainer, { zoomControl: false, preferCanvas: true }).setView(defaultCenter, 15);

             L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 22, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: 'Imagery &copy;2025 Google' }).addTo(map);

             updateMapMarkersAndPlacedList();
             populatePlacementPanel();
             cancelPlacement();
             cancelEditLocation();

             map.off('move', updateCenterCoordsDisplay); 
             map.on('move', updateCenterCoordsDisplay); 
             updateCenterCoordsDisplay(); 

             if (mapZoomSlider) { 
                 mapZoomSlider.value = map.getZoom();
                 mapZoomSlider.removeEventListener('input', handleZoomSlider); 
                 mapZoomSlider.addEventListener('input', handleZoomSlider);
             }
             map.off('zoomend', handleMapZoomEnd); 
             map.on('zoomend', handleMapZoomEnd);
             
             if (jumptoBtn) { 
                 jumptoBtn.removeEventListener('click', jumpToCoords); 
                 jumptoBtn.addEventListener('click', jumpToCoords); 
             }

             if (placePoiTypeSelect) { 
                 placePoiTypeSelect.removeEventListener('change', handlePoiTypeChange);
                 placePoiTypeSelect.addEventListener('change', handlePoiTypeChange);
                 handlePoiTypeChange(); 
              }
             
             if (placedPoisList) {
               placedPoisList.removeEventListener('click', handleDeletePoiOnMap);
                placedPoisList.addEventListener('click', handleDeletePoiOnMap);
            }
            
            if (togglePoisBtn) {
                 togglePoisBtn.removeEventListener('click', handleTogglePoisPanel);
                 togglePoisBtn.addEventListener('click', handleTogglePoisPanel);
                 togglePoisBtn.style.display = 'block';
            }

             setTimeout(() => { if (map) map.invalidateSize(); }, 200); 
             console.log("Map initialization complete.");
        }

        function handleTogglePoisPanel() {
             if (placedPoisPanel && togglePoisBtn) {
                 const isMinimized = placedPoisPanel.classList.toggle('minimized');
                 togglePoisBtn.textContent = isMinimized ? 'Mostrar POIs' : 'Ocultar POIs';
             }
        }
        
         function updateCenterCoordsDisplay() {
             if (map && mapCenterCoordsEl) {
                 const center = map.getCenter();
                 mapCenterCoordsEl.innerHTML = `
                     <span>Lat: ${center.lat.toFixed(6)}</span>
                     <span>Lon: ${center.lng.toFixed(6)}</span>
                 `;
             }
         }

        function updateMapMarkersAndPlacedList() {
             if (!map || !placedPoisList) {
                 console.warn("Cannot update map markers/list: Map or list element not ready.");
                 return;
             }
             
             Object.values(poiMarkers).forEach(marker => { 
                 if (map.hasLayer(marker)) map.removeLayer(marker);
            });
             poiMarkers = {}; 
             placedPoisList.innerHTML = ''; 
             
             let hasPois = false;
             allPoisData.forEach(poi => { 
                 hasPois = true;
                 if (typeof poi.lat === 'number' && typeof poi.lon === 'number') { 
                     let iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png'; 
                      if (poi.poiType === 'video') {
                        iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png'; 
                      } 
                     
                     let popupImageUrl = '';
                     if (poi.poiType === 'model' && poi.modelUrl) {
                         const ecoModel = ECOPIENSA_MODELS.find(m => m.modelUrl === poi.modelUrl);
                         if (ecoModel) popupImageUrl = ecoModel.imageUrl;
                     } else if (poi.poiType === 'video') {
                         popupImageUrl = CUSTOM_VIDEO_PLACEHOLDER.imageUrl; 
                      }

                     let popupContent = `<b>${poi.name || 'No Name'}</b> (${poi.poiType || 'model'})`;
                     if (popupImageUrl) {
                         popupContent += `<br><img src="${popupImageUrl}" alt="Preview" class="popup-image" onerror="this.style.display='none'">`;
                     }

                     const marker = L.marker([poi.lat, poi.lon], { 
                          icon: L.icon({
                              iconUrl: iconUrl,
                              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                              iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                         })
                     })
                         .addTo(map)
                         .bindPopup(popupContent); 
                     poiMarkers[poi.id] = marker; 
                 }
                 
                 const listItem = document.createElement('div');
                 listItem.className = 'placed-poi-item p-2 border-b flex justify-between items-center';
                 listItem.innerHTML = `
                     <span class="text-sm font-medium">${poi.name || 'No Name'}</span>
                     <div>
                         <button data-id="${poi.id}" class="edit-location-btn bg-amber-500 hover:bg-amber-600 text-white text-xs px-2 py-1 rounded">
                             Edit Loc.
                         </button>
                         <button data-id="${poi.id}" class="delete-btn-map"> 
                             Del
                         </button>
                     </div>
                 `;
                 const editBtn = listItem.querySelector('.edit-location-btn');
                 editBtn.removeEventListener('click', handleEditLocationClick); 
                 editBtn.addEventListener('click', handleEditLocationClick);
                 placedPoisList.appendChild(listItem);
             });
             
             if (!hasPois) { 
                 placedPoisList.innerHTML = '<p class="text-sm text-gray-500">No content saved on map yet.</p>';
             }
        }

        function handlePoiTypeChange() {
             if (!placePoiTypeSelect || !modelFieldsDiv || !videoFieldsDiv) return;
             const selectedType = placePoiTypeSelect.value;
             const isVideo = selectedType === 'video';
             
             modelFieldsDiv.classList.toggle('hidden', isVideo);
             videoFieldsDiv.classList.toggle('hidden', !isVideo);
             
             if(placeModelUrlInput) placeModelUrlInput.disabled = isVideo;
             if(placeVideoUrlInput) placeVideoUrlInput.disabled = !isVideo;

             const scaleLabel = document.querySelector('label[for="place-scale"]');
             if (scaleLabel) { scaleLabel.textContent = isVideo ? 'Ancho del Video (metros)' : 'Escala del Modelo'; }
        }

         function handleEditLocationClick(e) {
             const poiId = e.target?.dataset?.id; 
             if (poiId) { startEditLocation(poiId); } 
        }

        function startEditLocation(poiId) {
             if (isPlacingModel) cancelPlacement(); 
             const poiData = poiDataMap.get(poiId); 
             const marker = poiMarkers[poiId];
             if (!poiData || !marker || !map) { 
                 showMessage("Error: No se pudieron encontrar datos o marcador.", 4000); 
                 return; 
             }

             isEditingLocation = true;
             currentEditingPoiId = poiId;
             currentEditingMarker = marker; 

             if (editingPoiNameEl) editingPoiNameEl.textContent = `Moviendo: ${poiData.name || 'No Name'}`;
             if (placementPanel) placementPanel.classList.add('hidden'); 
             if (placedPoisPanel) placedPoisPanel.classList.add('hidden'); 
             if (editLocationPanel) editLocationPanel.classList.remove('hidden'); 

             map.setView(marker.getLatLng(), 19); 
             showMessage("Modo Edición: Mueve el mapa y guarda la nueva ubicación.", 4000);
        }

        function cancelEditLocation() {
             isEditingLocation = false;
             currentEditingPoiId = null;
             currentEditingMarker = null;
             if (placementPanel) placementPanel.classList.remove('hidden'); 
             if (placedPoisPanel) placedPoisPanel.classList.remove('hidden'); 
             if (editLocationPanel) editLocationPanel.classList.add('hidden'); 
        }
        
        async function handleSaveEditLocation() {
             if (!isEditingLocation || !map || !poiCollectionRef || !currentEditingPoiId || !saveEditLocationBtn) { return; }

             const newLatLng = map.getCenter(); 
             showMessage('Actualizando ubicación...', 2000);
             saveEditLocationBtn.disabled = true;
             saveEditLocationBtn.textContent = 'Guardando...';

             try {
                 const docRef = doc(db, poiCollectionRef.path, currentEditingPoiId);
                 await updateDoc(docRef, { lat: newLatLng.lat, lon: newLatLng.lng });
                 showMessage('Ubicación actualizada!', 3000);
                 cancelEditLocation(); 
             } catch (error) {
                 console.error("Error updating location:", error);
                 showMessage("Error guardando nueva ubicación.", 5000);
             } finally { 
                 if (saveEditLocationBtn) { 
                     saveEditLocationBtn.disabled = false; 
                     saveEditLocationBtn.textContent = 'Guardar Nueva Ubicación (en la Cruz)'; 
                 }
             }
        }

        function handleZoomSlider(e) { if (map) map.setZoom(parseFloat(e.target.value)); }
        function handleMapZoomEnd() { if (map && mapZoomSlider) mapZoomSlider.value = map.getZoom(); }
        function jumpToCoords() { 
             const latInput = document.getElementById('jumpto-lat');
             const lonInput = document.getElementById('jumpto-lon');
             if (!latInput || !lonInput || !map) return; 
             const lat = parseFloat(latInput.value);
             const lon = parseFloat(lonInput.value);
             if (isNaN(lat) || isNaN(lon)) { 
                 showMessage("Ingresa latitud y longitud válidas.", 3000); 
                 return; 
             }
             map.setView([lat, lon], 18); 
         }

        function populatePlacementPanel() {
             if (!firebaseReady || !modelsToPlaceList) { 
                 if (modelsToPlaceList) modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">Esperando conexión...</p>';
                 return; 
             }
             
             modelsToPlaceList.innerHTML = ''; 
             
             if (modelsToPlace.length === 0) { 
                 modelsToPlaceList.innerHTML = '<p class="text-sm text-gray-500">No hay contenido seleccionado. Vuelve al Panel.</p>';
                 return; 
             }

             modelsToPlace.forEach((item) => {
                 const button = document.createElement('button'); 
                 button.className = 'place-btn control-button bg-blue-500 hover:bg-blue-600 w-full text-left'; 
                 button.textContent = `Posicionar ${item.name}`; 
                 button.dataset.name = item.name; 
                 button.dataset.url = item.url; 
                 button.dataset.imageUrl = item.imageUrl || ''; 
                 if (item.isCustomVideo) { button.dataset.isCustomVideo = "true"; }
                 
                 button.removeEventListener('click', handlePlaceButtonClick); 
                 button.addEventListener('click', handlePlaceButtonClick); 
                 
                 modelsToPlaceList.appendChild(button); 
             });
        }
        
        function handlePlaceButtonClick(e) {
            const targetUrl = e.target.dataset.url;
            const itemData = {
                name: e.target.dataset.name,
                url: targetUrl,
                imageUrl: e.target.dataset.imageUrl,
                isCustomVideo: e.target.dataset.isCustomVideo === "true"
            };
            const itemExistsInState = modelsToPlace.some(m => m.url === targetUrl);
            if (itemExistsInState) {
                startPlacement(itemData); 
            } else { 
                showMessage("Error: Este item ya no está seleccionado.", 4000);
                populatePlacementPanel(); // Refresh list
            }
        }

        function startPlacement(itemData) {
             const isCustomVideo = itemData.isCustomVideo === true;

            isPlacingModel = true;
            currentPlacingModel = { ...itemData }; 

             if (placingModelName) placingModelName.textContent = `Posicionando: ${currentPlacingModel.name}`;
             if (placementPreviewImageEl) {
                 if (itemData.imageUrl) {
                     placementPreviewImageEl.src = itemData.imageUrl;
                     placementPreviewImageEl.style.display = 'block';
                     placementPreviewImageEl.onerror = () => {
                          placementPreviewImageEl.style.display = 'none';
                          placementPreviewImageEl.onerror = null;
                      };
                 } else {
                      placementPreviewImageEl.style.display = 'none';
                 }
              }

             if (placePoiTypeSelect) { 
                 placePoiTypeSelect.value = isCustomVideo ? 'video' : 'model';
                 handlePoiTypeChange(); 
              }
             if (placeNameInput) placeNameInput.value = currentPlacingModel.name;
             if (placeModelUrlInput) placeModelUrlInput.value = isCustomVideo ? '' : currentPlacingModel.url;
             if (placeVideoUrlInput) placeVideoUrlInput.value = isCustomVideo ? '' : '';
                           
            document.getElementById('place-sound-url').value = '';
            document.getElementById('place-scale').value = '1.0';
            document.getElementById('place-ground-height').value = '0.0';

            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0];
            document.getElementById('place-start-date').value = today;
            document.getElementById('place-end-date').value = nextMonth;

             if (modelsToPlaceList) modelsToPlaceList.classList.add('hidden');
             if (placementFormContainer) placementFormContainer.classList.remove('hidden');
                          
             showMessage(`Mueve el mapa y presiona 'Guardar Ubicación'`);
        }

        function cancelPlacement() {
             isPlacingModel = false;
             currentPlacingModel = {};
             if (placementFormContainer) placementFormContainer.classList.add('hidden'); 
             if (modelsToPlaceList) modelsToPlaceList.classList.remove('hidden'); 
             if (placementPreviewImageEl) placementPreviewImageEl.style.display = 'none'; 
             
             if (savePlacementBtn) {
                 savePlacementBtn.disabled = false;
                 savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)';
             }
             populatePlacementPanel(); 
        }
        
        async function handleSavePlacement() {
             if (!isPlacingModel || !map || !poiCollectionRef || !savePlacementBtn || !currentPlacingModel.url) { 
                if (savePlacementBtn) { 
                     savePlacementBtn.disabled = false;
                     savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)';
                }
                return; 
             }

             const latlng = map.getCenter(); 
             showMessage('Guardando...', 2000);
             savePlacementBtn.disabled = true;
             savePlacementBtn.textContent = 'Guardando...';

             let newPoi = null; 
             try {
                const poiType = placePoiTypeSelect.value;
                let modelUrl = '';
                let videoUrl = '';
                let name = placeNameInput.value.trim();

                if (!name) throw new Error("El nombre descriptivo es obligatorio.");

                if (poiType === 'video') { 
                    videoUrl = placeVideoUrlInput.value.trim();
                    if (!videoUrl) throw new Error("La URL del video es obligatoria para el tipo Video.");
                    modelUrl = ''; 
                 } else { 
                    modelUrl = currentPlacingModel.url; 
                     videoUrl = ''; 
                 }

                newPoi = { 
                     name: name, 
                     poiType: poiType, 
                     modelUrl: modelUrl, 
                     videoUrl: videoUrl, 
                     soundUrl: document.getElementById('place-sound-url')?.value.trim() || "", 
                     lat: latlng.lat, 
                     lon: latlng.lng,
                    scale: parseFloat(document.getElementById('place-scale')?.value || "1.0"), 
                     groundHeight: parseFloat(document.getElementById('place-ground-height')?.value || "0.0"), 
                     startDate: document.getElementById('place-start-date')?.value || "", 
                     endDate: document.getElementById('place-end-date')?.value || "" 
                 };

                 if (isNaN(newPoi.scale) || isNaN(newPoi.groundHeight)) throw new Error("La Escala y Altura deben ser números válidos."); 
                 if (newPoi.scale <= 0) throw new Error("La Escala debe ser positiva."); 
                 if (!newPoi.startDate || !newPoi.endDate) throw new Error("Las fechas de Inicio y Fin son obligatorias.");
                
                const startDate = new Date(newPoi.startDate);
                const endDate = new Date(newPoi.endDate);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) throw new Error("Formato de fecha inválido.");
                if (endDate < startDate) throw new Error("La fecha de Fin no puede ser anterior a la de Inicio.");

                const docRef = await addDoc(poiCollectionRef, newPoi); 
                 console.log("POI saved with ID:", docRef.id);
                                 
                showMessage(`'${newPoi.name}' guardado exitosamente!`, 3000); 
                cancelPlacement();

            } catch (error) { 
                 console.error("Error saving POI: ", error); 
                 showMessage("Error al guardar: " + error.message, 5000); 
                 if (savePlacementBtn) { 
                     savePlacementBtn.disabled = false; 
                     savePlacementBtn.textContent = 'Guardar Ubicación (en la Cruz)'; 
                 }
            }
        }

        async function handleDeletePoiOnMap(e) {
             if (e.target && e.target.classList.contains('delete-btn-map')) { 
                  const docId = e.target.getAttribute('data-id');
                 const button = e.target;
                 if (!docId || button.disabled) return;

                 if (!button.classList.contains('confirm')) {
                     button.textContent = 'Sure?';
                     button.classList.add('confirm');
                     setTimeout(() => {
                         const currentButton = placedPoisList?.querySelector(`.delete-btn-map[data-id="${docId}"]`);
                         if (currentButton && currentButton.classList.contains('confirm')) {
                              currentButton.textContent = 'Del';
                            currentButton.classList.remove('confirm');
                        }
                    }, 3000);
                    return;
                 }

                 if (!firebaseReady || !poiCollectionRef) { 
                      showMessage("Error: La base de datos no está lista para eliminar.", 4000);
                     button.textContent = 'Del'; 
                      button.classList.remove('confirm');
                    return; 
                 }
                                  
                try {
                    button.disabled = true;
                    button.textContent = '...'; 
                    const docRef = doc(db, poiCollectionRef.path, docId);
                    await deleteDoc(docRef);
                    showMessage('Punto de interés eliminado.', 3000);
                } catch (error) {
                    console.error("Error deleting document from map page: ", error);
                    showMessage("No se pudo eliminar el documento.", 5000);
                    const currentButton = placedPoisList?.querySelector(`.delete-btn-map[data-id="${docId}"]`);
                    if (currentButton) { 
                         currentButton.disabled = false;
                         currentButton.textContent = 'Del';
                        currentButton.classList.remove('confirm');
                    }
                }
            }
        }
        
        function populateSummaryPage() {
             if (!summaryPoiList || !loadingSummaryPois) {
                console.error("Summary page elements not found.");
                return;
            }
            loadingSummaryPois.style.display = 'block';
            summaryPoiList.innerHTML = ''; 

            if (!firebaseReady) { 
                 loadingSummaryPois.textContent = "Error: No conectado a Firebase.";
                return;
            }
            if (allPoisData.length === 0) {
                loadingSummaryPois.style.display = 'none';
                summaryPoiList.innerHTML = '<p class="text-gray-500">No hay contenido configurado para mostrar en AR.</p>';
                return;
            }

            loadingSummaryPois.style.display = 'none';
            const now = new Date();
            let activePois = 0;

            allPoisData.forEach(poi => {
                const isModel = poi.poiType === 'model';
                const startDate = poi.startDate ? new Date(poi.startDate + "T00:00:00") : null;
                const endDate = poi.endDate ? new Date(poi.endDate + "T23:59:59") : null;

                let isActive = false;
                if (startDate && endDate) {
                    isActive = now >= startDate && now <= endDate;
                } else if (startDate) {
                    isActive = now >= startDate;
                } else {
                    isActive = true;
                }

                if (isActive) activePois++;

                const poiElement = document.createElement('div');
                poiElement.className = `p-4 border rounded-lg shadow-sm ${isActive ? 'bg-green-50' : 'bg-gray-50 opacity-60'}`;

                let imageUrl = '';
                if(isModel) {
                    const ecoModel = ECOPIENSA_MODELS.find(m => m.modelUrl === poi.modelUrl);
                    if (ecoModel) imageUrl = ecoModel.imageUrl;
                } else {
                    imageUrl = CUSTOM_VIDEO_PLACEHOLDER.imageUrl;
                }

                poiElement.innerHTML = `
                    <div class="flex items-start space-x-4">
                        ${imageUrl ? `<img src="${imageUrl}" alt="Preview" class="w-16 h-16 rounded object-contain border bg-white" onerror="this.style.display='none'">` : '<div class="w-16 h-16 rounded bg-gray-200 flex items-center justify-center text-xs text-gray-500">No Img</div>'}
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <strong class="text-lg text-gray-800">${poi.name || 'Sin Nombre'}</strong>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${isActive ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700'}">
                                    ${isActive ? 'ACTIVO' : 'INACTIVO'}
                                </span>
                            </div>
                            <span class="block text-sm ${isModel ? 'text-blue-600' : 'text-purple-600'}">${isModel ? 'Modelo 3D' : 'Video'}</span>
                            <div class="text-xs text-gray-500 mt-2">
                                <span>Lat: ${poi.lat?.toFixed(5)}</span> |
                                 <span>Lon: ${poi.lon?.toFixed(5)}</span> |
                                <span>Escala: ${poi.scale}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                <span>Inicio: ${poi.startDate || 'N/A'}</span> |
                                <span>Fin: ${poi.endDate || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
                summaryPoiList.appendChild(poiElement);
            });

            if (activePois === 0 && allPoisData.length > 0) { 
                 const info = document.createElement('p'); 
                 info.className = "text-center text-amber-700 font-semibold";
                 info.textContent = "Nota: Hay contenido configurado, pero parece estar fuera de las fechas activas.";
                 summaryPoiList.prepend(info);
            }
        }
        
        // --- Funciones de Flujo AR (CRÍTICO - v1.43) ---
        async function startARFlow() {
            console.log("Starting AR Flow...");
            if (!arLoadingScreen || !permissionModal || !loadingStatusText) {
                console.error("AR UI elements not found.");
                return;
            }

            arLoadingScreen.classList.add('active');
            updateARProgressBar('start');
            
            arFineScaleMultiplier = 1.0;
            if (arScaleSlider) arScaleSlider.value = arFineScaleMultiplier;
            if (arScaleValueDisplay) arScaleValueDisplay.textContent = `${arFineScaleMultiplier.toFixed(2)}x`;


            // 1. Verificar Permisos (Cámara Y GPS de Alta Precisión)
            try {
                loadingStatusText.textContent = "Verificando permisos de cámara...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                stream.getTracks().forEach(track => track.stop());
                
                // CORRECCIÓN v1.43: Pedir permiso de GPS (Alta Precisión) explícitamente
                // Esto activa el pop-up del navegador para el GPS antes de cargar la escena.
                loadingStatusText.textContent = "Verificando permisos de ubicación (Alta Precisión)...";
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => { 
                            // Guardamos esta primera posición
                            lastKnownGps = { latitude: pos.coords.latitude, longitude: pos.coords.longitude, accuracy: pos.coords.accuracy, heading: pos.coords.heading || 0 }; 
                            console.log("GPS permission granted, initial position:", pos.coords);
                            resolve(pos); // Éxito
                        },
                        (err) => { 
                            console.error("GPS permission error:", err.message, "Code:", err.code);
                            // Mapear códigos de error a mensajes amigables
                            let errorMsg = "Permiso de GPS denegado o no disponible.";
                            if (err.code === 1) errorMsg = "Permiso de GPS denegado.";
                            if (err.code === 2) errorMsg = "Señal de GPS no disponible.";
                            if (err.code === 3) errorMsg = "Señal de GPS (Alta Precisión) tardó demasiado (60s).";
                            reject(new Error(errorMsg)); 
                        },
                        { 
                            enableHighAccuracy: true, // ¡CRÍTICO! Pide la alta precisión.
                            timeout: 60000,           // Aumentado a 60s (desde 10s)
                            maximumAge: 0             // Forzar una nueva lectura
                        }
                    );
                });
                
                updateARProgressBar('permissions');

            } catch (err) {
                console.error("AR Permission Error:", err);
                arLoadingScreen.classList.remove('active');
                permissionModal.style.display = 'flex';
                let msg = err.message || "Error de permisos AR. Inténtalo de nuevo.";
                if (err.message.includes("denied")) {
                     msg = "Acceso a cámara o ubicación denegado. Habilítalos en la configuración del navegador.";
                }
                showMessage(msg, 6000);
                return;
            }

            // 2. Cargar Recursos (Assets)
            const activePois = allPoisData.filter(poi => {
                const now = new Date();
                const startDate = poi.startDate ? new Date(poi.startDate + "T00:00:00") : null;
                const endDate = poi.endDate ? new Date(poi.endDate + "T23:59:59") : null;
                let isActive = true;
                if (startDate && endDate) { isActive = now >= startDate && now <= endDate; }
                else if (startDate) { isActive = now >= startDate; }
                return isActive;
            });

            if (activePois.length === 0) {
                loadingStatusText.textContent = "No hay contenido activo para hoy.";
                setTimeout(() => arLoadingScreen.classList.remove('active'), 2000);
                showMessage("No hay contenido activo configurado para la fecha de hoy.", 5000);
                return;
            }
            
            totalARAssetsToLoad = 0;
            activePois.forEach(poi => {
                 if (poi.poiType === 'model' && poi.modelUrl) totalARAssetsToLoad++;
                 if (poi.poiType === 'video' && poi.videoUrl) totalARAssetsToLoad++;
                 if (poi.soundUrl) totalARAssetsToLoad++;
            });

            if (totalARAssetsToLoad > 0) {
                 updateARProgressBar('load_assets_start');
                 await initializeARScene(activePois); 
                 await loadARResources();
            } else {
                 loadingAssetStatus.textContent = "No hay recursos que descargar.";
                 await initializeARScene(activePois);
            }

            // 3. Configuración Final y GPS
            updateARProgressBar('scene_setup');
            // Ya no se llama a startGPSWatch(), los listeners se adjuntan en initializeARScene

            // 4. Completado
            setTimeout(() => {
                updateARProgressBar('gps_active');
                setTimeout(() => {
                    updateARProgressBar('complete');
                    setTimeout(() => arLoadingScreen.classList.remove('active'), 1000);
                }, 1500); 
            }, 1000);
        }

        // --- Manejo de la carga de recursos de A-Frame ---
        function loadARResources() {
            return new Promise((resolve) => {
                 if (totalARAssetsToLoad === 0) {
                     resolve();
                     return;
                 }
                 
                 const assetsEl = arScene.querySelector('a-assets');
                 if (!assetsEl) {
                     console.error('A-Assets element not found.');
                     resolve();
                     return;
                 }
                 
                 assetsEl.addEventListener('asset-item-loaded', (e) => {
                     const assetName = e.detail.id;
                     console.log(`Asset loaded: ${assetName}`);
                     updateARProgressBar('asset_loaded', assetName);
                     
                     if (loadedARAssetsCount === totalARAssetsToLoad) {
                          assetsEl.removeEventListener('asset-item-loaded', arguments.callee);
                          resolve();
                     }
                 });
                 
                 assetsEl.addEventListener('loaded', () => {
                     if (loadedARAssetsCount < totalARAssetsToLoad) {
                         console.warn("A-Frame reported assets loaded, but individual asset count was incomplete. Forcing completion.");
                         loadedARAssetsCount = totalARAssetsToLoad;
                         updateARProgressBar('asset_loaded', 'Carga forzada por A-Frame');
                         resolve();
                     }
                 });

            });
        }


        // --- Inicialización de Escena AR ---
        function initializeARScene(activePois) {
            const arSceneContainer = document.getElementById('ar-scene-container');
            if (!arSceneContainer) { console.error("AR container not found!"); return; }
            arSceneContainer.innerHTML = ''; 
            
            // v1.42: positionMinAccuracy: 100
            const sceneHTML = `
                <a-scene
                    id="ar-scene"
                    embedded
                    vr-mode-ui="enabled: false"
                    renderer="logarithmicDepthBuffer: true; antialias: true; precision: high; alpha: true;"
                    style="background: transparent;"
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
                    
                    <a-assets timeout="60000"></a-assets>

                    <a-camera 
                        gps-camera="minDistance: 1; maxDistance: 1000; positionMinAccuracy: 100; highAccuracyTimeout: 60000; defaultLatitude: 4.0835; defaultLongitude: -76.1915; alert: true"
                        look-controls="enabled: false"
                        rotation-reader>
                    </a-camera>

                </a-scene>
            `;
            arSceneContainer.innerHTML = sceneHTML;
            arScene = document.querySelector('#ar-scene');
            const assets = arScene.querySelector('a-assets');
            
            activePois.forEach((poi) => {
                const entityId = `entity-${poi.id}`;
                const scale = poi.scale || 1.0; 
                const groundHeight = poi.groundHeight || 0;
                
                const entity = document.createElement('a-entity');
                entity.setAttribute('id', entityId);
                entity.setAttribute('class', 'poi-entity');
                entity.setAttribute('data-poi-id', poi.id);
                entity.setAttribute('data-name', poi.name);
                entity.setAttribute('gps-entity-place', `latitude: ${poi.lat}; longitude: ${poi.lon};`);
                entity.setAttribute('position', `0 ${groundHeight} 0`);
                entity.setAttribute('scale', `${scale} ${scale} ${scale}`); 
                
                // A. Modelo 3D
                if (poi.poiType === 'model' && poi.modelUrl) {
                    const assetId = `model-${poi.id}`;
                    const modelAsset = document.createElement('a-asset-item');
                    modelAsset.setAttribute('id', assetId);
                    modelAsset.setAttribute('src', poi.modelUrl);
                    assets.appendChild(modelAsset);
                    
                    const modelEntity = document.createElement('a-gltf-model');
                    modelEntity.setAttribute('src', `#${assetId}`);
                    modelEntity.setAttribute('animation-mixer', '');
                    entity.appendChild(modelEntity);
                }
                
                // B. Video
                else if (poi.poiType === 'video' && poi.videoUrl) {
                    const videoId = `video-${poi.id}`;
                    const videoAsset = document.createElement('video');
                    videoAsset.setAttribute('id', videoId);
                    videoAsset.setAttribute('src', poi.videoUrl);
                    videoAsset.setAttribute('crossorigin', 'anonymous');
                    videoAsset.setAttribute('preload', 'auto');
                    videoAsset.setAttribute('loop', 'true');
                    videoAsset.setAttribute('autoplay', 'true');
                    videoAsset.setAttribute('playsinline', 'true');
                    videoAsset.setAttribute('webkit-playsinline', 'true');
                    videoAsset.setAttribute('muted', 'true');
                    assets.appendChild(videoAsset);
                    
                    const videoWidth = 2;
                    const videoHeight = (9 / 16) * videoWidth;
                    
                    const videoEntity = document.createElement('a-video');
                    videoEntity.setAttribute('src', `#${videoId}`);
                    videoEntity.setAttribute('width', videoWidth.toFixed(2));
                    videoEntity.setAttribute('height', videoHeight.toFixed(2));
                    videoEntity.setAttribute('position', `0 ${(videoHeight / 2).toFixed(2)} 0`);
                    
                    videoEntity.addEventListener('click', () => {
                        if (videoAsset.muted) {
                            videoAsset.muted = false;
                            videoAsset.play();
                            showMessage(`Sonido activado para: ${poi.name}`, 2000);
                        } else {
                            videoAsset.muted = true;
                            showMessage(`Sonido desactivado para: ${poi.name}`, 2000);
                        }
                    });
                    
                    entity.appendChild(videoEntity);
                }
                
                // C. Sonido de Fondo
                if (poi.soundUrl) {
                    const soundId = `sound-${poi.id}`;
                    const soundAsset = document.createElement('audio');
                    soundAsset.setAttribute('id', soundId);
                    soundAsset.setAttribute('src', poi.soundUrl);
                    soundAsset.setAttribute('crossorigin', 'anonymous');
                    soundAsset.setAttribute('preload', 'auto');
                    soundAsset.setAttribute('loop', 'true');
                    assets.appendChild(soundAsset);
                    
                    entity.setAttribute('sound', `src: #${soundId}; autoplay: true; volume: 0.5`);
                }
                
                arScene.appendChild(entity);
            });

            // 3. Añadir luces
            const ambientLight = document.createElement('a-light');
            ambientLight.setAttribute('type', 'ambient');
            ambientLight.setAttribute('color', '#BBB');
            arScene.appendChild(ambientLight);

            const directionalLight = document.createElement('a-light');
            directionalLight.setAttribute('type', 'directional');
            directionalLight.setAttribute('color', '#FFF');
            directionalLight.setAttribute('position', '5 10 7.5');
            arScene.appendChild(directionalLight);
            
            // 4. Adjuntar listeners de GPS (CRÍTICO)
            const camera = arScene.querySelector('a-camera'); 
            if (camera) {
                console.log("Adjuntando listeners de eventos GPS a la cámara de A-Frame...");
                camera.addEventListener('gps-camera-update-position', onGPSUpdate);
                camera.addEventListener('gps-camera-error', onGPSError);
            } else {
                console.error("No se pudo encontrar la cámara de A-Frame para adjuntar listeners.");
            }
            
            console.log("Estructura de escena AR creada con POIs y listeners.");
        }
        
        function applyFineScaleAdjustment() {
            arFineScaleMultiplier = parseFloat(arScaleSlider.value);
            arScaleValueDisplay.textContent = `${arFineScaleMultiplier.toFixed(2)}x`;
            
            const poiEntities = arScene.querySelectorAll('.poi-entity');
            
            poiEntities.forEach(entity => {
                const baseScale = parseFloat(poiDataMap.get(entity.dataset.poiId)?.scale || 1.0);
                const finalScale = baseScale * arFineScaleMultiplier;
                entity.setAttribute('scale', `${finalScale} ${finalScale} ${finalScale}`);
            });
        }

        // --- Detener AR ---
        function stopAR() {
            if (arScene) {
                try {
                    const camera = arScene.querySelector('a-camera');
                    if (camera) {
                         console.log("Quitando listeners de eventos GPS de la cámara de A-Frame...");
                        camera.removeEventListener('gps-camera-update-position', onGPSUpdate);
                        camera.removeEventListener('gps-camera-error', onGPSError);
                    }
                    
                    arScene.pause();
                    
                    arScene.querySelectorAll('video, audio').forEach(media => {
                        media.pause();
                        media.src = '';
                        media.load();
                    });

                    const arVideo = document.querySelector('.arjs-video');
                    if (arVideo) {
                        arVideo.pause();
                        arVideo.srcObject = null;
                        arVideo.remove();
                        console.log("Elemento de video AR.js eliminado.");
                    }
                } catch (e) { 
                     console.warn("Error durante la limpieza de la escena AR:", e);
                } 
                                
                const arContainer = document.getElementById('ar-scene-container');
                if (arContainer) arContainer.innerHTML = '';
                                
                arScene = null;
                console.log("Escena AR eliminada del DOM.");
            }
            if (arLoadingScreen) arLoadingScreen.classList.remove('active');
            const gpsStatusEl = document.getElementById('gps-status');
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsStatusEl) gpsStatusEl.textContent = "Buscando...";
            if (gpsAccuracyEl) gpsAccuracyEl.textContent = "--";
            
            if (arGuide) arGuide.style.display = 'none';
            if (arScaleSlider) arScaleSlider.value = 1.0;
        }

        // --- GPS/AR Feedback ---
        function updateARGuide() {
            let closestPoi = null;
            let minDistance = Infinity;

            const now = new Date();
            const activePois = allPoisData.filter(poi => {
                const startDate = poi.startDate ? new Date(poi.startDate + "T00:00:00") : null;
                const endDate = poi.endDate ? new Date(poi.endDate + "T23:59:59") : null;
                let isActive = true;
                if (startDate && endDate) { isActive = now >= startDate && now <= endDate; }
                else if (startDate) { isActive = now >= startDate; }
                return isActive;
            });

            activePois.forEach(poi => {
                const distance = calculateDistance(lastKnownGps.latitude, lastKnownGps.longitude, poi.lat, poi.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPoi = poi;
                }
            });

            if (closestPoi && lastKnownGps.accuracy < 150) {
                const targetBearing = calculateBearing(lastKnownGps.latitude, lastKnownGps.longitude, closestPoi.lat, closestPoi.lon);
                const heading = lastKnownGps.heading || 0;
                const bearingDiff = (targetBearing - heading + 360) % 360;
                let normalizedDiff = bearingDiff > 180 ? bearingDiff - 360 : bearingDiff;
                
                guideName.textContent = closestPoi.name;
                guideDistance.textContent = `${minDistance.toFixed(1)}m`;
                guideBearing.textContent = getDirectionArrow(normalizedDiff);
                arGuide.style.display = 'block';

            } else {
                 arGuide.style.display = 'none';
            }
        }
        
        function onGPSUpdate(event) {
             const pos = event.detail.position;
            const accuracy = pos.coords.accuracy.toFixed(2);
            
            lastKnownGps = { 
                latitude: pos.coords.latitude, 
                longitude: pos.coords.longitude, 
                accuracy: pos.coords.accuracy, 
                heading: pos.coords.heading || lastKnownGps.heading 
            };
            
            const gpsStatusEl = document.getElementById('gps-status');
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            
            if (gpsStatusEl) gpsStatusEl.textContent = "OK";
            if (gpsAccuracyEl) { 
                 gpsAccuracyEl.textContent = `${accuracy}`;
                 if (pos.coords.accuracy > 50) {
                     gpsAccuracyEl.style.color = 'red';
                 } else if (pos.coords.accuracy > 25) {
                     gpsAccuracyEl.style.color = 'orange';
                 } else {
                     gpsAccuracyEl.style.color = 'lime';
                 }
            }
            
            updateARGuide();
        }
        
        function onGPSError(event) {
             console.error("GPS Error (from A-Frame):", event.detail);
            const gpsStatusEl = document.getElementById('gps-status');
            if (gpsStatusEl) gpsStatusEl.textContent = "Error";
            const gpsAccuracyEl = document.getElementById('gps-accuracy');
            if (gpsAccuracyEl) { 
                 gpsAccuracyEl.textContent = "N/A";
                 gpsAccuracyEl.style.color = 'red';
            }
            let errorMsg = "Error de GPS.";
            if (event.detail.code === 1) errorMsg = "Permiso de GPS denegado.";
            else if (event.detail.code === 2) errorMsg = "Señal de GPS perdida.";
            else if (event.detail.code === 3) errorMsg = "GPS tardó demasiado en responder.";
            showMessage(errorMsg, 4000);
        }

        // --- Configuración de Listeners de Navegación ---
        function setupNavigationListeners() {
            document.getElementById('goto-map-btn')?.addEventListener('click', () => navigateTo('map'));
            document.getElementById('back-to-admin-btn')?.addEventListener('click', () => navigateTo('admin'));
            document.getElementById('goto-summary-btn')?.addEventListener('click', () => navigateTo('summary'));
            document.getElementById('back-to-map-btn')?.addEventListener('click', () => navigateTo('map'));
            document.getElementById('launch-ar-btn')?.addEventListener('click', () => navigateTo('ar'));
            document.getElementById('back-to-summary-btn')?.addEventListener('click', () => navigateTo('summary'));
            document.getElementById('grant-permissions-btn')?.addEventListener('click', () => {
                if (permissionModal) permissionModal.style.display = 'none';
                startARFlow();
            });
        }

        // --- Inicialización de la App (DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");
            
            // Asignar referencias a elementos DOM
            pages = {
                login: document.getElementById('login-page'),
                admin: document.getElementById('admin-page'),
                map: document.getElementById('map-page'),
                summary: document.getElementById('summary-page'),
                ar: document.getElementById('ar-page')
            };

            messageBox = document.getElementById('message-box');
            permissionModal = document.getElementById('permission-modal');
            arLoadingScreen = document.getElementById('ar-loading-screen');
            loadingStatusText = document.getElementById('loading-status-text');
            progressBar = document.getElementById('progress-bar');
            progressBarContainer = document.getElementById('progress-bar-container');
            loadingAssetStatus = document.getElementById('loading-asset-status');
            versionDisplay = document.getElementById('version-display');
            
            arGuide = document.getElementById('ar-guide');
            guideName = document.getElementById('guide-name');
            guideDistance = document.getElementById('guide-distance');
            guideBearing = document.getElementById('guide-bearing');
            arScaleSlider = document.getElementById('ar-scale-slider');
            arScaleValueDisplay = document.getElementById('ar-scale-value-display');
            
            listContainer = document.getElementById('poi-list-container');
            loadingPois = document.getElementById('loading-pois');
            ecopiensaSelectionList = document.getElementById('ecopiensa-selection-list');
            loadingModelsPlaceholder = document.getElementById('loading-models-placeholder');
            selectVideoCheckbox = document.getElementById('select-video-cb');

            gotoMapButton = document.getElementById('goto-map-btn');
            googleLoginBtn = document.getElementById('google-login-btn'); 
            logoutBtn = document.getElementById('logout-btn');
            userInfo = document.getElementById('user-info');
            userEmail = document.getElementById('user-email');
            togglePoisBtn = document.getElementById('toggle-pois-btn');

            placementPanel = document.getElementById('placement-panel');
            modelsToPlaceList = document.getElementById('models-to-place-list');
            placementFormContainer = document.getElementById('placement-form-container');
            placingModelName = document.getElementById('placing-model-name');
            cancelPlacementBtn = document.getElementById('cancel-placement-btn');
            savePlacementBtn = document.getElementById('save-placement-btn');
            backToSelectionBtn = document.getElementById('back-to-selection-btn');
            clearSelectionBtn = document.getElementById('clear-selection-btn');
            
            mapZoomSlider = document.getElementById('map-zoom-slider');
            jumptoBtn = document.getElementById('jumpto-btn');
            placePoiTypeSelect = document.getElementById('place-poi-type');
            modelFieldsDiv = document.getElementById('model-fields');
            videoFieldsDiv = document.getElementById('video-fields');
            placeModelUrlInput = document.getElementById('place-model-url');
            placeVideoUrlInput = document.getElementById('place-video-url');
            placeNameInput = document.getElementById('place-name');
            
            placedPoisPanel = document.getElementById('placed-pois-panel');
            placedPoisList = document.getElementById('placed-pois-list');
            editLocationPanel = document.getElementById('edit-location-panel');
            editingPoiNameEl = document.getElementById('editing-poi-name');
            saveEditLocationBtn = document.getElementById('save-edit-location-btn');
            cancelEditLocationBtn = document.getElementById('cancel-edit-location-btn');
            
            summaryPoiList = document.getElementById('summary-poi-list');
            loadingSummaryPois = document.getElementById('loading-summary-pois');
            mapCenterCoordsEl = document.getElementById('map-center-coords');
            placementPreviewImageEl = document.getElementById('placement-preview-image');
            
            loadSelectionFromLocalStorage();
            displayAppVersion();
            initializeModelSelection();
            setupNavigationListeners();

            if (googleLoginBtn) { googleLoginBtn.addEventListener('click', handleGoogleLogin); }
            if (logoutBtn) { logoutBtn.addEventListener('click', handleLogout); }

            if (cancelPlacementBtn) cancelPlacementBtn.addEventListener('click', () => navigateTo('admin'));
            if (backToSelectionBtn) backToSelectionBtn.addEventListener('click', cancelPlacement);
            if (savePlacementBtn) savePlacementBtn.addEventListener('click', handleSavePlacement);
            if (saveEditLocationBtn) saveEditLocationBtn.addEventListener('click', handleSaveEditLocation);
            if (cancelEditLocationBtn) cancelEditLocationBtn.addEventListener('click', cancelEditLocation);
            if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', clearSavedSelection);
            
            if (arScaleSlider) arScaleSlider.addEventListener('input', applyFineScaleAdjustment);

            if (listContainer) { // Listener para eliminar en página Admin
                listContainer.addEventListener('click', async (e) => {
                    if (e.target && e.target.classList.contains('delete-btn')) {
                        const docId = e.target.getAttribute('data-id');
                        const button = e.target;
                        if (button.disabled) return;

                        if (button.textContent.includes('Eliminar')) {
                            button.textContent = '¿Seguro? Clic otra vez';
                            button.classList.remove('bg-red-500', 'hover:bg-red-600');
                            button.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                            setTimeout(() => {
                                const currentButton = listContainer?.querySelector(`.delete-btn[data-id="${docId}"]`);
                                if (currentButton && currentButton.textContent.includes('Clic otra vez')) {
                                    currentButton.textContent = 'Eliminar';
                                    currentButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                    currentButton.classList.add('bg-red-500', 'hover:bg-red-600');
                                }
                            }, 3000);
                            return;
                        }

                        if (!firebaseReady || !poiCollectionRef) {
                            showMessage("Error: La base de datos no está lista para eliminar.", 4000);
                            button.textContent = 'Eliminar';
                            button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                            button.classList.add('bg-red-500', 'hover:bg-red-600');
                            return;
                        }
                        try {
                            button.disabled = true;
                            button.textContent = 'Eliminando...';
                            const docRef = doc(db, poiCollectionRef.path, docId);
                            await deleteDoc(docRef);
                            showMessage('Punto de interés eliminado.', 3000);
                        } catch (error) {
                            console.error("Error al eliminar documento: ", error);
                            showMessage("No se pudo eliminar el documento.", 5000);
                             const currentButton = listContainer?.querySelector(`.delete-btn[data-id="${docId}"]`);
                             if (currentButton) {
                                 currentButton.disabled = false;
                                 currentButton.textContent = 'Eliminar';
                                 currentButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                 currentButton.classList.add('bg-red-500', 'hover:bg-red-600');
                            }
                        }
                    }
                });
            }

            // Iniciar Firebase
            initializeFirebase();
        });
    </script>
</body>
</html>

